<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Management System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="index.css">
    
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div id="app" class="container">
        <!-- Content will be loaded here by JavaScript -->
    </div>

    <div id="messageBox" class="message-box"></div>

    <script>
        // Base URL for your FastAPI backend
        const API_BASE_URL = 'http://127.0.0.1:8000'; // Make sure this matches your FastAPI server address

        // Global state variables
        let currentUser = null;
        let currentRole = null;
        let allStudents = [];

        // Utility function to show messages to the user
        function showMessage(message, type = 'success') {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.className = `message-box show ${type}`;
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }

        // --- API Call Functions ---

        async function apiCall(endpoint, method = 'GET', data = null, isFile = false) {
            const url = `${API_BASE_URL}${endpoint}`;
            const options = {
                method: method,
                headers: {},
            };

            if (data) {
                if (isFile) {
                    // For file uploads, data is a FormData object, no Content-Type header needed
                    options.body = data;
                } else {
                    options.headers['Content-Type'] = 'application/json';
                    options.body = JSON.stringify(data);
                }
            }

            try {
                const response = await fetch(url, options);
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.detail || 'Something went wrong');
                }
                return result;
            } catch (error) {
                console.error('API Call Error:', error);
                showMessage(error.message || 'Network error', 'error');
                throw error;
            }
        }

        // --- Authentication Functions ---

        async function signupUser(username, password, role) {
            try {
                const data = await apiCall('/signup', 'POST', { username, password, role });
                showMessage(data.message);
                return true;
            } catch (error) {
                return false;
            }
        }

        async function loginUser(username, password) {
            try {
                const data = await apiCall('/login', 'POST', { username, password });
                showMessage(data.message);
                currentUser = data.username;
                currentRole = data.role;
                return true;
            } catch (error) {
                return false;
            }
        }

        function logoutUser() {
            currentUser = null;
            currentRole = null;
            renderLoginPage();
            showMessage('Logged out successfully.');
        }

        // --- Student Data Functions ---

        async function fetchAllStudents() {
            try {
                allStudents = await apiCall('/students');
                return allStudents;
            } catch (error) {
                allStudents = []; // Clear students on error
                return [];
            }
        }

        async function fetchStudentById(indexNumber) {
            try {
                return await apiCall(`/students/${indexNumber}`);
            } catch (error) {
                return null;
            }
        }

        async function addStudent(studentData) {
            try {
                const data = await apiCall('/students', 'POST', studentData);
                showMessage(data.message);
                return true;
            } catch (error) {
                return false;
            }
        }

        async function updateStudentScore(indexNumber, score) {
            try {
                const data = await apiCall(`/students/${indexNumber}`, 'PUT', { score });
                showMessage(data.message);
                return true;
            } catch (error) {
                return false;
            }
        }

        async function uploadStudentFile(file) {
            try {
                const formData = new FormData();
                formData.append('file', file);
                const data = await apiCall('/students/upload', 'POST', formData, true);
                showMessage(data.message);
                return true;
            } catch (error) {
                return false;
            }
        }

        // --- Rendering Functions ---

        function renderLoginPage() {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen-minus-padding">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Welcome</h2>
                    <div class="w-full max-w-md">
                        <div class="bg-white p-8 rounded-2xl shadow-xl mb-8">
                            <h3 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Login</h3>
                            <form id="loginForm" class="space-y-4">
                                <div>
                                    <label for="loginUsername" class="block text-sm font-medium text-gray-700 mb-1">Username (Index Number for Students)</label>
                                    <input type="text" id="loginUsername" class="form-input" placeholder="Enter username" required>
                                </div>
                                <div>
                                    <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                    <input type="password" id="loginPassword" class="form-input" placeholder="Enter password" required>
                                </div>
                                <button type="submit" class="btn-primary w-full">Login</button>
                            </form>
                        </div>

                        <div class="bg-white p-8 rounded-2xl shadow-xl">
                            <h3 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Sign Up</h3>
                            <form id="signupForm" class="space-y-4">
                                <div>
                                    <label for="signupUsername" class="block text-sm font-medium text-gray-700 mb-1">Username (Index Number for Students)</label>
                                    <input type="text" id="signupUsername" class="form-input" placeholder="Choose a username" required>
                                </div>
                                <div>
                                    <label for="signupPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                    <input type="password" id="signupPassword" class="form-input" placeholder="Choose a password" required>
                                </div>
                                <div>
                                    <label for="signupRole" class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                                    <select id="signupRole" class="form-input" required>
                                        <option value="student">Student</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn-primary w-full">Sign Up</button>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            // Add event listeners for login and signup forms
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
                if (await loginUser(username, password)) {
                    renderDashboard();
                }
            });

            document.getElementById('signupForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('signupUsername').value;
                const password = document.getElementById('signupPassword').value;
                const role = document.getElementById('signupRole').value;
                await signupUser(username, password, role);
            });
        }

        async function renderDashboard() {
            if (!currentUser || !currentRole) {
                renderLoginPage(); // Redirect if not logged in
                return;
            }

            const appDiv = document.getElementById('app');
            appDiv.innerHTML = `
                <div class="w-full">
                    <header class="flex justify-between items-center py-4 px-6 bg-blue-600 text-white rounded-t-2xl shadow-md">
                        <h1 class="text-2xl font-bold">Welcome, ${currentUser} (${currentRole})</h1>
                        <button id="logoutBtn" class="btn-secondary text-blue-800 bg-white hover:bg-gray-100">Logout</button>
                    </header>
                    <main class="p-6 bg-white rounded-b-2xl shadow-xl">
                        ${currentRole === 'admin' ? await renderAdminDashboardContent() : await renderStudentDashboardContent()}
                    </main>
                </div>
            `;

            document.getElementById('logoutBtn').addEventListener('click', logoutUser);
        }

        async function renderAdminDashboardContent() {
            await fetchAllStudents(); // Fetch students for the admin view

            return `
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Admin Dashboard</h2>

                <!-- Add Student Section -->
                <div class="mb-8 p-6 border border-gray-200 rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Add New Student</h3>
                    <form id="addStudentForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="addIndexNumber" class="block text-sm font-medium text-gray-700 mb-1">Index Number</label>
                            <input type="text" id="addIndexNumber" class="form-input" required>
                        </div>
                        <div>
                            <label for="addFullName" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                            <input type="text" id="addFullName" class="form-input" required>
                        </div>
                        <div>
                            <label for="addCourse" class="block text-sm font-medium text-gray-700 mb-1">Course</label>
                            <input type="text" id="addCourse" class="form-input" required>
                        </div>
                        <div>
                            <label for="addScore" class="block text-sm font-medium text-gray-700 mb-1">Score</label>
                            <input type="number" id="addScore" class="form-input" min="0" max="100" required>
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="btn-primary w-full">Add Student</button>
                        </div>
                    </form>
                </div>

                <!-- Update Student Score Section -->
                <div class="mb-8 p-6 border border-gray-200 rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Update Student Score</h3>
                    <form id="updateScoreForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="updateIndexNumber" class="block text-sm font-medium text-gray-700 mb-1">Index Number</label>
                            <input type="text" id="updateIndexNumber" class="form-input" required>
                        </div>
                        <div>
                            <label for="updateScore" class="block text-sm font-medium text-gray-700 mb-1">New Score</label>
                            <input type="number" id="updateScore" class="form-input" min="0" max="100" required>
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="btn-primary w-full">Update Score</button>
                        </div>
                    </form>
                </div>

                <!-- Upload Student File Section -->
                <div class="mb-8 p-6 border border-gray-200 rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">Upload Student Data File (.txt or .csv)</h3>
                    <form id="uploadFileForm" class="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4">
                        <input type="file" id="studentFile" accept=".txt,.csv" class="form-input flex-grow" required>
                        <button type="submit" class="btn-primary flex-shrink-0 w-full md:w-auto">Upload File</button>
                    </form>
                </div>

                <!-- All Students Table Section -->
                <div class="mb-8">
                    <h3 class="text-xl font-medium text-gray-700 mb-4">All Students</h3>
                    <div class="table-container">
                        <table class="student-table">
                            <thead>
                                <tr>
                                    <th>Index Number</th>
                                    <th>Full Name</th>
                                    <th>Course</th>
                                    <th>Score</th>
                                    <th>Grade</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody">
                                <!-- Student rows will be inserted here by JavaScript -->
                                ${allStudents.map(student => `
                                    <tr>
                                        <td>${student.index_number}</td>
                                        <td>${student.full_name}</td>
                                        <td>${student.course}</td>
                                        <td>${student.score}</td>
                                        <td>${student.grade}</td>
                                    </tr>
                                `).join('')}
                                ${allStudents.length === 0 ? `<tr><td colspan="5" class="text-center py-4">No students found.</td></tr>` : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        async function renderStudentDashboardContent() {
            const studentData = await fetchStudentById(currentUser); // currentUser is the index_number for students
            if (!studentData) {
                return `<p class="text-center text-red-600 text-lg">Could not load your student data. Please contact an admin.</p>`;
            }

            return `
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Student Dashboard</h2>
                <div class="bg-blue-50 p-6 rounded-lg shadow-md space-y-4">
                    <p class="text-lg"><span class="font-medium text-gray-700">Index Number:</span> ${studentData.index_number}</p>
                    <p class="text-lg"><span class="font-medium text-gray-700">Full Name:</span> ${studentData.full_name}</p>
                    <p class="text-lg"><span class="font-medium text-gray-700">Course:</span> ${studentData.course}</p>
                    <p class="text-lg"><span class="font-medium text-gray-700">Score:</span> ${studentData.score}</p>
                    <p class="text-lg"><span class="font-medium text-gray-700">Grade:</span> ${studentData.grade}</p>
                </div>
            `;
        }

        // --- Event Listeners and Initial Load ---

        document.addEventListener('DOMContentLoaded', () => {
            renderLoginPage(); // Start with the login page
        });

        // Delegate event listeners for forms that will be dynamically added
        document.getElementById('app').addEventListener('submit', async (e) => {
            if (e.target.id === 'addStudentForm') {
                e.preventDefault();
                const index_number = document.getElementById('addIndexNumber').value;
                const full_name = document.getElementById('addFullName').value;
                const course = document.getElementById('addCourse').value;
                const score = parseInt(document.getElementById('addScore').value);

                if (await addStudent({ index_number, full_name, course, score })) {
                    // Re-render admin dashboard to show updated list
                    renderDashboard();
                }
            } else if (e.target.id === 'updateScoreForm') {
                e.preventDefault();
                const index_number = document.getElementById('updateIndexNumber').value;
                const score = parseInt(document.getElementById('updateScore').value);

                if (await updateStudentScore(index_number, score)) {
                    // Re-render admin dashboard to show updated list
                    renderDashboard();
                }
            } else if (e.target.id === 'uploadFileForm') {
                e.preventDefault();
                const fileInput = document.getElementById('studentFile');
                if (fileInput.files.length > 0) {
                    if (await uploadStudentFile(fileInput.files[0])) {
                        // Re-render admin dashboard to show updated list
                        renderDashboard();
                    }
                } else {
                    showMessage('Please select a file to upload.', 'error');
                }
            }
        });
    </script>
</body>
</html>
