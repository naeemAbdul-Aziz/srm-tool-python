<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Result Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background-color: #f9fafb; /* Light gray background */
        }
        *, *::before, *::after {
            box-sizing: inherit;
        }
        /* Custom styles for modals to ensure they are on top */
        .modal-overlay {
            z-index: 999;
        }
        .modal-content {
            z-index: 1000;
        }
        
        /* Toast notification styles */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            min-width: 300px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 9999;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            background-color: #059669;
        }
        
        .toast.error {
            background-color: #dc2626;
        }
        
        .toast.info {
            background-color: #2563eb;
        }
        
        .toast.warning {
            background-color: #d97706;
        }
        
        /* Loading spinner */
        .loading-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9998;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 8px;
            display: none;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus styles for better accessibility */
        .focus-visible:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        /* Enhanced hover and focus states */
        .student-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .student-card:focus-within {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        /* Loading states */
        .pagination-loading {
            pointer-events: none;
            opacity: 0.7;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .border-gray-300 {
                border-color: #000;
            }
            .text-gray-600 {
                color: #000;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            .animate-pulse, .animate-spin, .transition-colors, .transition-shadow {
                animation: none;
                transition: none;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div id="app" class="flex-grow">
        </div>

    <div id="modal-overlay" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 modal-overlay hidden">
        <div id="modal-content" class="bg-white p-6 sm:p-8 rounded-lg shadow-lg max-w-lg w-full mx-auto modal-content">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800"></h3>
                <button id="modal-close-btn" class="text-gray-500 hover:text-gray-700 text-2xl font-bold leading-none">&times;</button>
            </div>
            <div id="modal-body">
                </div>
        </div>
    </div>

    <div id="confirmation-modal-overlay" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 modal-overlay hidden">
        <div id="confirmation-modal-content" class="bg-white p-6 sm:p-8 rounded-lg shadow-lg max-w-lg w-full mx-auto modal-content">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 id="confirmation-modal-title" class="text-xl font-bold text-gray-800"></h3>
                <button id="confirmation-modal-close-btn" class="text-gray-500 hover:text-gray-700 text-2xl font-bold leading-none">&times;</button>
            </div>
            <div id="confirmation-modal-body" class="text-gray-700 mb-6">
                </div>
            <div class="flex justify-end space-x-2">
                <button id="confirmation-modal-cancel-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 font-semibold">
                    Cancel
                </button>
                <button id="confirmation-modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 font-semibold">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="loading-spinner">
        <div class="spinner"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000'; // Ensure this matches your FastAPI backend URL
        const appDiv = document.getElementById('app');

        // --- Toast Notification System ---
        const showToast = (message, type = 'info', duration = 4000) => {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; font-size: 18px; margin-left: 10px; cursor: pointer;">&times;</button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto remove
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        };

        // --- Loading Spinner ---
        const showLoading = () => {
            document.getElementById('loading-spinner').style.display = 'block';
        };

        const hideLoading = () => {
            document.getElementById('loading-spinner').style.display = 'none';
        };

        // --- Auth State Management ---
        let currentUser = null; // Stores user data after successful login

        const setAuthUser = (user) => {
            currentUser = user;
            if (user) {
                sessionStorage.setItem('srmsUser', JSON.stringify(user));
            } else {
                sessionStorage.removeItem('srmsUser');
                sessionStorage.removeItem('srmsAuth'); // Clear credentials on logout
            }
            renderApp(); // Re-render the app based on new auth state
        };

        const getAuthHeader = () => {
            const storedAuth = sessionStorage.getItem('srmsAuth');
            if (storedAuth) {
                const { username, password } = JSON.parse(storedAuth);
                return 'Basic ' + btoa(`${username}:${password}`);
            }
            return '';
        };

        // --- Virtual Scrolling Component for Large Datasets ---
        class VirtualScrollManager {
            constructor(container, itemHeight = 120, bufferSize = 5) {
                this.container = container;
                this.itemHeight = itemHeight;
                this.bufferSize = bufferSize;
                this.totalItems = 0;
                this.visibleItems = [];
                this.startIndex = 0;
                this.endIndex = 0;
                this.containerHeight = 0;
                this.scrollTop = 0;
                
                this.setupContainer();
                this.attachScrollListener();
            }

            setupContainer() {
                this.container.style.position = 'relative';
                this.container.style.overflow = 'auto';
                this.container.style.height = '600px'; // Default height
                
                this.viewport = document.createElement('div');
                this.viewport.style.position = 'relative';
                this.container.appendChild(this.viewport);
                
                this.updateContainerHeight();
            }

            updateContainerHeight() {
                this.containerHeight = this.container.clientHeight;
                this.visibleCount = Math.ceil(this.containerHeight / this.itemHeight) + (this.bufferSize * 2);
            }

            attachScrollListener() {
                this.container.addEventListener('scroll', () => {
                    this.scrollTop = this.container.scrollTop;
                    this.updateVisibleRange();
                });

                // Handle resize
                window.addEventListener('resize', () => {
                    this.updateContainerHeight();
                    this.updateVisibleRange();
                });
            }

            setData(items) {
                this.totalItems = items.length;
                this.allItems = items;
                this.viewport.style.height = `${this.totalItems * this.itemHeight}px`;
                this.updateVisibleRange();
            }

            updateVisibleRange() {
                const newStartIndex = Math.max(0, Math.floor(this.scrollTop / this.itemHeight) - this.bufferSize);
                const newEndIndex = Math.min(this.totalItems - 1, newStartIndex + this.visibleCount - 1);

                if (newStartIndex !== this.startIndex || newEndIndex !== this.endIndex) {
                    this.startIndex = newStartIndex;
                    this.endIndex = newEndIndex;
                    this.renderVisibleItems();
                }
            }

            renderVisibleItems() {
                if (!this.allItems) return;

                this.visibleItems = this.allItems.slice(this.startIndex, this.endIndex + 1);
                
                // Clear existing content
                while (this.viewport.firstChild) {
                    this.viewport.removeChild(this.viewport.firstChild);
                }

                // Create spacer for items above viewport
                if (this.startIndex > 0) {
                    const topSpacer = document.createElement('div');
                    topSpacer.style.height = `${this.startIndex * this.itemHeight}px`;
                    this.viewport.appendChild(topSpacer);
                }

                // Render visible items
                const itemsContainer = document.createElement('div');
                this.visibleItems.forEach((item, index) => {
                    const actualIndex = this.startIndex + index;
                    const itemElement = this.renderItem(item, actualIndex);
                    itemsContainer.appendChild(itemElement);
                });
                this.viewport.appendChild(itemsContainer);

                // Create spacer for items below viewport
                const remainingItems = this.totalItems - this.endIndex - 1;
                if (remainingItems > 0) {
                    const bottomSpacer = document.createElement('div');
                    bottomSpacer.style.height = `${remainingItems * this.itemHeight}px`;
                    this.viewport.appendChild(bottomSpacer);
                }
            }

            renderItem(item, index) {
                // This should be overridden by the implementing class
                const div = document.createElement('div');
                div.style.height = `${this.itemHeight}px`;
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.textContent = `Item ${index}: ${JSON.stringify(item)}`;
                return div;
            }

            scrollToIndex(index) {
                const scrollTop = Math.max(0, (index - this.bufferSize) * this.itemHeight);
                this.container.scrollTop = scrollTop;
            }

            destroy() {
                this.container.removeEventListener('scroll', this.updateVisibleRange);
                window.removeEventListener('resize', this.updateContainerHeight);
            }
        }

        // --- Enhanced Student Virtual Scroll Implementation ---
        class StudentVirtualScroll extends VirtualScrollManager {
            constructor(container, onEdit, onDelete) {
                super(container, 140, 3); // 140px height per student card
                this.onEdit = onEdit;
                this.onDelete = onDelete;
            }

            renderItem(student, index) {
                const div = document.createElement('div');
                div.className = 'student-card bg-white border border-gray-200 rounded-lg p-4 mb-2';
                div.style.height = `${this.itemHeight - 8}px`; // Account for margin
                div.dataset.studentName = student.full_name;
                div.dataset.studentIndex = student.index_number;

                const initials = student.full_name 
                    ? student.full_name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase()
                    : student.index_number.substring(0, 2).toUpperCase();

                div.innerHTML = `
                    <div class="flex justify-between items-start h-full">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0 w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-medium text-sm">
                                    ${initials}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h4 class="student-name text-lg font-medium text-gray-900 truncate">${student.full_name}</h4>
                                    <p class="text-sm text-gray-600 truncate">${student.index_number}</p>
                                </div>
                            </div>
                            <div class="mt-2 grid grid-cols-2 gap-2 text-sm text-gray-600">
                                <p class="student-email truncate">${student.contact_email || 'No email'}</p>
                                <p class="student-course truncate">Course: ${student.program || 'N/A'}</p>
                                <p class="student-semester">Year: ${student.year_of_study || 'N/A'}</p>
                                <div class="flex space-x-1">
                                    <button data-action="edit" data-index="${student.index_number}" 
                                            class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors">
                                        Edit
                                    </button>
                                    <button data-action="delete" data-index="${student.index_number}" 
                                            class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition-colors">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Add click handlers
                div.addEventListener('click', (e) => {
                    const target = e.target;
                    if (target.tagName === 'BUTTON' && target.dataset.action) {
                        const indexNumber = target.dataset.index;
                        if (target.dataset.action === 'edit') {
                            this.onEdit(student, indexNumber);
                        } else if (target.dataset.action === 'delete') {
                            this.onDelete(student, indexNumber);
                        }
                    }
                });

                return div;
            }
        }

        // --- Infinite Scroll Pagination (Alternative to traditional pagination) ---
        class InfiniteScrollManager {
            constructor(container, paginationManager, renderCallback) {
                this.container = container;
                this.paginationManager = paginationManager;
                this.renderCallback = renderCallback;
                this.loading = false;
                this.allData = [];
                this.observer = null;
                
                this.setupIntersectionObserver();
            }

            setupIntersectionObserver() {
                const options = {
                    root: this.container,
                    rootMargin: '50px',
                    threshold: 0.1
                };

                this.observer = new IntersectionObserver(async (entries) => {
                    const entry = entries[0];
                    if (entry.isIntersecting && !this.loading && this.paginationManager.hasNextPage) {
                        await this.loadNextPage();
                    }
                }, options);
            }

            async loadNextPage() {
                if (this.loading) return;
                
                this.loading = true;
                this.showLoadingIndicator();
                
                try {
                    const data = await this.paginationManager.nextPage();
                    if (data && data.records) {
                        this.allData.push(...data.records);
                        this.renderCallback(this.allData, false); // false = don't replace, append
                        this.updateLoadingTrigger();
                    }
                } catch (error) {
                    showToast('Failed to load more data: ' + error.message, 'error');
                } finally {
                    this.loading = false;
                    this.hideLoadingIndicator();
                }
            }

            async reset() {
                this.allData = [];
                this.paginationManager.currentPage = 1;
                
                try {
                    const data = await this.paginationManager.goToPage(1);
                    if (data && data.records) {
                        this.allData = [...data.records];
                        this.renderCallback(this.allData, true); // true = replace existing
                        this.updateLoadingTrigger();
                    }
                } catch (error) {
                    showToast('Failed to load data: ' + error.message, 'error');
                }
            }

            updateLoadingTrigger() {
                // Remove existing trigger
                const existingTrigger = this.container.querySelector('.infinite-scroll-trigger');
                if (existingTrigger) {
                    this.observer.unobserve(existingTrigger);
                    existingTrigger.remove();
                }

                // Add new trigger if more pages available
                if (this.paginationManager.hasNextPage) {
                    const trigger = document.createElement('div');
                    trigger.className = 'infinite-scroll-trigger h-10 flex items-center justify-center';
                    trigger.innerHTML = '<div class="text-gray-500 text-sm">Loading more...</div>';
                    this.container.appendChild(trigger);
                    this.observer.observe(trigger);
                }
            }

            showLoadingIndicator() {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'infinite-scroll-loading flex items-center justify-center py-4';
                loadingDiv.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <div class="spinner w-5 h-5"></div>
                        <span class="text-gray-600">Loading more results...</span>
                    </div>
                `;
                this.container.appendChild(loadingDiv);
            }

            hideLoadingIndicator() {
                const loadingDiv = this.container.querySelector('.infinite-scroll-loading');
                if (loadingDiv) {
                    loadingDiv.remove();
                }
            }

            destroy() {
                if (this.observer) {
                    this.observer.disconnect();
                }
            }
        }

        // --- Debounced Search Component ---
        class DebouncedSearch {
            constructor(searchCallback, debounceMs = 300) {
                this.searchCallback = searchCallback;
                this.debounceMs = debounceMs;
                this.searchTimer = null;
                this.lastSearchTerm = '';
                this.isSearching = false;
            }

            search(searchTerm, filters = {}) {
                // Don't search if the term hasn't changed
                if (searchTerm === this.lastSearchTerm && !Object.keys(filters).length) {
                    return;
                }

                clearTimeout(this.searchTimer);
                
                this.searchTimer = setTimeout(async () => {
                    this.lastSearchTerm = searchTerm;
                    this.isSearching = true;
                    
                    try {
                        await this.searchCallback(searchTerm, filters);
                    } catch (error) {
                        console.error('Search failed:', error);
                        showToast('Search failed: ' + error.message, 'error');
                    } finally {
                        this.isSearching = false;
                    }
                }, this.debounceMs);
            }

            clearSearch() {
                clearTimeout(this.searchTimer);
                this.lastSearchTerm = '';
                this.isSearching = false;
            }

            destroy() {
                this.clearSearch();
            }
        }

        // --- Accessibility and Keyboard Navigation Enhancement ---
        class AccessibilityManager {
            constructor() {
                this.focusableElements = [
                    'button:not([disabled])',
                    'input:not([disabled])',
                    'select:not([disabled])',
                    'textarea:not([disabled])',
                    '[tabindex]:not([tabindex="-1"])',
                    'a[href]'
                ];
                this.setupGlobalKeyboardHandlers();
            }

            setupGlobalKeyboardHandlers() {
                document.addEventListener('keydown', (e) => {
                    // Handle global keyboard shortcuts
                    if (e.ctrlKey || e.metaKey) {
                        switch (e.key) {
                            case 'f':
                                e.preventDefault();
                                this.focusSearch();
                                break;
                            case 'n':
                                if (e.shiftKey) {
                                    e.preventDefault();
                                    this.navigateToNextPage();
                                }
                                break;
                            case 'p':
                                if (e.shiftKey) {
                                    e.preventDefault();
                                    this.navigateToPrevPage();
                                }
                                break;
                        }
                    }

                    // Handle escape key
                    if (e.key === 'Escape') {
                        this.closeModals();
                    }
                });
            }

            focusSearch() {
                const searchInput = document.querySelector('#search-term');
                if (searchInput) {
                    searchInput.focus();
                    searchInput.select();
                }
            }

            navigateToNextPage() {
                if (studentPaginationManager?.hasNextPage) {
                    studentPaginationManager.nextPage();
                }
            }

            navigateToPrevPage() {
                if (studentPaginationManager?.hasPrevPage) {
                    studentPaginationManager.prevPage();
                }
            }

            closeModals() {
                // Close any open modals
                if (!modalOverlay.classList.contains('hidden')) {
                    closeModal();
                }
                if (!confirmModalOverlay.classList.contains('hidden')) {
                    closeConfirmationModal();
                }
            }

            announceToScreenReader(message, priority = 'polite') {
                const announcement = document.createElement('div');
                announcement.setAttribute('aria-live', priority);
                announcement.setAttribute('aria-atomic', 'true');
                announcement.className = 'sr-only';
                announcement.textContent = message;
                
                document.body.appendChild(announcement);
                
                setTimeout(() => {
                    document.body.removeChild(announcement);
                }, 1000);
            }

            updatePageInfo(currentPage, totalPages, totalRecords) {
                const pageInfo = document.getElementById('pagination-page-info');
                if (pageInfo) {
                    pageInfo.setAttribute('aria-label', 
                        `Page ${currentPage} of ${totalPages}, showing results from ${totalRecords} total records`
                    );
                }
            }
        }

        // Initialize accessibility manager
        const accessibilityManager = new AccessibilityManager();

        // --- Enhanced Search Interface Component ---
        class EnhancedSearchInterface {
            constructor(container, paginationManager, onSearchChange) {
                this.container = container;
                this.paginationManager = paginationManager;
                this.onSearchChange = onSearchChange;
                this.debouncedSearch = new DebouncedSearch((term, filters) => {
                    return this.performSearch(term, filters);
                }, 300);
                
                this.filters = {};
                this.searchTerm = '';
                
                this.render();
                this.attachEventListeners();
            }

            render() {
                this.container.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <!-- Search Term Input -->
                            <div class="col-span-1 md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                                <div class="relative">
                                    <input type="text" 
                                           id="search-term" 
                                           placeholder="Search by name, index number, or email..."
                                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                        </svg>
                                    </div>
                                    <div id="search-loading" class="absolute inset-y-0 right-0 pr-3 flex items-center hidden">
                                        <div class="animate-spin h-4 w-4 border-2 border-blue-500 border-t-transparent rounded-full"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Program Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Program</label>
                                <select id="program-filter" class="w-full py-2 px-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">All Programs</option>
                                </select>
                            </div>

                            <!-- Year Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Year of Study</label>
                                <select id="year-filter" class="w-full py-2 px-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">All Years</option>
                                    <option value="1">Year 1</option>
                                    <option value="2">Year 2</option>
                                    <option value="3">Year 3</option>
                                    <option value="4">Year 4</option>
                                    <option value="5">Year 5</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Gender Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Gender</label>
                                <select id="gender-filter" class="w-full py-2 px-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">All Genders</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>

                            <!-- Sort Options -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                                <select id="sort-filter" class="w-full py-2 px-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                    <option value="name_asc">Name (A-Z)</option>
                                    <option value="name_desc">Name (Z-A)</option>
                                    <option value="index_asc">Index Number (A-Z)</option>
                                    <option value="index_desc">Index Number (Z-A)</option>
                                    <option value="program_asc">Program (A-Z)</option>
                                    <option value="year_asc">Year (1-4)</option>
                                </select>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex items-end space-x-2">
                                <button id="clear-filters" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 flex-1">
                                    Clear
                                </button>
                                <button id="advanced-search" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 flex-1">
                                    Advanced
                                </button>
                            </div>
                        </div>

                        <!-- Search Results Summary -->
                        <div id="search-summary" class="mt-4 text-sm text-gray-600 hidden">
                            <div class="flex items-center justify-between">
                                <span id="search-results-text"></span>
                                <div class="flex items-center space-x-2">
                                    <span>View:</span>
                                    <button id="view-grid" class="p-1 rounded text-blue-600 hover:bg-blue-50" title="Grid View">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                                        </svg>
                                    </button>
                                    <button id="view-table" class="p-1 rounded text-gray-400 hover:bg-gray-50" title="Table View">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm0 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V8zm0 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2z" clip-rule="evenodd"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            attachEventListeners() {
                const searchInput = this.container.querySelector('#search-term');
                const programFilter = this.container.querySelector('#program-filter');
                const yearFilter = this.container.querySelector('#year-filter');
                const genderFilter = this.container.querySelector('#gender-filter');
                const sortFilter = this.container.querySelector('#sort-filter');
                const clearButton = this.container.querySelector('#clear-filters');
                const advancedButton = this.container.querySelector('#advanced-search');

                // Search input with debouncing
                searchInput.addEventListener('input', (e) => {
                    this.searchTerm = e.target.value;
                    this.showSearchLoading(true);
                    this.debouncedSearch.search(this.searchTerm, this.filters);
                });

                // Filter changes
                [programFilter, yearFilter, genderFilter, sortFilter].forEach(filter => {
                    filter.addEventListener('change', (e) => {
                        this.updateFilter(e.target.id.replace('-filter', ''), e.target.value);
                        this.performSearch(this.searchTerm, this.filters);
                    });
                });

                // Clear filters
                clearButton.addEventListener('click', () => {
                    this.clearAllFilters();
                });

                // Advanced search (could open a modal with more options)
                advancedButton.addEventListener('click', () => {
                    this.openAdvancedSearch();
                });

                // View toggles
                this.container.querySelector('#view-grid').addEventListener('click', () => {
                    this.toggleView('grid');
                });

                this.container.querySelector('#view-table').addEventListener('click', () => {
                    this.toggleView('table');
                });
            }

            updateFilter(filterName, value) {
                if (value) {
                    this.filters[filterName] = value;
                } else {
                    delete this.filters[filterName];
                }
            }

            async performSearch(searchTerm, filters) {
                try {
                    // Build search filters object
                    const searchFilters = { ...filters };
                    if (searchTerm.trim()) {
                        searchFilters.name = searchTerm.trim();
                    }

                    // Update pagination manager filters
                    await this.paginationManager.search(searchFilters, 0); // No debounce since we already debounced
                    const data = await this.paginationManager.goToPage(1);
                    
                    this.showSearchSummary(data.totalCount, searchTerm, filters);
                    this.onSearchChange(data);
                } catch (error) {
                    console.error('Search failed:', error);
                    throw error;
                } finally {
                    this.showSearchLoading(false);
                }
            }

            showSearchLoading(show) {
                const loadingIndicator = this.container.querySelector('#search-loading');
                if (show) {
                    loadingIndicator.classList.remove('hidden');
                } else {
                    loadingIndicator.classList.add('hidden');
                }
            }

            showSearchSummary(totalCount, searchTerm, filters) {
                const summary = this.container.querySelector('#search-summary');
                const resultsText = this.container.querySelector('#search-results-text');
                
                let summaryText = `Found ${totalCount} result${totalCount !== 1 ? 's' : ''}`;
                
                if (searchTerm || Object.keys(filters).length > 0) {
                    summaryText += ' for';
                    if (searchTerm) {
                        summaryText += ` "${searchTerm}"`;
                    }
                    if (Object.keys(filters).length > 0) {
                        const filterDescriptions = [];
                        if (filters.program) filterDescriptions.push(`Program: ${filters.program}`);
                        if (filters.year) filterDescriptions.push(`Year: ${filters.year}`);
                        if (filters.gender) filterDescriptions.push(`Gender: ${filters.gender}`);
                        
                        if (filterDescriptions.length > 0) {
                            summaryText += ` (${filterDescriptions.join(', ')})`;
                        }
                    }
                }
                
                resultsText.textContent = summaryText;
                summary.classList.remove('hidden');
            }

            clearAllFilters() {
                // Clear input fields
                this.container.querySelector('#search-term').value = '';
                this.container.querySelector('#program-filter').value = '';
                this.container.querySelector('#year-filter').value = '';
                this.container.querySelector('#gender-filter').value = '';
                this.container.querySelector('#sort-filter').value = 'name_asc';

                // Clear internal state
                this.searchTerm = '';
                this.filters = {};

                // Perform empty search to show all results
                this.performSearch('', {});
            }

            toggleView(viewType) {
                const gridBtn = this.container.querySelector('#view-grid');
                const tableBtn = this.container.querySelector('#view-table');
                
                if (viewType === 'grid') {
                    gridBtn.classList.add('text-blue-600');
                    gridBtn.classList.remove('text-gray-400');
                    tableBtn.classList.add('text-gray-400');
                    tableBtn.classList.remove('text-blue-600');
                } else {
                    tableBtn.classList.add('text-blue-600');
                    tableBtn.classList.remove('text-gray-400');
                    gridBtn.classList.add('text-gray-400');
                    gridBtn.classList.remove('text-blue-600');
                }
                
                // Notify parent component of view change
                if (this.onViewChange) {
                    this.onViewChange(viewType);
                }
            }

            openAdvancedSearch() {
                // This could open a modal with additional search options
                openModal('Advanced Search', `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contact Email</label>
                            <input type="email" id="advanced-email" class="w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contact Phone</label>
                            <input type="tel" id="advanced-phone" class="w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date of Birth Range</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="date" id="advanced-dob-from" class="w-full p-2 border border-gray-300 rounded-md">
                                <input type="date" id="advanced-dob-to" class="w-full p-2 border border-gray-300 rounded-md">
                            </div>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button onclick="closeModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                Cancel
                            </button>
                            <button onclick="applyAdvancedSearch()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                Apply Filters
                            </button>
                        </div>
                    </div>
                `);
            }

            updateProgramOptions(programs) {
                const programSelect = this.container.querySelector('#program-filter');
                const currentValue = programSelect.value;
                
                programSelect.innerHTML = '<option value="">All Programs</option>';
                programs.forEach(program => {
                    const option = document.createElement('option');
                    option.value = program;
                    option.textContent = program;
                    if (program === currentValue) {
                        option.selected = true;
                    }
                    programSelect.appendChild(option);
                });
            }

            destroy() {
                this.debouncedSearch.destroy();
            }
        }

        // --- Skeleton Loading Component ---
        const createSkeletonLoader = (count = 5, type = 'card') => {
            const skeletons = [];
            for (let i = 0; i < count; i++) {
                if (type === 'card') {
                    skeletons.push(`
                        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4 animate-pulse">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-gray-300 rounded-full"></div>
                                <div class="flex-1 space-y-2">
                                    <div class="h-4 bg-gray-300 rounded w-3/4"></div>
                                    <div class="h-3 bg-gray-300 rounded w-1/2"></div>
                                </div>
                            </div>
                            <div class="mt-3 space-y-2">
                                <div class="h-3 bg-gray-300 rounded w-full"></div>
                                <div class="h-3 bg-gray-300 rounded w-2/3"></div>
                            </div>
                        </div>
                    `);
                } else if (type === 'table') {
                    skeletons.push(`
                        <tr class="animate-pulse">
                            <td class="px-6 py-4"><div class="h-4 bg-gray-300 rounded"></div></td>
                            <td class="px-6 py-4"><div class="h-4 bg-gray-300 rounded"></div></td>
                            <td class="px-6 py-4"><div class="h-4 bg-gray-300 rounded"></div></td>
                            <td class="px-6 py-4"><div class="h-4 bg-gray-300 rounded"></div></td>
                        </tr>
                    `);
                }
            }
            return skeletons.join('');
        };

        // --- Pagination State Management ---
        class PaginationManager {
            constructor(apiEndpoint, defaultPageSize = 20) {
                this.apiEndpoint = apiEndpoint;
                this.currentPage = 1;
                this.pageSize = defaultPageSize;
                this.totalRecords = 0;
                this.totalPages = 0;
                this.loading = false;
                this.error = null;
                this.cache = new Map();
                this.searchFilters = {};
                this.searchDebounceTimer = null;
                this.prefetchedPages = new Set();
            }

            get skip() {
                return (this.currentPage - 1) * this.pageSize;
            }

            get hasNextPage() {
                return this.currentPage < this.totalPages;
            }

            get hasPrevPage() {
                return this.currentPage > 1;
            }

            setFilters(filters) {
                this.searchFilters = { ...filters };
                this.cache.clear();
                this.prefetchedPages.clear();
                this.currentPage = 1;
            }

            setPageSize(size) {
                const prevSize = this.pageSize;
                this.pageSize = size;
                // Recalculate current page to maintain position
                const currentRecord = (this.currentPage - 1) * prevSize;
                this.currentPage = Math.floor(currentRecord / size) + 1;
                this.cache.clear();
                this.prefetchedPages.clear();
            }

            getCacheKey(page, filters = {}) {
                return JSON.stringify({ page, filters, pageSize: this.pageSize });
            }

            async fetchPage(page, filters = null, useCache = true) {
                const filtersToUse = filters || this.searchFilters;
                const cacheKey = this.getCacheKey(page, filtersToUse);
                
                if (useCache && this.cache.has(cacheKey)) {
                    return this.cache.get(cacheKey);
                }

                const skip = (page - 1) * this.pageSize;
                const params = new URLSearchParams({
                    skip: skip.toString(),
                    limit: this.pageSize.toString(),
                    ...filtersToUse
                });

                try {
                    const response = await api.fetchData(`${this.apiEndpoint}?${params}`, 'GET', null, false);
                    
                    if (response.success) {
                        const data = {
                            records: response.data.students || response.data.courses || response.data.grades || response.data,
                            totalCount: response.data.total_count || 0,
                            pagination: response.data.pagination || { skip, limit: this.pageSize }
                        };
                        
                        this.totalRecords = data.totalCount;
                        this.totalPages = Math.ceil(this.totalRecords / this.pageSize);
                        
                        // Cache the result
                        this.cache.set(cacheKey, data);
                        
                        // Prefetch adjacent pages
                        this.prefetchAdjacentPages(page, filtersToUse);
                        
                        return data;
                    } else {
                        throw new Error(response.message || 'Failed to fetch data');
                    }
                } catch (error) {
                    this.error = error.message;
                    throw error;
                }
            }

            async prefetchAdjacentPages(currentPage, filters) {
                const pagesToPrefetch = [currentPage - 1, currentPage + 1];
                
                for (const page of pagesToPrefetch) {
                    if (page > 0 && page <= this.totalPages && !this.prefetchedPages.has(page)) {
                        this.prefetchedPages.add(page);
                        // Prefetch in background without awaiting
                        this.fetchPage(page, filters, true).catch(() => {
                            // Ignore prefetch errors
                            this.prefetchedPages.delete(page);
                        });
                    }
                }
            }

            async goToPage(page) {
                if (page < 1 || page > this.totalPages) return null;
                this.currentPage = page;
                this.loading = true;
                try {
                    const data = await this.fetchPage(page);
                    this.error = null;
                    return data;
                } catch (error) {
                    this.error = error.message;
                    throw error;
                } finally {
                    this.loading = false;
                }
            }

            async nextPage() {
                if (this.hasNextPage) {
                    return await this.goToPage(this.currentPage + 1);
                }
                return null;
            }

            async prevPage() {
                if (this.hasPrevPage) {
                    return await this.goToPage(this.currentPage - 1);
                }
                return null;
            }

            async search(filters, debounceMs = 300) {
                return new Promise((resolve, reject) => {
                    clearTimeout(this.searchDebounceTimer);
                    this.searchDebounceTimer = setTimeout(async () => {
                        try {
                            this.setFilters(filters);
                            const data = await this.goToPage(1);
                            resolve(data);
                        } catch (error) {
                            reject(error);
                        }
                    }, debounceMs);
                });
            }
        }

        // --- Pagination UI Component ---
        class PaginationUI {
            constructor(container, paginationManager, onPageChange) {
                this.container = container;
                this.manager = paginationManager;
                this.onPageChange = onPageChange;
                this.lastKnownRecordCount = 0; // Track records for fallback scenarios
            }

            render() {
                const { currentPage, totalPages, totalRecords, pageSize, loading } = this.manager;
                
                // Debug logging for troubleshooting
                console.log('PaginationUI render - currentPage:', currentPage, 'totalPages:', totalPages, 'totalRecords:', totalRecords, 'pageSize:', pageSize);
                
                // Don't show pagination if truly no records
                if (totalRecords === 0 && currentPage === 1) {
                    this.container.innerHTML = '';
                    return;
                }

                // Handle cases where totalRecords might be undefined but we have data
                const recordCount = totalRecords || this.lastKnownRecordCount || 0;
                const pageCount = totalPages || Math.max(1, Math.ceil(recordCount / pageSize));
                const currentPageNum = currentPage || 1;

                const startRecord = ((currentPageNum - 1) * pageSize) + 1;
                const endRecord = Math.min(currentPageNum * pageSize, recordCount);
                
                const paginationHTML = `
                    <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                        <div class="flex-1 flex justify-between sm:hidden">
                            <button ${!this.manager.hasPrevPage || loading ? 'disabled' : ''} 
                                    class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                    data-action="prev">
                                Previous
                            </button>
                            <button ${!this.manager.hasNextPage || loading ? 'disabled' : ''} 
                                    class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                    data-action="next">
                                Next
                            </button>
                        </div>
                        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                            <div class="flex items-center space-x-4">
                                <p class="text-sm text-gray-700">
                                    Showing <span class="font-medium">${startRecord}</span> to <span class="font-medium">${endRecord}</span> of <span class="font-medium">${recordCount}</span> results
                                </p>
                                <div class="flex items-center space-x-2">
                                    <label class="text-sm text-gray-700">Per page:</label>
                                    <select class="border border-gray-300 rounded-md text-sm py-1 px-2 focus:ring-blue-500 focus:border-blue-500" 
                                            data-action="pageSize">
                                        <option value="10" ${pageSize === 10 ? 'selected' : ''}>10</option>
                                        <option value="20" ${pageSize === 20 ? 'selected' : ''}>20</option>
                                        <option value="50" ${pageSize === 50 ? 'selected' : ''}>50</option>
                                        <option value="100" ${pageSize === 100 ? 'selected' : ''}>100</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                    ${this.renderPageButtons()}
                                </nav>
                            </div>
                        </div>
                        ${loading ? '<div class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center"><div class="spinner"></div></div>' : ''}
                    </div>
                `;
                
                this.container.innerHTML = paginationHTML;
                this.lastKnownRecordCount = recordCount; // Store for future renders
                this.attachEventListeners();
            }

            renderPageButtons() {
                const { currentPage, totalPages } = this.manager;
                const buttons = [];
                
                // Previous button
                buttons.push(`
                    <button ${!this.manager.hasPrevPage ? 'disabled' : ''} 
                            class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                            data-action="prev">
                        <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `);

                // Page number buttons
                const { start, end } = this.calculatePageRange(currentPage, totalPages);
                
                if (start > 1) {
                    buttons.push(this.createPageButton(1));
                    if (start > 2) {
                        buttons.push('<span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">...</span>');
                    }
                }

                for (let i = start; i <= end; i++) {
                    buttons.push(this.createPageButton(i, i === currentPage));
                }

                if (end < totalPages) {
                    if (end < totalPages - 1) {
                        buttons.push('<span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">...</span>');
                    }
                    buttons.push(this.createPageButton(totalPages));
                }

                // Next button
                buttons.push(`
                    <button ${!this.manager.hasNextPage ? 'disabled' : ''} 
                            class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                            data-action="next">
                        <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `);

                return buttons.join('');
            }

            calculatePageRange(currentPage, totalPages) {
                const maxVisible = 7;
                const half = Math.floor(maxVisible / 2);
                
                let start = Math.max(1, currentPage - half);
                let end = Math.min(totalPages, start + maxVisible - 1);
                
                if (end - start + 1 < maxVisible) {
                    start = Math.max(1, end - maxVisible + 1);
                }
                
                return { start, end };
            }

            createPageButton(page, isActive = false) {
                return `
                    <button class="relative inline-flex items-center px-4 py-2 border text-sm font-medium ${
                        isActive 
                            ? 'z-10 bg-blue-50 border-blue-500 text-blue-600' 
                            : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'
                    }" data-action="page" data-page="${page}">
                        ${page}
                    </button>
                `;
            }

            attachEventListeners() {
                this.container.addEventListener('click', async (e) => {
                    const action = e.target.dataset.action;
                    if (!action) return;

                    e.preventDefault();
                    
                    try {
                        let result = null;
                        switch (action) {
                            case 'prev':
                                result = await this.manager.prevPage();
                                break;
                            case 'next':
                                result = await this.manager.nextPage();
                                break;
                            case 'page':
                                const page = parseInt(e.target.dataset.page);
                                result = await this.manager.goToPage(page);
                                break;
                        }
                        
                        if (result) {
                            this.render();
                            this.onPageChange(result);
                        }
                    } catch (error) {
                        showToast('Failed to load page: ' + error.message, 'error');
                    }
                });

                this.container.addEventListener('change', async (e) => {
                    if (e.target.dataset.action === 'pageSize') {
                        const newSize = parseInt(e.target.value);
                        this.manager.setPageSize(newSize);
                        try {
                            const result = await this.manager.goToPage(this.manager.currentPage);
                            this.render();
                            this.onPageChange(result);
                        } catch (error) {
                            showToast('Failed to update page size: ' + error.message, 'error');
                        }
                    }
                });
            }
        }

        // --- API Utility ---
        const api = {
            fetchData: async (endpoint, method = 'GET', body = null, showLoader = true) => {
                if (showLoader) showLoading();
                
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': getAuthHeader(),
                };

                const options = {
                    method,
                    headers,
                    body: body ? JSON.stringify(body) : null,
                };

                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                    let data;
                    try {
                        data = await response.json();
                    } catch (e) {
                        data = {};
                    }
                    if (!response.ok) {
                        // Only force logout on 401/403 errors
                        if (response.status === 401 || response.status === 403) {
                            setAuthUser(null);
                            showToast('Session expired. Please log in again.', 'error');
                            throw new Error('Session expired or unauthorized. Please log in again.');
                        }
                        
                        // Show user-friendly error messages
                        const errorMessage = data.message || `Server error (${response.status})`;
                        showToast(errorMessage, 'error');
                        throw new Error(errorMessage);
                    }
                    
                    // Show success message for successful operations that modify data
                    if ((method === 'POST' || method === 'PUT' || method === 'DELETE') && data.success && data.message) {
                        showToast(data.message, 'success');
                    }
                    
                    return data;
                } catch (error) {
                    // Only log out on explicit 401/403 above
                    console.error('API Call Failed:', endpoint, error);
                    if (!error.message.includes('Session expired')) {
                        showToast(error.message || 'An unexpected error occurred', 'error');
                    }
                    throw error;
                } finally {
                    if (showLoader) hideLoading();
                }
            },

            login: async (username, password) => {
                const tempAuthHeader = 'Basic ' + btoa(`${username}:${password}`);
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': tempAuthHeader,
                };
                const options = {
                    method: 'GET',
                    headers,
                };
                const response = await fetch(`${API_BASE_URL}/me`, options);
                const data = await response.json();

                if (response.ok && data.success) {
                    sessionStorage.setItem('srmsAuth', JSON.stringify({ username, password }));
                    return { success: true, user: data.data };
                } else {
                    throw new Error(data.message || 'Login failed: Invalid credentials');
                }
            },

            // --- Admin Endpoints (mimicking React structure) ---
            getAllStudents: async (skip = 0, limit = 100) => api.fetchData(`/admin/students?skip=${skip}&limit=${limit}`),
            searchStudents: async (filters = {}, skip = 0, limit = 100) => {
                const query = new URLSearchParams(filters).toString();
                return api.fetchData(`/admin/students/search?${query}&skip=${skip}&limit=${limit}`);
            },
            createStudent: async (studentData) => api.fetchData('/admin/students', 'POST', studentData),
            updateStudent: async (index_number, studentData) => api.fetchData(`/admin/students/${encodeURIComponent(index_number)}`, 'PUT', studentData),
            deleteStudent: async (index_number) => api.fetchData(`/admin/students/${encodeURIComponent(index_number)}`, 'DELETE'),

            getAllCourses: async (skip = 0, limit = 100) => api.fetchData(`/admin/courses?skip=${skip}&limit=${limit}`),
            createCourse: async (courseData) => api.fetchData('/admin/courses', 'POST', courseData),
            updateCourse: async (course_code, courseData) => api.fetchData(`/admin/courses/${encodeURIComponent(course_code)}`, 'PUT', courseData),
            deleteCourse: async (course_code) => api.fetchData(`/admin/courses/${encodeURIComponent(course_code)}`, 'DELETE'),

            getAllSemesters: async () => api.fetchData('/admin/semesters'),
            createSemester: async (semesterData) => api.fetchData('/admin/semesters', 'POST', semesterData),
            updateSemester: async (semester_name, semesterData) => api.fetchData(`/admin/semesters/${encodeURIComponent(semester_name)}`, 'PUT', semesterData),
            deleteSemester: async (semester_name) => api.fetchData(`/admin/semesters/${encodeURIComponent(semester_name)}`, 'DELETE'),

            getAllGrades: async (filters = {}, skip = 0, limit = 100) => {
                const query = new URLSearchParams(filters).toString();
                return api.fetchData(`/admin/grades?${query}&skip=${skip}&limit=${limit}`);
            },
            createGrade: async (gradeData) => api.fetchData('/admin/grades', 'POST', gradeData),
            updateGrade: async (grade_id, gradeData) => api.fetchData(`/admin/grades/${encodeURIComponent(grade_id)}`, 'PUT', gradeData),
            deleteGrade: async (grade_id) => api.fetchData(`/admin/grades/${encodeURIComponent(grade_id)}`, 'DELETE'),

            createUserAccount: async (userData) => api.fetchData('/admin/users', 'POST', userData),
            createStudentAccount: async (accountData) => api.fetchData('/admin/student-accounts', 'POST', accountData),
            resetStudentPassword: async (passwordResetData) => api.fetchData('/admin/reset-password', 'POST', passwordResetData),

            bulkImportData: async (importData) => api.fetchData('/admin/bulk-import', 'POST', importData),

            generateSummaryReport: async (filters = {}) => {
                const query = new URLSearchParams(filters).toString();
                return api.fetchData(`/admin/reports/summary?${query}`);
            },

            // Functions for downloading reports
            downloadSummaryReportPdf: async (filters = {}) => {
                const query = new URLSearchParams(filters).toString();
                const headers = { 'Authorization': getAuthHeader() };
                const response = await fetch(`${API_BASE_URL}/admin/reports/summary/pdf?${query}`, { headers });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `API Error: ${response.status} ${response.statusText}`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'summary_report.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            },
            
            downloadSummaryReportTxt: async (filters = {}) => {
                const query = new URLSearchParams(filters).toString();
                const headers = { 'Authorization': getAuthHeader() };
                const response = await fetch(`${API_BASE_URL}/admin/reports/summary/txt?${query}`, { headers });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `API Error: ${response.status} ${response.statusText}`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'summary_report.txt';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            },

            getAdminDashboardAnalytics: async () => api.fetchData('/admin/analytics/dashboard'),
            getEnrollmentStatistics: async (academicYear = null) => {
                const query = academicYear ? `academic_year=${encodeURIComponent(academicYear)}` : '';
                return api.fetchData(`/admin/statistics/enrollment?${query}`);
            },
            getGradesDistribution: async (semesterName = null, courseCode = null) => {
                let query = '';
                if (semesterName) query += `semester_name=${encodeURIComponent(semesterName)}&`;
                if (courseCode) query += `course_code=${encodeURIComponent(courseCode)}&`;
                return api.fetchData(`/admin/statistics/grades-distribution?${query}`);
            },
            generateStudentTranscript: async (index_number) => api.fetchData(`/admin/reports/transcript/${encodeURIComponent(index_number)}`),

            initializeSystem: async () => api.fetchData('/initialize', 'POST'),
            seedDatabase: async (numStudents = 100, cleanupFirst = true) => api.fetchData(`/admin/seed-comprehensive?num_students=${numStudents}&cleanup_first=${cleanupFirst}`, 'POST'),

            // --- Student Endpoints ---
            getStudentProfile: async () => api.fetchData('/student/profile'),
            getStudentGrades: async (semester = null, academicYear = null) => {
                let query = '';
                if (semester) query += `semester=${encodeURIComponent(semester)}&`;
                if (academicYear) query += `academic_year=${encodeURIComponent(academicYear)}&`;
                return api.fetchData(`/student/grades?${query}`);
            },
            getStudentGPA: async (semester = null, academicYear = null) => {
                let query = '';
                if (semester) query += `semester=${encodeURIComponent(semester)}&`;
                if (academicYear) query += `academic_year=${encodeURIComponent(academicYear)}&`;
                return api.fetchData(`/student/gpa?${query}`);
            },
            
            // Student report download functions
            downloadPersonalReportPdf: async () => {
                const headers = { 'Authorization': getAuthHeader() };
                const response = await fetch(`${API_BASE_URL}/student/report/pdf`, { headers });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `API Error: ${response.status} ${response.statusText}`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'personal_academic_report.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            },
            
            downloadPersonalReportTxt: async () => {
                const headers = { 'Authorization': getAuthHeader() };
                const response = await fetch(`${API_BASE_URL}/student/report/txt`, { headers });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `API Error: ${response.status} ${response.statusText}`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'personal_academic_report.txt';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            },
        };

        // --- Modal Functions ---
        const modalOverlay = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        let onModalCloseCallback = null;

        const openModal = (title, contentHtml, onClose = null) => {
            modalTitle.textContent = title;
            modalBody.innerHTML = contentHtml;
            modalOverlay.classList.remove('hidden');
            onModalCloseCallback = onClose;
        };

        const closeModal = () => {
            modalOverlay.classList.add('hidden');
            modalTitle.textContent = '';
            modalBody.innerHTML = '';
            if (onModalCloseCallback) {
                onModalCloseCallback();
                onModalCloseCallback = null;
            }
        };

        modalCloseBtn.addEventListener('click', closeModal);
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) {
                closeModal();
            }
        });

        // --- Confirmation Modal Functions ---
        const confirmModalOverlay = document.getElementById('confirmation-modal-overlay');
        const confirmModalTitle = document.getElementById('confirmation-modal-title');
        const confirmModalBody = document.getElementById('confirmation-modal-body');
        const confirmModalCloseBtn = document.getElementById('confirmation-modal-close-btn');
        const confirmModalCancelBtn = document.getElementById('confirmation-modal-cancel-btn');
        const confirmModalConfirmBtn = document.getElementById('confirmation-modal-confirm-btn');

        let onConfirmCallback = null;
        let onCancelCallback = null;

        const openConfirmationModal = (title, message, onConfirm, onCancel = null) => {
            confirmModalTitle.textContent = title;
            confirmModalBody.textContent = message;
            confirmModalOverlay.classList.remove('hidden');
            onConfirmCallback = onConfirm;
            onCancelCallback = onCancel;
        };

        const closeConfirmationModal = () => {
            confirmModalOverlay.classList.add('hidden');
            confirmModalTitle.textContent = '';
            confirmModalBody.textContent = '';
            onConfirmCallback = null;
            onCancelCallback = null;
        };

        confirmModalCloseBtn.addEventListener('click', closeConfirmationModal);
        confirmModalCancelBtn.addEventListener('click', () => {
            if (onCancelCallback) onCancelCallback();
            closeConfirmationModal();
        });
        confirmModalConfirmBtn.addEventListener('click', () => {
            if (onConfirmCallback) onConfirmCallback();
            closeConfirmationModal();
        });
        confirmModalOverlay.addEventListener('click', (e) => {
            if (e.target === confirmModalOverlay) {
                closeConfirmationModal();
            }
        });

        // --- Student Edit Modal ---
        const openStudentEditModal = (indexNumber, name, email, course, semester) => {
            const modalHTML = `
                <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" id="student-edit-modal">
                    <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4 p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Edit Student</h3>
                            <button id="student-edit-modal-close" class="text-gray-400 hover:text-gray-600 text-xl font-bold">&times;</button>
                        </div>
                        <form id="student-edit-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Index Number</label>
                                <input type="text" id="edit-index-number" value="${indexNumber}" readonly 
                                       class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                                <input type="text" id="edit-student-name" value="${name}" required 
                                       class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" id="edit-student-email" value="${email}" required 
                                       class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Course</label>
                                <input type="text" id="edit-student-course" value="${course}" required 
                                       class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
                                <input type="text" id="edit-student-semester" value="${semester}" required 
                                       class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" id="student-edit-cancel" 
                                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="submit" id="student-edit-save" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    Save Changes
                                </button>
                            </div>
                        </form>
                        <p id="student-edit-message" class="mt-3 text-center text-sm"></p>
                        <p id="student-edit-error" class="mt-3 text-center text-sm"></p>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = document.getElementById('student-edit-modal');
            const form = document.getElementById('student-edit-form');
            const closeBtn = document.getElementById('student-edit-modal-close');
            const cancelBtn = document.getElementById('student-edit-cancel');
            
            const closeModal = () => {
                modal.remove();
            };
            
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const saveBtn = document.getElementById('student-edit-save');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';
                
                try {
                    const updatedData = {
                        full_name: document.getElementById('edit-student-name').value,
                        contact_email: document.getElementById('edit-student-email').value,
                        program: document.getElementById('edit-student-course').value,
                        year_of_study: parseInt(document.getElementById('edit-student-semester').value) || null
                    };
                    
                    const result = await api.updateStudent(indexNumber, updatedData);
                    if (result.success) {
                        displayMessage('student-edit-message', 'Student updated successfully!', 'success');
                        setTimeout(() => {
                            closeModal();
                            fetchAndRenderStudents(); // Refresh the student list
                        }, 1500);
                    } else {
                        displayMessage('student-edit-error', result.message, 'error');
                    }
                } catch (err) {
                    displayMessage('student-edit-error', err.message, 'error');
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save Changes';
                }
            });
        };

        // --- Course Edit Modal ---
        const openCourseEditModal = (courseCode, title, credits) => {
            const modalHTML = `
                <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" id="course-edit-modal">
                    <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4 p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Edit Course</h3>
                            <button id="course-edit-modal-close" class="text-gray-400 hover:text-gray-600 text-xl font-bold">&times;</button>
                        </div>
                        <form id="course-edit-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Course Code</label>
                                <input type="text" id="edit-course-code" value="${courseCode}" readonly 
                                       class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Course Title</label>
                                <input type="text" id="edit-course-title" value="${title}" required 
                                       class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Credit Hours</label>
                                <input type="number" id="edit-course-credits" value="${credits}" min="1" max="10" required 
                                       class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" id="course-edit-cancel" 
                                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="submit" id="course-edit-save" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    Save Changes
                                </button>
                            </div>
                        </form>
                        <p id="course-edit-message" class="mt-3 text-center text-sm"></p>
                        <p id="course-edit-error" class="mt-3 text-center text-sm"></p>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = document.getElementById('course-edit-modal');
            const form = document.getElementById('course-edit-form');
            const closeBtn = document.getElementById('course-edit-modal-close');
            const cancelBtn = document.getElementById('course-edit-cancel');
            
            const closeModal = () => {
                modal.remove();
            };
            
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const saveBtn = document.getElementById('course-edit-save');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';
                
                try {
                    const updatedData = {
                        course_code: document.getElementById('edit-course-code').value,
                        course_title: document.getElementById('edit-course-title').value,
                        credit_hours: parseInt(document.getElementById('edit-course-credits').value)
                    };
                    
                    const result = await api.updateCourse(courseCode, updatedData);
                    if (result.success) {
                        displayMessage('course-edit-message', 'Course updated successfully!', 'success');
                        setTimeout(() => {
                            closeModal();
                            fetchAndRenderCourses(); // Refresh the course list
                        }, 1500);
                    } else {
                        displayMessage('course-edit-error', result.message, 'error');
                    }
                } catch (err) {
                    displayMessage('course-edit-error', err.message, 'error');
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save Changes';
                }
            });
        };

        // --- Grade Edit Modal ---
        const openGradeEditModal = (gradeId, courseCode, semester, academicYear, score) => {
            const modalHTML = `
                <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" id="grade-edit-modal">
                    <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4 p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Edit Grade</h3>
                            <button id="grade-edit-modal-close" class="text-gray-400 hover:text-gray-600 text-xl font-bold">&times;</button>
                        </div>
                        <form id="grade-edit-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Course Code</label>
                                <input type="text" id="edit-grade-course" value="${courseCode}" readonly 
                                       class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
                                <input type="text" id="edit-grade-semester" value="${semester}" readonly 
                                       class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Academic Year</label>
                                <input type="text" id="edit-grade-year" value="${academicYear}" readonly 
                                       class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Score (0-100)</label>
                                <input type="number" id="edit-grade-score" value="${score || ''}" step="0.1" min="0" max="100" required 
                                       class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" id="grade-edit-cancel" 
                                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="submit" id="grade-edit-save" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    Save Changes
                                </button>
                            </div>
                        </form>
                        <p id="grade-edit-message" class="mt-3 text-center text-sm"></p>
                        <p id="grade-edit-error" class="mt-3 text-center text-sm"></p>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = document.getElementById('grade-edit-modal');
            const form = document.getElementById('grade-edit-form');
            const closeBtn = document.getElementById('grade-edit-modal-close');
            const cancelBtn = document.getElementById('grade-edit-cancel');
            
            const closeModal = () => {
                modal.remove();
            };
            
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const saveBtn = document.getElementById('grade-edit-save');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';
                
                try {
                    const updatedData = {
                        score: parseFloat(document.getElementById('edit-grade-score').value)
                    };
                    
                    const result = await api.updateGrade(gradeId, updatedData);
                    if (result.success) {
                        displayMessage('grade-edit-message', 'Grade updated successfully!', 'success');
                        setTimeout(() => {
                            closeModal();
                            fetchAndRenderGrades(); // Refresh the grade list
                        }, 1500);
                    } else {
                        displayMessage('grade-edit-error', result.message, 'error');
                    }
                } catch (err) {
                    displayMessage('grade-edit-error', err.message, 'error');
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save Changes';
                }
            });
        };

        // --- Message Display Utility ---
        const displayMessage = (elementId, message, type = 'success') => {
            const el = document.getElementById(elementId);
            if (el) {
                el.textContent = message;
                el.className = `mt-3 text-center text-sm ${type === 'success' ? 'text-green-600' : 'text-red-600'}`;
                setTimeout(() => {
                    el.textContent = '';
                    el.className = '';
                }, 5000); // Clear message after 5 seconds
            }
        };

        // --- Login Page ---
        const renderLoginPage = () => {
            appDiv.innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-gray-100 p-4 sm:p-6">
                    <div class="bg-white p-8 md:p-10 rounded-lg shadow-md w-full max-w-md">
                        <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">SRMS Login</h2>
                        <form id="login-form" class="space-y-6">
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-2" for="username">
                                    Username
                                </label>
                                <input
                                    type="text"
                                    id="username"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-base"
                                    placeholder="Enter your username"
                                    required
                                />
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-2" for="password">
                                    Password
                                </label>
                                <input
                                    type="password"
                                    id="password"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-base"
                                    placeholder="Enter your password"
                                    required
                                />
                            </div>
                            <p id="login-error" class="text-red-600 text-sm text-center mt-4"></p>
                            <button
                                type="submit"
                                id="login-button"
                                class="w-full bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                Login
                            </button>
                        </form>
                    </div>
                </div>
            `;

            const loginForm = document.getElementById('login-form');
            const loginButton = document.getElementById('login-button');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const loginError = document.getElementById('login-error');

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                loginButton.disabled = true;
                loginError.textContent = '';

                const username = usernameInput.value;
                const password = passwordInput.value;

                try {
                    const result = await api.login(username, password);
                    if (result.success) {
                        setAuthUser(result.user);
                    } else {
                        loginError.textContent = result.error || 'Login failed.';
                    }
                } catch (err) {
                    loginError.textContent = err.message || 'An unexpected error occurred during login.';
                } finally {
                    loginButton.disabled = false;
                }
            });
        };

        // --- Admin Dashboard ---
        const renderAdminDashboard = async () => {
            let activeTab = sessionStorage.getItem('adminActiveTab') || 'students';

            const adminHeaderHtml = `
                <header class="bg-gray-800 text-white p-4 shadow-md flex flex-col sm:flex-row justify-between items-center">
                    <h1 class="text-2xl font-bold mb-4 sm:mb-0">Admin Dashboard</h1>
                    <nav class="w-full sm:w-auto">
                        <ul class="flex flex-wrap justify-center sm:justify-end gap-2 sm:gap-4 overflow-x-auto pb-2">
                            <li><button data-tab="students" class="tab-button px-3 py-1 rounded-md text-sm font-medium">Students</button></li>
                            <li><button data-tab="courses" class="tab-button px-3 py-1 rounded-md text-sm font-medium">Courses</button></li>
                            <li><button data-tab="semesters" class="tab-button px-3 py-1 rounded-md text-sm font-medium">Semesters</button></li>
                            <li><button data-tab="grades" class="tab-button px-3 py-1 rounded-md text-sm font-medium">Grades</button></li>
                            <li><button data-tab="users" class="tab-button px-3 py-1 rounded-md text-sm font-medium">Users</button></li>
                            <li><button data-tab="bulk" class="tab-button px-3 py-1 rounded-md text-sm font-medium">Bulk Ops</button></li>
                            <li><button data-tab="reports" class="tab-button px-3 py-1 rounded-md text-sm font-medium">Reports</button></li>
                            <li><button data-tab="system" class="tab-button px-3 py-1 rounded-md text-sm font-medium">System</button></li>
                            <li><button id="logout-button" class="px-3 py-1 bg-red-600 rounded-md text-sm font-medium hover:bg-red-700">Logout</button></li>
                        </ul>
                    </nav>
                </header>
                <main class="p-4 sm:p-6 lg:p-8">
                    <div id="admin-content" class="bg-white p-6 rounded-lg shadow-sm">
                        </div>
                </main>
            `;
            appDiv.innerHTML = adminHeaderHtml;

            const adminContentDiv = document.getElementById('admin-content');
            const tabButtons = document.querySelectorAll('.tab-button');
            const logoutButton = document.getElementById('logout-button');

            const switchTab = (tabName) => {
                activeTab = tabName;
                sessionStorage.setItem('adminActiveTab', activeTab);
                tabButtons.forEach(btn => {
                    if (btn.dataset.tab === activeTab) {
                        btn.classList.add('bg-blue-600');
                        btn.classList.remove('hover:bg-gray-700');
                    } else {
                        btn.classList.remove('bg-blue-600');
                        btn.classList.add('hover:bg-gray-700');
                    }
                });
                renderAdminTabContent(activeTab);
            };

            tabButtons.forEach(button => {
                button.addEventListener('click', () => switchTab(button.dataset.tab));
            });

            logoutButton.addEventListener('click', () => {
                setAuthUser(null);
                sessionStorage.removeItem('adminActiveTab'); // Clear last active tab on logout
            });

            // Initial render of the active tab content
            switchTab(activeTab);

            // --- Admin Tab Content Renderers ---
            async function renderAdminTabContent(tab) {
                adminContentDiv.innerHTML = `<p class="text-center text-gray-600 py-6">Loading ${tab} management...</p>`;
                try {
                    switch (tab) {
                        case 'students':
                            await renderAdminStudentManagement(adminContentDiv);
                            break;
                        case 'courses':
                            await renderAdminCourseManagement(adminContentDiv);
                            break;
                        case 'semesters':
                            await renderAdminSemesterManagement(adminContentDiv);
                            break;
                        case 'grades':
                            await renderAdminGradeManagement(adminContentDiv);
                            break;
                        case 'users':
                            await renderAdminUserManagement(adminContentDiv);
                            break;
                        case 'bulk':
                            await renderAdminBulkOperations(adminContentDiv);
                            break;
                        case 'reports':
                            await renderAdminReportManagement(adminContentDiv);
                            break;
                        case 'system':
                            await renderAdminSystemManagement(adminContentDiv);
                            break;
                        default:
                            adminContentDiv.innerHTML = `<p class="text-red-600 text-center py-6">Unknown tab selected.</p>`;
                    }
                } catch (error) {
                    adminContentDiv.innerHTML = `<p class="text-red-600 text-center py-6">Error loading ${tab} management: ${error.message}</p>`;
                }
            }
        };

        // --- Admin Student Management ---
        const renderAdminStudentManagement = async (parentDiv) => {
            parentDiv.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Student Management</h3>

                    <div class="mb-6 p-4 border border-gray-200 rounded-md bg-gray-50">
                        <h4 class="text-lg font-semibold mb-3 text-gray-700">Add New Student</h4>
                        <form id="add-student-form" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <input type="text" id="new-student-index" placeholder="Index Number (e.g., ug12345)" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                            <input type="text" id="new-student-name" placeholder="Full Name" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                            <input type="date" id="new-student-dob" placeholder="Date of Birth" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            <input type="text" id="new-student-gender" placeholder="Gender" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            <input type="email" id="new-student-email" placeholder="Contact Email" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            <input type="tel" id="new-student-phone" placeholder="Phone" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            <input type="text" id="new-student-program" placeholder="Program" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            <input type="number" id="new-student-year" placeholder="Year of Study" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" min="1" max="10" />
                            <button type="submit" id="add-student-button" class="col-span-full bg-green-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-green-700 disabled:opacity-50">
                                Add Student
                            </button>
                        </form>
                        <p id="add-student-message" class="mt-3 text-center text-sm"></p>
                        <p id="add-student-error" class="mt-3 text-center text-sm"></p>
                    </div>

                    <div class="mb-6 p-4 border border-gray-200 rounded-md bg-gray-50">
                        <h4 class="text-lg font-semibold mb-3 text-gray-700">Search Students</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                            <input type="text" id="search-term" placeholder="Search by Name" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            <input type="text" id="search-program" placeholder="Filter by Program" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            <input type="number" id="search-year" placeholder="Filter by Year" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            <input type="text" id="search-gender" placeholder="Filter by Gender" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            <button id="search-students-button" class="col-span-full md:col-span-1 bg-blue-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-blue-700 disabled:opacity-50">
                                Search with Filters
                            </button>
                        </div>
                    </div>

                    <div class="mb-6 flex justify-between items-center">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-700">Student Directory</h4>
                            <p class="text-sm text-gray-500 mt-1">Manage student profiles with easy access to details and actions</p>
                        </div>
                        <button id="load-all-students-button" class="bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700 disabled:opacity-50">
                            Load Students
                        </button>
                    </div>
                    <p id="student-list-loading" class="text-center text-gray-600 py-6 hidden">Loading students...</p>
                    <p id="student-list-error" class="text-red-600 text-center py-6 hidden"></p>
                    <div id="student-list-container" class="rounded-md">
                        <div class="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">No students loaded</h3>
                            <p class="mt-1 text-sm text-gray-500">Click "Load Students" to view all students or use search filters to find specific students.</p>
                        </div>
                    </div>
                </div>
            `;

            const addStudentForm = document.getElementById('add-student-form');
            const addStudentButton = document.getElementById('add-student-button');
            const addStudentMessage = document.getElementById('add-student-message');
            const addStudentError = document.getElementById('add-student-error');

            const searchStudentsButton = document.getElementById('search-students-button');
            const loadAllStudentsButton = document.getElementById('load-all-students-button');
            const searchTermInput = document.getElementById('search-term');
            const searchProgramInput = document.getElementById('search-program');
            const searchYearInput = document.getElementById('search-year');
            const searchGenderInput = document.getElementById('search-gender');

            // --- Updated Student Management with Enhanced Pagination ---
            const studentListContainer = document.getElementById('student-list-container');
            const studentListLoading = document.getElementById('student-list-loading');
            const studentListError = document.getElementById('student-list-error');

            // Initialize pagination manager for students
            let studentPaginationManager = null;
            let studentPaginationUI = null;
            let studentSearchInterface = null;
            let studentVirtualScroll = null;
            let useVirtualScrolling = false; // Toggle for virtual scrolling vs traditional pagination

            const initializeStudentPagination = () => {
                // Create pagination manager
                studentPaginationManager = new PaginationManager('/admin/students/search', 20);
                
                // Create search interface
                const searchContainer = document.createElement('div');
                searchContainer.id = 'student-search-interface';
                studentListContainer.parentNode.insertBefore(searchContainer, studentListContainer);
                
                studentSearchInterface = new EnhancedSearchInterface(
                    searchContainer,
                    studentPaginationManager,
                    (data) => handleStudentDataUpdate(data)
                );

                // Create pagination UI container
                const paginationContainer = document.createElement('div');
                paginationContainer.id = 'student-pagination';
                studentListContainer.parentNode.insertBefore(paginationContainer, studentListContainer.nextSibling);
                
                studentPaginationUI = new PaginationUI(
                    paginationContainer,
                    studentPaginationManager,
                    (data) => handleStudentDataUpdate(data)
                );

                // Initialize virtual scrolling for large datasets
                if (useVirtualScrolling) {
                    studentVirtualScroll = new StudentVirtualScroll(
                        studentListContainer,
                        handleStudentEdit,
                        handleStudentDelete
                    );
                }
            };

            const handleStudentDataUpdate = (data) => {
                console.log('handleStudentDataUpdate called with:', data); // Debug log
                if (data && data.records) {
                    console.log('Found', data.records.length, 'student records'); // Debug log
                    if (useVirtualScrolling && studentVirtualScroll) {
                        studentVirtualScroll.setData(data.records);
                    } else {
                        renderStudentCards(data.records);
                    }
                    
                    // Only render pagination if it's initialized
                    if (studentPaginationUI) {
                        studentPaginationUI.render();
                    }
                    
                    // Update program options in search interface
                    if (studentSearchInterface) {
                        const programs = [...new Set(data.records.map(s => s.program).filter(Boolean))];
                        studentSearchInterface.updateProgramOptions(programs);
                    }
                } else {
                    console.log('No data or no records found:', data); // Debug log
                }
            };

            const handleStudentEdit = (student, indexNumber) => {
                openStudentEditModal(
                    indexNumber,
                    student.full_name,
                    student.contact_email || '',
                    student.program || '',
                    student.year_of_study || ''
                );
            };

            const handleStudentDelete = (student, indexNumber) => {
                openConfirmationModal(
                    'Confirm Deletion',
                    `Are you sure you want to delete student ${student.full_name} (${indexNumber})?`,
                    async () => {
                        try {
                            const result = await api.deleteStudent(indexNumber);
                            if (result.success) {
                                showToast(result.message, 'success');
                                await refreshStudentData();
                            } else {
                                showToast(result.message, 'error');
                            }
                        } catch (error) {
                            showToast('Failed to delete student: ' + error.message, 'error');
                        }
                    }
                );
            };

            const refreshStudentData = async () => {
                try {
                    const data = await studentPaginationManager.goToPage(studentPaginationManager.currentPage);
                    handleStudentDataUpdate(data);
                } catch (error) {
                    showToast('Failed to refresh data: ' + error.message, 'error');
                }
            };

            const fetchAndRenderStudents = async (useFilters = true) => {
                // Show loading state
                studentListLoading.classList.remove('hidden');
                studentListError.classList.add('hidden');
                studentListContainer.innerHTML = '';

                try {
                    // Initialize pagination if not already done
                    if (!studentPaginationManager) {
                        initializeStudentPagination();
                    }

                    // Build filters from the old search inputs (for backward compatibility)
                    const filters = {};
                    if (useFilters) {
                        // Try new search interface first, then fall back to old inputs
                        const searchTermInput = document.getElementById('search-term') || document.getElementById('search-term-input');
                        const searchProgramInput = document.getElementById('program-filter') || document.getElementById('search-program-input');
                        const searchYearInput = document.getElementById('year-filter') || document.getElementById('search-year-input');
                        const searchGenderInput = document.getElementById('gender-filter') || document.getElementById('search-gender-input');

                        if (searchTermInput?.value) filters.name = searchTermInput.value;
                        if (searchProgramInput?.value) filters.program = searchProgramInput.value;
                        if (searchYearInput?.value) filters.year_of_study = parseInt(searchYearInput.value);
                        if (searchGenderInput?.value) filters.gender = searchGenderInput.value;
                    }

                    // Use the new pagination system
                    console.log('Searching with filters:', filters); // Debug log
                    await studentPaginationManager.search(filters, 0);
                    const data = await studentPaginationManager.goToPage(1);
                    console.log('Received data:', data); // Debug log
                    
                    if (data && data.records && data.records.length > 0) {
                        handleStudentDataUpdate(data);
                    } else {
                        console.log('No data received, trying fallback API call'); // Debug log
                        // Fallback to old API call if pagination fails
                        const fallbackData = await api.searchStudents(filters, 0, 20);
                        console.log('Fallback API response:', fallbackData); // Debug log
                        
                        if (fallbackData.success && fallbackData.data.students) {
                            // Create a data structure compatible with handleStudentDataUpdate
                            const compatibleData = {
                                records: fallbackData.data.students,
                                totalCount: fallbackData.data.total_count || fallbackData.data.students.length,
                                pagination: { skip: 0, limit: 20 }
                            };
                            
                            console.log('Compatible data for fallback:', compatibleData); // Debug log
                            
                            // Update pagination manager state BEFORE calling handleStudentDataUpdate
                            if (studentPaginationManager) {
                                studentPaginationManager.totalRecords = compatibleData.totalCount;
                                studentPaginationManager.totalPages = Math.ceil(compatibleData.totalCount / studentPaginationManager.pageSize);
                                studentPaginationManager.currentPage = 1;
                                console.log('Updated pagination manager - totalRecords:', studentPaginationManager.totalRecords, 'totalPages:', studentPaginationManager.totalPages); // Debug log
                            }
                            
                            handleStudentDataUpdate(compatibleData);
                        } else {
                            studentListContainer.innerHTML = `<p class="text-gray-600 text-center py-6">No students found.</p>`;
                        }
                    }
                } catch (error) {
                    studentListError.textContent = error.message || 'An error occurred while fetching students.';
                    studentListError.classList.remove('hidden');
                } finally {
                    studentListLoading.classList.add('hidden');
                }
            };

            const renderStudentCards = (students) => {
                // Enhanced student card rendering with better performance
                if (!students || students.length === 0) {
                    studentListContainer.innerHTML = `
                        <div class="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">No students found</h3>
                            <p class="mt-1 text-sm text-gray-500">Try adjusting your search criteria or add some students to get started.</p>
                        </div>
                    `;
                    return;
                }

                // Use document fragment for better performance
                const fragment = document.createDocumentFragment();
                const studentsGrid = document.createElement('div');
                studentsGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
                studentsGrid.id = 'students-grid';

                students.forEach(student => {
                    const studentCard = createStudentCard(student);
                    studentsGrid.appendChild(studentCard);
                });

                fragment.appendChild(studentsGrid);
                studentListContainer.innerHTML = '';
                studentListContainer.appendChild(fragment);

                // Attach event listeners for the cards
                attachStudentCardEventListeners();
            };

            const createStudentCard = (student) => {
                const card = document.createElement('div');
                card.className = 'student-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow duration-200';
                card.dataset.studentName = student.full_name;
                card.dataset.studentIndex = student.index_number;
                card.dataset.program = student.program || '';
                card.dataset.year = student.year_of_study || '';

                const initials = student.full_name 
                    ? student.full_name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase()
                    : student.index_number.substring(0, 2).toUpperCase();
                
                const yearBadge = student.year_of_study 
                    ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Year ${student.year_of_study}</span>`
                    : '';

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-3 mb-3">
                                <div class="flex-shrink-0 w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-semibold text-sm shadow-sm">
                                    ${initials}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h4 class="student-name text-lg font-semibold text-gray-900 truncate">${student.full_name}</h4>
                                    <p class="text-sm text-gray-600 truncate">${student.index_number}</p>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <p class="student-email text-sm text-gray-600 truncate">
                                    <span class="inline-flex items-center">
                                        <svg class="w-4 h-4 mr-1.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"></path>
                                        </svg>
                                        ${student.contact_email || 'No email'}
                                    </span>
                                </p>
                                <p class="student-course text-sm text-gray-600 truncate">
                                    <span class="inline-flex items-center">
                                        <svg class="w-4 h-4 mr-1.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                        </svg>
                                        ${student.program || 'N/A'}
                                    </span>
                                </p>
                                <div class="flex items-center justify-between">
                                    ${yearBadge}
                                    <div class="flex space-x-1">
                                        <button data-action="edit" data-index="${student.index_number}" 
                                                class="px-3 py-1.5 bg-blue-600 text-white text-xs font-medium rounded-md hover:bg-blue-700 transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1"
                                                title="Edit student">
                                            Edit
                                        </button>
                                        <button data-action="delete" data-index="${student.index_number}" 
                                                class="px-3 py-1.5 bg-red-600 text-white text-xs font-medium rounded-md hover:bg-red-700 transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1"
                                                title="Delete student">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                return card;
            };

            const attachStudentCardEventListeners = () => {
                studentListContainer.addEventListener('click', async (e) => {
                    const target = e.target;
                    if (target.tagName === 'BUTTON' && target.dataset.action) {
                        e.preventDefault();
                        
                        const indexNumber = target.dataset.index;
                        const studentCard = target.closest('.student-card');
                        
                        if (target.dataset.action === 'edit') {
                            const name = studentCard.querySelector('.student-name').textContent;
                            const email = studentCard.querySelector('.student-email').textContent.replace(/.*/, '').trim();
                            const course = studentCard.querySelector('.student-course').textContent.replace(/.*/, '').trim();
                            const yearBadge = studentCard.querySelector('.bg-blue-100');
                            const semester = yearBadge ? yearBadge.textContent.replace('Year ', '') : '';
                            
                            openStudentEditModal(indexNumber, name, email, course, semester);
                        } else if (target.dataset.action === 'delete') {
                            const name = studentCard.querySelector('.student-name').textContent;
                            openConfirmationModal(
                                'Confirm Deletion',
                                `Are you sure you want to delete student ${name} (${indexNumber})?`,
                                async () => {
                                    try {
                                        const result = await api.deleteStudent(indexNumber);
                                        if (result.success) {
                                            showToast(result.message, 'success');
                                            await refreshStudentData();
                                        } else {
                                            showToast(result.message, 'error');
                                        }
                                    } catch (error) {
                                        showToast('Failed to delete student: ' + error.message, 'error');
                                    }
                                }
                            );
                        }
                    }
                });
            };

            // Enhanced student form submission with pagination refresh
            addStudentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                addStudentButton.disabled = true;
                displayMessage('add-student-message', '', 'success');
                displayMessage('add-student-error', '', 'error');

                const newStudent = {
                    index_number: document.getElementById('new-student-index').value,
                    full_name: document.getElementById('new-student-name').value,
                    date_of_birth: document.getElementById('new-student-dob').value || null,
                    gender: document.getElementById('new-student-gender').value || null,
                    contact_email: document.getElementById('new-student-email').value || null,
                    contact_phone: document.getElementById('new-student-phone').value || null,
                    program: document.getElementById('new-student-program').value || null,
                    year_of_study: parseInt(document.getElementById('new-student-year').value) || null,
                };

                try {
                    const result = await api.createStudent(newStudent);
                    if (result.success) {
                        displayMessage('add-student-message', result.message, 'success');
                        addStudentForm.reset();
                        await refreshStudentData(); // Use the new pagination refresh
                    } else {
                        displayMessage('add-student-error', result.message, 'error');
                    }
                } catch (err) {
                    displayMessage('add-student-error', err.message, 'error');
                } finally {
                    addStudentButton.disabled = false;
                }
            });

            // Update legacy button handlers
            searchStudentsButton.addEventListener('click', () => fetchAndRenderStudents(true));
            
            // Enhanced Load All / Hide Students functionality
            loadAllStudentsButton.addEventListener('click', async () => {
                if (loadAllStudentsButton.textContent.trim() === 'Load Students') {
                    await fetchAndRenderStudents(false);
                    loadAllStudentsButton.textContent = 'Hide Students';
                } else {
                    studentListContainer.innerHTML = `
                        <div class="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">No students loaded</h3>
                            <p class="mt-1 text-sm text-gray-500">Click "Load Students" to view all students or use search filters to find specific students.</p>
                        </div>
                    `;
                    
                    // Hide pagination components
                    if (studentPaginationUI && document.getElementById('student-pagination')) {
                        document.getElementById('student-pagination').innerHTML = '';
                    }
                    if (studentSearchInterface && document.getElementById('student-search-interface')) {
                        document.getElementById('student-search-interface').innerHTML = '';
                    }
                    
                    loadAllStudentsButton.textContent = 'Load Students';
                }
            });

            // Don't auto-fetch students on page load - let user search explicitly
            // Users can click "Search Students" to load the initial data
        };

        // --- Admin Course Management ---
        const renderAdminCourseManagement = async (parentDiv) => {
            parentDiv.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Course Management</h3>

                    <div class="mb-6 p-4 border border-gray-200 rounded-md bg-gray-50">
                        <h4 class="text-lg font-semibold mb-3 text-gray-700">Add New Course</h4>
                        <form id="add-course-form" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <input type="text" id="new-course-code" placeholder="Course Code (e.g., CS101)" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                            <input type="text" id="new-course-title" placeholder="Course Title" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                            <input type="number" id="new-course-credits" placeholder="Credits" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" min="1" max="10" required />
                            <button type="submit" id="add-course-button" class="col-span-full bg-green-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-green-700 disabled:opacity-50">
                                Add Course
                            </button>
                        </form>
                        <p id="add-course-message" class="mt-3 text-center text-sm"></p>
                        <p id="add-course-error" class="mt-3 text-center text-sm"></p>
                    </div>

                    <div class="mb-6 flex justify-between items-center">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-700">Course Catalog</h4>
                            <p class="text-sm text-gray-500 mt-1">Manage courses with detailed information and easy access</p>
                        </div>
                        <button id="load-all-courses-button" class="bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700 disabled:opacity-50">
                            Load Courses
                        </button>
                    </div>
                    <p id="course-list-loading" class="text-center text-gray-600 py-6 hidden">Loading courses...</p>
                    <p id="course-list-error" class="text-red-600 text-center py-6 hidden"></p>
                    <div id="course-list-container" class="rounded-md">
                        <div class="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">No courses loaded</h3>
                            <p class="mt-1 text-sm text-gray-500">Click "Load Courses" to view the course catalog.</p>
                        </div>
                    </div>
                </div>
            `;

            const addCourseForm = document.getElementById('add-course-form');
            const addCourseButton = document.getElementById('add-course-button');
            const addCourseMessage = document.getElementById('add-course-message');
            const addCourseError = document.getElementById('add-course-error');
            const loadAllCoursesButton = document.getElementById('load-all-courses-button');
            const courseListContainer = document.getElementById('course-list-container');
            const courseListLoading = document.getElementById('course-list-loading');
            const courseListError = document.getElementById('course-list-error');

            const fetchAndRenderCourses = async () => {
                courseListLoading.classList.remove('hidden');
                courseListError.classList.add('hidden');
                courseListContainer.innerHTML = '';
                try {
                    const data = await api.getAllCourses();
                    if (data.success) {
                        if (data.data.courses.length === 0) {
                            courseListContainer.innerHTML = `<p class="text-gray-600 text-center py-6">No courses found.</p>`;
                        } else {
                            renderCourseCards(data.data.courses);
                        }
                    } else {
                        courseListError.textContent = data.message || 'Failed to fetch courses.';
                        courseListError.classList.remove('hidden');
                    }
                } catch (error) {
                    courseListError.textContent = error.message || 'An error occurred while fetching courses.';
                    courseListError.classList.remove('hidden');
                } finally {
                    courseListLoading.classList.add('hidden');
                }
            };

            const renderCourseCards = (courses) => {
                // Simple search interface
                let html = `
                    <div class="mb-4">
                        <input type="text" id="course-quick-search" placeholder="Search courses by code or title..." 
                               class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="courses-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                `;

                courses.forEach(course => {
                    html += `
                        <div class="course-card bg-white border border-gray-200 rounded-lg p-4" 
                             data-course-code="${course.course_code}" data-course-title="${course.course_title}" 
                             data-credits="${course.credit_hours}">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h4 class="course-title text-lg font-medium text-gray-900">${course.course_title}</h4>
                                    <p class="text-sm text-gray-600">${course.course_code}</p>
                                    <p class="text-sm text-gray-600">${course.credit_hours} Credits</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button data-action="edit" data-code="${course.course_code}" 
                                            class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                        Edit
                                    </button>
                                    <button data-action="delete" data-code="${course.course_code}" 
                                            class="px-3 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
                courseListContainer.innerHTML = html;

                // Simple search functionality
                const searchInput = document.getElementById('course-quick-search');
                if (searchInput) {
                    searchInput.addEventListener('input', () => {
                        const searchTerm = searchInput.value.toLowerCase();
                        const courseCards = document.querySelectorAll('.course-card');
                        
                        courseCards.forEach(card => {
                            const code = card.dataset.courseCode.toLowerCase();
                            const title = card.dataset.courseTitle.toLowerCase();
                            const matches = code.includes(searchTerm) || title.includes(searchTerm);
                            card.style.display = matches ? 'block' : 'none';
                        });
                    });
                }
            };

            addCourseForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                addCourseButton.disabled = true;
                displayMessage('add-course-message', '', 'success');
                displayMessage('add-course-error', '', 'error');

                const newCourse = {
                    course_code: document.getElementById('new-course-code').value,
                    course_title: document.getElementById('new-course-title').value,
                    credits: parseInt(document.getElementById('new-course-credits').value),
                };

                try {
                    const result = await api.createCourse(newCourse);
                    if (result.success) {
                        displayMessage('add-course-message', result.message, 'success');
                        addCourseForm.reset();
                        fetchAndRenderCourses();
                    } else {
                        displayMessage('add-course-error', result.message, 'error');
                    }
                } catch (err) {
                    displayMessage('add-course-error', err.message, 'error');
                } finally {
                    addCourseButton.disabled = false;
                }
            });

            courseListContainer.addEventListener('click', async (e) => {
                const target = e.target;
                if (target.tagName === 'BUTTON' && target.dataset.action) {
                    const courseCode = target.dataset.code;
                    if (target.dataset.action === 'edit') {
                        const courseCard = target.closest('.course-card');
                        const title = courseCard.querySelector('.course-title').textContent;
                        const credits = courseCard.dataset.credits;
                        
                        openCourseEditModal(courseCode, title, credits);
                    } else if (target.dataset.action === 'delete') {
                        openConfirmationModal(
                            'Confirm Deletion',
                            `Are you sure you want to delete course ${courseCode}? This will also remove associated grades.`,
                            async () => {
                                try {
                                    const result = await api.deleteCourse(courseCode);
                                    if (result.success) {
                                        displayMessage('course-list-message', result.message, 'success');
                                        fetchAndRenderCourses();
                                    } else {
                                        displayMessage('course-list-error', result.message, 'error');
                                    }
                                } catch (err) {
                                    displayMessage('course-list-error', err.message, 'error');
                                }
                            }
                        );
                    }
                }
            });

            // Toggle functionality for Load All / Hide Courses
            loadAllCoursesButton.addEventListener('click', () => {
                if (loadAllCoursesButton.textContent.trim() === 'Load Courses') {
                    fetchAndRenderCourses();
                    loadAllCoursesButton.textContent = 'Hide Courses';
                } else {
                    courseListContainer.innerHTML = `
                        <div class="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">No courses loaded</h3>
                            <p class="mt-1 text-sm text-gray-500">Click "Load Courses" to view the course catalog.</p>
                        </div>
                    `;
                    loadAllCoursesButton.textContent = 'Load Courses';
                }
            });
        };

        // --- Admin Semester Management ---
        const renderAdminSemesterManagement = async (parentDiv) => {
            parentDiv.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Semester Management</h3>
                    
                    <div class="mb-6 p-4 border border-gray-200 rounded-md bg-gray-50">
                        <h4 class="text-lg font-semibold mb-3 text-gray-700">Add New Semester</h4>
                        <form id="add-semester-form" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <input type="text" id="new-semester-name" placeholder="Semester Name (e.g., Semester 1)" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                            <input type="number" id="new-semester-year" placeholder="Academic Year (e.g., 2024)" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                            <button type="submit" id="add-semester-button" class="col-span-full bg-green-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-green-700 disabled:opacity-50">
                                Add Semester
                            </button>
                        </form>
                        <p id="add-semester-message" class="mt-3 text-center text-sm"></p>
                        <p id="add-semester-error" class="mt-3 text-center text-sm"></p>
                    </div>

                    <div class="mb-6 flex justify-between items-center">
                        <h4 class="text-lg font-semibold text-gray-700">All Semesters</h4>
                        <button id="load-all-semesters-button" class="bg-green-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-green-700 disabled:opacity-50">
                            Load All Semesters
                        </button>
                    </div>
                    <p id="semester-list-loading" class="text-center text-gray-600 py-6 hidden">Loading semesters...</p>
                    <p id="semester-list-error" class="text-red-600 text-center py-6 hidden"></p>
                    <div id="semester-list-container" class="overflow-x-auto rounded-md border border-gray-200">
                        <p class="text-gray-600 text-center py-6">Click "Load All Semesters" to view all semesters.</p>
                    </div>
                </div>
            `;
            const addSemesterForm = document.getElementById('add-semester-form');
            const addSemesterButton = document.getElementById('add-semester-button');
            const addSemesterMessage = document.getElementById('add-semester-message');
            const addSemesterError = document.getElementById('add-semester-error');
            const loadAllSemestersButton = document.getElementById('load-all-semesters-button');
            const semesterListContainer = document.getElementById('semester-list-container');
            const semesterListLoading = document.getElementById('semester-list-loading');
            const semesterListError = document.getElementById('semester-list-error');

            const fetchAndRenderSemesters = async () => {
                semesterListLoading.classList.remove('hidden');
                semesterListError.classList.add('hidden');
                semesterListContainer.innerHTML = '';
                try {
                    const data = await api.getAllSemesters();
                    if (data.success) {
                        if (data.data.semesters.length === 0) {
                            semesterListContainer.innerHTML = `<p class="text-gray-600 text-center py-6">No semesters found.</p>`;
                        } else {
                            let tableHtml = `
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Semester Name</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Academic Year</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                            `;
                            data.data.semesters.forEach(semester => {
                                tableHtml += `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${semester.semester_name}</td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${semester.academic_year}</td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                                                <button data-action="edit" data-name="${semester.semester_name}" class="text-blue-600 hover:text-blue-900 mx-1">Edit</button>
                                                <button data-action="delete" data-name="${semester.semester_name}" class="text-red-600 hover:text-red-900 mx-1">Delete</button>
                                            </td>
                                        </tr>
                                `;
                            });
                            tableHtml += `
                                    </tbody>
                                </table>
                            `;
                            semesterListContainer.innerHTML = tableHtml;
                        }
                    } else {
                        semesterListError.textContent = data.message || 'Failed to fetch semesters.';
                        semesterListError.classList.remove('hidden');
                    }
                } catch (error) {
                    semesterListError.textContent = error.message || 'An error occurred while fetching semesters.';
                    semesterListError.classList.remove('hidden');
                } finally {
                    semesterListLoading.classList.add('hidden');
                }
            };
            addSemesterForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                addSemesterButton.disabled = true;
                displayMessage('add-semester-message', '', 'success');
                displayMessage('add-semester-error', '', 'error');
                const newSemester = {
                    semester_name: document.getElementById('new-semester-name').value,
                    academic_year: parseInt(document.getElementById('new-semester-year').value),
                };
                try {
                    const result = await api.createSemester(newSemester);
                    if (result.success) {
                        displayMessage('add-semester-message', result.message, 'success');
                        addSemesterForm.reset();
                        fetchAndRenderSemesters();
                    } else {
                        displayMessage('add-semester-error', result.message, 'error');
                    }
                } catch (err) {
                    displayMessage('add-semester-error', err.message, 'error');
                } finally {
                    addSemesterButton.disabled = false;
                }
            });
            semesterListContainer.addEventListener('click', async (e) => {
                const target = e.target;
                if (target.tagName === 'BUTTON' && target.dataset.action) {
                    const semesterName = target.dataset.name;
                    if (target.dataset.action === 'delete') {
                        openConfirmationModal(
                            'Confirm Deletion',
                            `Are you sure you want to delete semester ${semesterName}?`,
                            async () => {
                                try {
                                    const result = await api.deleteSemester(semesterName);
                                    if (result.success) {
                                        displayMessage('semester-list-message', result.message, 'success');
                                        fetchAndRenderSemesters();
                                    } else {
                                        displayMessage('semester-list-error', result.message, 'error');
                                    }
                                } catch (err) {
                                    displayMessage('semester-list-error', err.message, 'error');
                                }
                            }
                        );
                    }
                }
            });
            
            // Toggle functionality for Load All / Hide Semesters
            loadAllSemestersButton.addEventListener('click', () => {
                if (loadAllSemestersButton.textContent.trim() === 'Load All Semesters') {
                    fetchAndRenderSemesters();
                    loadAllSemestersButton.textContent = 'Hide Semesters';
                } else {
                    semesterListContainer.innerHTML = '';
                    loadAllSemestersButton.textContent = 'Load All Semesters';
                }
            });
        };

        // --- Admin Grade Management ---
        const renderAdminGradeManagement = async (parentDiv) => {
            parentDiv.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Grade Management</h3>
                    
                    <div class="mb-6 p-4 border border-gray-200 rounded-md bg-gray-50">
                        <h4 class="text-lg font-semibold mb-3 text-gray-700">Add New Grade</h4>
                        <form id="add-grade-form" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <input type="text" id="new-grade-index" placeholder="Student Index Number" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                            <input type="text" id="new-grade-course" placeholder="Course Code" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                            <input type="text" id="new-grade-semester" placeholder="Semester Name" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                            <input type="text" id="new-grade-year" placeholder="Academic Year (e.g., 2023/2024)" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                            <input type="number" step="0.1" min="0" max="100" id="new-grade-score" placeholder="Score (0-100)" class="col-span-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                            <button type="submit" id="add-grade-button" class="col-span-full bg-green-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-green-700 disabled:opacity-50">
                                Add Grade
                            </button>
                        </form>
                        <p id="add-grade-message" class="mt-3 text-center text-sm"></p>
                        <p id="add-grade-error" class="mt-3 text-center text-sm"></p>
                    </div>

                    <div class="mb-6 flex justify-between items-center">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-700">Student Grades Overview</h4>
                            <p class="text-sm text-gray-500 mt-1">Organized by student with GPA calculations and expandable details</p>
                        </div>
                        <button id="load-all-grades-button" class="bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700 disabled:opacity-50">
                            Load Student Grades
                        </button>
                    </div>
                    <p id="grade-list-loading" class="text-center text-gray-600 py-6 hidden">Loading student grades...</p>
                    <p id="grade-list-error" class="text-red-600 text-center py-6 hidden"></p>
                    <div id="grade-list-container" class="rounded-md">
                        <div class="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">No grades loaded</h3>
                            <p class="mt-1 text-sm text-gray-500">Click "Load Student Grades" to view student performance data.</p>
                        </div>
                    </div>
                </div>
            `;
            const addGradeForm = document.getElementById('add-grade-form');
            const addGradeButton = document.getElementById('add-grade-button');
            const addGradeMessage = document.getElementById('add-grade-message');
            const addGradeError = document.getElementById('add-grade-error');
            const loadAllGradesButton = document.getElementById('load-all-grades-button');
            const gradeListContainer = document.getElementById('grade-list-container');
            const gradeListLoading = document.getElementById('grade-list-loading');
            const gradeListError = document.getElementById('grade-list-error');

            const fetchAndRenderGrades = async () => {
                gradeListLoading.classList.remove('hidden');
                gradeListError.classList.add('hidden');
                gradeListContainer.innerHTML = '';
                try {
                    const data = await api.getAllGrades();
                    if (data.success) {
                        if (data.data.grades.length === 0) {
                            gradeListContainer.innerHTML = `<p class="text-gray-600 text-center py-6">No grades found.</p>`;
                        } else {
                            renderStudentCentricGrades(data.data.grades);
                        }
                    } else {
                        gradeListError.textContent = data.message || 'Failed to fetch grades.';
                        gradeListError.classList.remove('hidden');
                    }
                } catch (error) {
                    gradeListError.textContent = error.message || 'An error occurred while fetching grades.';
                    gradeListError.classList.remove('hidden');
                } finally {
                    gradeListLoading.classList.add('hidden');
                }
            };

            const renderStudentCentricGrades = (grades) => {
                // Group grades by student
                const studentGrades = {};
                grades.forEach(grade => {
                    if (!studentGrades[grade.student_index]) {
                        studentGrades[grade.student_index] = {
                            student_name: grade.student_name || grade.student_index,
                            grades: [],
                            totalCredits: 0,
                            totalPoints: 0
                        };
                    }
                    studentGrades[grade.student_index].grades.push(grade);
                    // Calculate GPA (assuming credit hours of 3 for each course for now)
                    const creditHours = grade.credit_hours || 3;
                    studentGrades[grade.student_index].totalCredits += creditHours;
                    studentGrades[grade.student_index].totalPoints += (grade.grade_point * creditHours);
                });

                // Simple search interface
                let html = `
                    <div class="mb-4">
                        <input type="text" id="student-search" placeholder="Search students by index or name..." 
                               class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="students-container" class="space-y-4">
                `;

                // Create student cards
                Object.entries(studentGrades).forEach(([studentIndex, studentData]) => {
                    const gpa = studentData.totalCredits > 0 ? (studentData.totalPoints / studentData.totalCredits).toFixed(2) : '0.00';
                    const gradeCount = studentData.grades.length;
                    
                    // Get latest semester info
                    const latestGrade = studentData.grades.sort((a, b) => 
                        new Date(b.academic_year) - new Date(a.academic_year))[0];
                    
                    html += `
                        <div class="student-card bg-white border border-gray-200 rounded-lg p-4" 
                             data-student="${studentIndex}" data-student-name="${studentData.student_name}">
                            <div class="cursor-pointer student-header" onclick="toggleStudentDetails('${studentIndex}')">
                                <div class="flex justify-between items-center">
                                    <div class="flex-1">
                                        <h3 class="text-lg font-medium text-gray-900">${studentIndex}</h3>
                                        <p class="text-sm text-gray-600">${studentData.student_name}</p>
                                    </div>
                                    <div class="flex items-center space-x-4">
                                        <div class="text-center">
                                            <div class="text-xl font-bold ${getGpaColor(gpa)}">${gpa}</div>
                                            <div class="text-xs text-gray-500">GPA</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-lg font-medium text-gray-700">${gradeCount}</div>
                                            <div class="text-xs text-gray-500">Courses</div>
                                        </div>
                                        <svg class="w-5 h-5 text-gray-400 expand-icon-${studentIndex}" 
                                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            <div id="details-${studentIndex}" class="student-details hidden border-t border-gray-100">
                                <div class="p-4">
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Course</th>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Semester</th>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Year</th>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Grade</th>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white">
                `;
                
                // Sort grades by semester and year
                studentData.grades.sort((a, b) => {
                    if (a.academic_year !== b.academic_year) {
                        return b.academic_year.localeCompare(a.academic_year);
                    }
                    return a.semester_name.localeCompare(b.semester_name);
                }).forEach(grade => {
                    html += `
                                                <tr class="border-t border-gray-100">
                                                    <td class="px-3 py-2 font-medium text-gray-900">${grade.course_code}</td>
                                                    <td class="px-3 py-2 text-gray-600">${grade.semester_name}</td>
                                                    <td class="px-3 py-2 text-gray-600">${grade.academic_year}</td>
                                                    <td class="px-3 py-2">
                                                        <span class="px-2 py-1 rounded text-xs font-medium ${getGradeBadgeColor(grade.grade)}">
                                                            ${grade.grade}
                                                        </span>
                                                    </td>
                                                    <td class="px-3 py-2">
                                                        <button data-action="edit" data-id="${grade.grade_id}" 
                                                                data-course-code="${grade.course_code}"
                                                                data-semester="${grade.semester_name}"
                                                                data-year="${grade.academic_year}"
                                                                data-score="${grade.score}"
                                                                class="text-blue-600 hover:text-blue-800 text-xs mr-2">Edit</button>
                                                        <button data-action="delete" data-id="${grade.grade_id}" 
                                                                class="text-red-600 hover:text-red-800 text-xs">Delete</button>
                                                    </td>
                                                </tr>
                    `;
                });

                html += `
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
                gradeListContainer.innerHTML = html;

                // Setup search functionality
                setupGradeSearch();
            };

            const getGpaColor = (gpa) => {
                const numGpa = parseFloat(gpa);
                if (numGpa >= 3.5) return 'text-green-600';
                if (numGpa >= 3.0) return 'text-blue-600';
                if (numGpa >= 2.5) return 'text-yellow-600';
                return 'text-red-600';
            };

            const getGradeBadgeColor = (grade) => {
                switch(grade.charAt(0)) {
                    case 'A': return 'bg-green-100 text-green-800';
                    case 'B': return 'bg-blue-100 text-blue-800';
                    case 'C': return 'bg-yellow-100 text-yellow-800';
                    case 'D': return 'bg-orange-100 text-orange-800';
                    case 'F': return 'bg-red-100 text-red-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };

            // Grade filtering and search functionality
            const setupGradeSearch = () => {
                // Simple search functionality
                const searchInput = document.getElementById('student-search');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        const studentCards = document.querySelectorAll('.student-card');
                        
                        studentCards.forEach(card => {
                            const studentIndex = card.dataset.student.toLowerCase();
                            const studentName = card.dataset.studentName.toLowerCase();
                            const matches = studentIndex.includes(searchTerm) || studentName.includes(searchTerm);
                            card.style.display = matches ? 'block' : 'none';
                        });
                    });
                }
            };

            // Global function for toggling individual student details
            window.toggleStudentDetails = (studentIndex) => {
                const details = document.getElementById(`details-${studentIndex}`);
                const icon = document.querySelector(`.expand-icon-${studentIndex}`);
                
                if (details.classList.contains('hidden')) {
                    details.classList.remove('hidden');
                    icon.style.transform = 'rotate(180deg)';
                } else {
                    details.classList.add('hidden');
                    icon.style.transform = 'rotate(0deg)';
                }
            };

            addGradeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                addGradeButton.disabled = true;
                displayMessage('add-grade-message', '', 'success');
                displayMessage('add-grade-error', '', 'error');
                const newGrade = {
                    student_index: document.getElementById('new-grade-index').value,
                    course_code: document.getElementById('new-grade-course').value,
                    semester_name: document.getElementById('new-grade-semester').value,
                    academic_year: document.getElementById('new-grade-year').value,
                    score: parseFloat(document.getElementById('new-grade-score').value || 0),
                };
                try {
                    const result = await api.createGrade(newGrade);
                    if (result.success) {
                        displayMessage('add-grade-message', result.message, 'success');
                        addGradeForm.reset();
                        fetchAndRenderGrades();
                    } else {
                        displayMessage('add-grade-error', result.message, 'error');
                    }
                } catch (err) {
                    displayMessage('add-grade-error', err.message, 'error');
                } finally {
                    addGradeButton.disabled = false;
                }
            });
            
            // Toggle functionality for Load All / Hide Grades
            loadAllGradesButton.addEventListener('click', () => {
                if (loadAllGradesButton.textContent.trim() === 'Load Student Grades') {
                    fetchAndRenderGrades();
                    loadAllGradesButton.textContent = 'Hide Grades';
                } else {
                    gradeListContainer.innerHTML = `
                        <div class="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">No grades loaded</h3>
                            <p class="mt-1 text-sm text-gray-500">Click "Load Student Grades" to view student performance data.</p>
                        </div>
                    `;
                    loadAllGradesButton.textContent = 'Load Student Grades';
                }
            });

            // Event listener for grade actions (edit, delete)
            gradeListContainer.addEventListener('click', async (e) => {
                const target = e.target;
                if (target.tagName === 'BUTTON' && target.dataset.action) {
                    const gradeId = target.dataset.id;
                    if (target.dataset.action === 'edit') {
                        const courseCode = target.dataset.courseCode;
                        const semester = target.dataset.semester;
                        const academicYear = target.dataset.year;
                        const score = target.dataset.score;
                        
                        openGradeEditModal(gradeId, courseCode, semester, academicYear, score);
                    } else if (target.dataset.action === 'delete') {
                        openConfirmationModal(
                            'Confirm Deletion',
                            `Are you sure you want to delete this grade record?`,
                            async () => {
                                try {
                                    const result = await api.deleteGrade(gradeId);
                                    if (result.success) {
                                        showToast('Grade deleted successfully!', 'success');
                                        fetchAndRenderGrades();
                                    } else {
                                        showToast(result.message, 'error');
                                    }
                                } catch (err) {
                                    showToast(err.message, 'error');
                                }
                            }
                        );
                    }
                }
            });
        };

        // --- Admin User Management ---
        const renderAdminUserManagement = async (parentDiv) => {
            parentDiv.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold mb-4 text-gray-800">User Management</h3>
                    <p class="text-gray-600 mb-6">Create new admin or student user accounts and reset student passwords.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-4 border border-gray-200 rounded-md bg-gray-50">
                            <h4 class="text-lg font-semibold mb-3 text-gray-700">Create Admin Account</h4>
                            <form id="create-user-form" class="space-y-3">
                                <input type="text" id="new-user-username" placeholder="Username" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                                <input type="password" id="new-user-password" placeholder="Password" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                                <button type="submit" id="create-user-button" class="w-full bg-blue-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-blue-700 disabled:opacity-50">
                                    Create Admin
                                </button>
                            </form>
                            <p id="create-user-message" class="mt-3 text-center text-sm"></p>
                        </div>
                        
                        <div class="p-4 border border-gray-200 rounded-md bg-gray-50">
                            <h4 class="text-lg font-semibold mb-3 text-gray-700">Create Student Account</h4>
                            <p class="text-sm text-gray-500 mb-3">Ensure the student already exists in the student management section.</p>
                            <form id="create-student-account-form" class="space-y-3">
                                <input type="text" id="new-student-account-index" placeholder="Student Index Number" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                                <input type="password" id="new-student-account-password" placeholder="Initial Password" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                                <button type="submit" id="create-student-account-button" class="w-full bg-green-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-green-700 disabled:opacity-50">
                                    Create Student Account
                                </button>
                            </form>
                            <p id="create-student-account-message" class="mt-3 text-center text-sm"></p>
                        </div>

                        <div class="p-4 border border-gray-200 rounded-md bg-gray-50 md:col-span-2">
                            <h4 class="text-lg font-semibold mb-3 text-gray-700">Reset Student Password</h4>
                            <form id="reset-student-password-form" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <input type="text" id="reset-student-index" placeholder="Student Index Number" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                                <input type="password" id="reset-student-password-new" placeholder="New Password" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                                <button type="submit" id="reset-student-password-button" class="col-span-full bg-red-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-red-700 disabled:opacity-50">
                                    Reset Password
                                </button>
                            </form>
                            <p id="reset-student-password-message" class="mt-3 text-center text-sm"></p>
                        </div>
                    </div>
                </div>
            `;
            const createUserForm = document.getElementById('create-user-form');
            const createStudentAccountForm = document.getElementById('create-student-account-form');
            const resetStudentPasswordForm = document.getElementById('reset-student-password-form');
            createUserForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newUser = {
                    username: document.getElementById('new-user-username').value,
                    password: document.getElementById('new-user-password').value
                };
                try {
                    const result = await api.createUserAccount(newUser);
                    displayMessage('create-user-message', result.message);
                } catch (err) {
                    displayMessage('create-user-message', err.message, 'error');
                }
            });
            createStudentAccountForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newAccount = {
                    index_number: document.getElementById('new-student-account-index').value,
                    password: document.getElementById('new-student-account-password').value
                };
                try {
                    const result = await api.createStudentAccount(newAccount);
                    displayMessage('create-student-account-message', result.message);
                } catch (err) {
                    displayMessage('create-student-account-message', err.message, 'error');
                }
            });
            resetStudentPasswordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const resetData = {
                    index_number: document.getElementById('reset-student-index').value,
                    password: document.getElementById('reset-student-password-new').value
                };
                try {
                    const result = await api.resetStudentPassword(resetData);
                    displayMessage('reset-student-password-message', result.message);
                } catch (err) {
                    displayMessage('reset-student-password-message', err.message, 'error');
                }
            });
        };

        // --- Admin Bulk Operations ---
        const renderAdminBulkOperations = async (parentDiv) => {
            parentDiv.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Bulk Operations</h3>
                    <div class="mb-6">
                        <p class="text-gray-700">Use this section to import data in bulk. The system expects a JSON object with keys 'students', 'courses', 'semesters', and 'grades', each containing an array of objects.</p>
                        <a href="#" class="text-blue-600 hover:underline">Download a sample JSON file here.</a>
                    </div>
                    <form id="bulk-import-form" class="space-y-4">
                        <div>
                            <label for="json-input" class="block text-sm font-medium text-gray-700 mb-2">Paste JSON Data:</label>
                            <textarea id="json-input" rows="10" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 font-mono text-sm" placeholder='{"students": [...], "courses": [...], ...}'></textarea>
                        </div>
                        <button type="submit" id="bulk-import-button" class="w-full bg-purple-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-purple-700 disabled:opacity-50">
                            Perform Bulk Import
                        </button>
                        <p id="bulk-import-message" class="mt-3 text-center text-sm"></p>
                    </form>
                </div>
            `;
            const bulkImportForm = document.getElementById('bulk-import-form');
            bulkImportForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const jsonInput = document.getElementById('json-input').value;
                const importButton = document.getElementById('bulk-import-button');
                importButton.disabled = true;
                displayMessage('bulk-import-message', 'Importing data...', 'info');
                try {
                    const data = JSON.parse(jsonInput);
                    const result = await api.bulkImportData(data);
                    displayMessage('bulk-import-message', result.message, 'success');
                } catch (err) {
                    displayMessage('bulk-import-message', err.message, 'error');
                } finally {
                    importButton.disabled = false;
                }
            });
        };
        
        // --- Admin Report Management ---
        const renderAdminReportManagement = async (parentDiv) => {
            parentDiv.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Report Generation</h3>

                    <div class="mb-6 p-4 border border-gray-200 rounded-md bg-gray-50">
                        <h4 class="text-lg font-semibold mb-3 text-gray-700">Summary Report</h4>
                        <div class="flex flex-col md:flex-row gap-4 mb-4">
                            <select id="report-academic-year" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 w-full md:w-1/2">
                                <option value="">All Academic Years</option>
                                </select>
                            <button id="generate-summary-report-button" class="bg-blue-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-blue-700 disabled:opacity-50 w-full md:w-1/2">
                                Generate Summary Report (JSON)
                            </button>
                        </div>
                        <div class="flex flex-col md:flex-row gap-4 mb-4">
                            <button id="download-summary-report-pdf-button" class="w-full bg-green-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-green-700 disabled:opacity-50">
                                Download Summary Report (PDF)
                            </button>
                            <button id="download-summary-report-txt-button" class="w-full bg-blue-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-blue-700 disabled:opacity-50">
                                Download Summary Report (TXT)
                            </button>
                        </div>
                        <p id="report-message" class="mt-3 text-center text-sm"></p>
                        <div id="report-preview" class="mt-4 p-4 bg-white border border-gray-200 rounded-md max-h-96 overflow-y-auto">
                            </div>
                    </div>

                    </div>
            `;
            
            const generateReportButton = document.getElementById('generate-summary-report-button');
            const downloadPdfButton = document.getElementById('download-summary-report-pdf-button');
            const downloadTxtButton = document.getElementById('download-summary-report-txt-button');
            const reportMessage = document.getElementById('report-message');
            const reportPreview = document.getElementById('report-preview');

            const populateAcademicYears = async () => {
                const yearSelect = document.getElementById('report-academic-year');
                yearSelect.innerHTML = '<option value="">All Academic Years</option>';
                const years = new Set(Object.values(semesters_db).map(s => s.academic_year));
                [...years].sort().forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                });
            };

            generateReportButton.addEventListener('click', async () => {
                reportMessage.textContent = 'Generating report...';
                reportMessage.className = 'mt-3 text-center text-sm text-blue-600';
                reportPreview.innerHTML = '';
                generateReportButton.disabled = true;

                const academicYear = document.getElementById('report-academic-year').value;
                const filters = academicYear ? { academic_year: parseInt(academicYear) } : {};

                try {
                    const report = await api.generateSummaryReport(filters);
                    reportMessage.textContent = 'Report generated successfully!';
                    reportMessage.className = 'mt-3 text-center text-sm text-green-600';
                    reportPreview.textContent = JSON.stringify(report.data, null, 2);
                } catch (error) {
                    reportMessage.textContent = `Error: ${error.message}`;
                    reportMessage.className = 'mt-3 text-center text-sm text-red-600';
                } finally {
                    generateReportButton.disabled = false;
                }
            });

            // Event listener for the PDF download button
            downloadPdfButton.addEventListener('click', async () => {
                reportMessage.textContent = 'Preparing PDF for download...';
                reportMessage.className = 'mt-3 text-center text-sm text-blue-600';
                downloadPdfButton.disabled = true;
                downloadTxtButton.disabled = true;

                const academicYear = document.getElementById('report-academic-year').value;
                const filters = academicYear ? { academic_year: parseInt(academicYear) } : {};

                try {
                    await api.downloadSummaryReportPdf(filters);
                    reportMessage.textContent = 'PDF download started. Check your browser downloads.';
                    reportMessage.className = 'mt-3 text-center text-sm text-green-600';
                } catch (error) {
                    reportMessage.textContent = `Error downloading PDF: ${error.message}`;
                    reportMessage.className = 'mt-3 text-center text-sm text-red-600';
                } finally {
                    downloadPdfButton.disabled = false;
                    downloadTxtButton.disabled = false;
                }
            });
            
            // Event listener for the TXT download button
            downloadTxtButton.addEventListener('click', async () => {
                reportMessage.textContent = 'Preparing text report for download...';
                reportMessage.className = 'mt-3 text-center text-sm text-blue-600';
                downloadPdfButton.disabled = true;
                downloadTxtButton.disabled = true;

                const academicYear = document.getElementById('report-academic-year').value;
                const filters = academicYear ? { academic_year: parseInt(academicYear) } : {};

                try {
                    await api.downloadSummaryReportTxt(filters);
                    reportMessage.textContent = 'Text report download started. Check your browser downloads.';
                    reportMessage.className = 'mt-3 text-center text-sm text-green-600';
                } catch (error) {
                    reportMessage.textContent = `Error downloading text report: ${error.message}`;
                    reportMessage.className = 'mt-3 text-center text-sm text-red-600';
                } finally {
                    downloadPdfButton.disabled = false;
                    downloadTxtButton.disabled = false;
                }
            });

            // Initial call to populate years
            populateAcademicYears();
        };

        // --- Admin System Management ---
        const renderAdminSystemManagement = async (parentDiv) => {
            parentDiv.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold mb-4 text-gray-800">System Management</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-4 border border-gray-200 rounded-md bg-gray-50">
                            <h4 class="text-lg font-semibold mb-3 text-gray-700">Initialize Database</h4>
                            <p class="text-sm text-gray-500 mb-3">This will reset and re-create the database schemas. All data will be lost.</p>
                            <button id="init-db-button" class="w-full bg-red-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-red-700 disabled:opacity-50">
                                Initialize System
                            </button>
                            <p id="init-db-message" class="mt-3 text-center text-sm"></p>
                        </div>
                        
                        <div class="p-4 border border-gray-200 rounded-md bg-gray-50">
                            <h4 class="text-lg font-semibold mb-3 text-gray-700">Seed Database with Test Data</h4>
                            <p class="text-sm text-gray-500 mb-3">This will populate the database with a large amount of mock student data.</p>
                            <form id="seed-db-form" class="space-y-3">
                                <input type="number" id="num-students-to-seed" value="100" min="1" max="1000" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="cleanup-first" checked class="form-checkbox h-4 w-4 text-blue-600" />
                                    <label for="cleanup-first" class="text-sm text-gray-700">Clear existing data first</label>
                                </div>
                                <button type="submit" id="seed-db-button" class="w-full bg-purple-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-purple-700 disabled:opacity-50">
                                    Seed Database
                                </button>
                            </form>
                            <p id="seed-db-message" class="mt-3 text-center text-sm"></p>
                        </div>
                    </div>
                </div>
            `;
            const initDbButton = document.getElementById('init-db-button');
            const initDbMessage = document.getElementById('init-db-message');
            const seedDbForm = document.getElementById('seed-db-form');
            const seedDbButton = document.getElementById('seed-db-button');
            const seedDbMessage = document.getElementById('seed-db-message');
            initDbButton.addEventListener('click', async () => {
                initDbButton.disabled = true;
                displayMessage('init-db-message', 'Initializing system...', 'info');
                try {
                    const result = await api.initializeSystem();
                    displayMessage('init-db-message', result.message, 'success');
                } catch (err) {
                    displayMessage('init-db-message', err.message, 'error');
                } finally {
                    initDbButton.disabled = false;
                }
            });
            seedDbForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                seedDbButton.disabled = true;
                displayMessage('seed-db-message', 'Seeding database...', 'info');
                const numStudents = document.getElementById('num-students-to-seed').value;
                const cleanupFirst = document.getElementById('cleanup-first').checked;
                try {
                    const result = await api.seedDatabase(numStudents, cleanupFirst);
                    displayMessage('seed-db-message', result.message, 'success');
                } catch (err) {
                    displayMessage('seed-db-message', err.message, 'error');
                } finally {
                    seedDbButton.disabled = false;
                }
            });
        };

        // --- Student Dashboard ---
        const renderStudentDashboard = async () => {
            appDiv.innerHTML = `
                <header class="bg-gray-800 text-white p-4 shadow-md flex justify-between items-center">
                    <h1 class="text-2xl font-bold">Student Dashboard</h1>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm">Welcome, ${currentUser.username}</span>
                        <button id="logout-button" class="px-3 py-1 bg-red-600 rounded-md text-sm font-medium hover:bg-red-700">Logout</button>
                    </div>
                </header>
                <main class="p-4 sm:p-6 lg:p-8">
                    <div id="student-content" class="bg-white p-6 rounded-lg shadow-sm">
                        <p class="text-center text-gray-600 py-6">Loading student data...</p>
                    </div>
                </main>
            `;

            const studentContentDiv = document.getElementById('student-content');
            const logoutButton = document.getElementById('logout-button');
            logoutButton.addEventListener('click', () => setAuthUser(null));

            try {
                const profileResponse = await api.getStudentProfile();
                const gradesResponse = await api.getStudentGrades();
                const gpaResponse = await api.getStudentGPA();

                if (profileResponse.success && gradesResponse.success && gpaResponse.success) {
                    const studentProfile = profileResponse.data;
                    const studentGrades = gradesResponse.data.grades;
                    const studentGpa = gpaResponse.data.gpa;

                    let gradesTableHtml = `
                        <table class="min-w-full divide-y divide-gray-200 mt-4">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Course Code</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Semester</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Year</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Grade</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Credits</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Grade Point</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                    `;
                    if (studentGrades.length === 0) {
                        gradesTableHtml += `<tr><td colspan="6" class="px-4 py-3 text-center text-gray-500">No grades found.</td></tr>`;
                    } else {
                        studentGrades.forEach(grade => {
                            const course = api.courses_db[grade.course_code];
                            gradesTableHtml += `
                                <tr>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${grade.course_code}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${grade.semester_name}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${grade.academic_year}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${grade.letter_grade}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${course ? course.credits : 'N/A'}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${grade.grade_point}</td>
                                </tr>
                            `;
                        });
                    }
                    gradesTableHtml += `</tbody></table>`;

                    studentContentDiv.innerHTML = `
                        <h3 class="text-xl font-bold mb-4 text-gray-800">Your Profile</h3>
                        <div class="bg-gray-50 p-4 rounded-md shadow-sm mb-6">
                            <p class="text-gray-700"><b>Index Number:</b> ${studentProfile.index_number}</p>
                            <p class="text-gray-700"><b>Full Name:</b> ${studentProfile.name}</p>
                            <p class="text-gray-700"><b>Program:</b> ${studentProfile.program}</p>
                            <p class="text-gray-700"><b>Current Year:</b> ${studentProfile.year_of_study}</p>
                            <p class="text-gray-700"><b>Overall GPA:</b> ${studentGpa}</p>
                        </div>
                        <h4 class="text-lg font-semibold mb-3 text-gray-700">Your Grades</h4>
                        <div class="overflow-x-auto rounded-md border border-gray-200">
                            ${gradesTableHtml}
                        </div>
                        
                        <div class="mt-6">
                            <h4 class="text-lg font-semibold mb-3 text-gray-700">Academic Reports</h4>
                            <div class="flex flex-col md:flex-row gap-4">
                                <button id="download-pdf-report-button" class="bg-green-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-green-700 disabled:opacity-50">
                                    Download Academic Report (PDF)
                                </button>
                                <button id="download-txt-report-button" class="bg-blue-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-blue-700 disabled:opacity-50">
                                    Download Academic Report (TXT)
                                </button>
                            </div>
                            <p id="student-report-message" class="mt-3 text-center text-sm"></p>
                        </div>
                    `;
                    
                    // Add event listeners for report download buttons
                    const downloadPdfButton = document.getElementById('download-pdf-report-button');
                    const downloadTxtButton = document.getElementById('download-txt-report-button');
                    const reportMessage = document.getElementById('student-report-message');
                    
                    downloadPdfButton.addEventListener('click', async () => {
                        reportMessage.textContent = 'Preparing PDF for download...';
                        reportMessage.className = 'mt-3 text-center text-sm text-blue-600';
                        downloadPdfButton.disabled = true;
                        downloadTxtButton.disabled = true;
                        
                        try {
                            await api.downloadPersonalReportPdf();
                            reportMessage.textContent = 'PDF download started. Check your browser downloads.';
                            reportMessage.className = 'mt-3 text-center text-sm text-green-600';
                        } catch (error) {
                            reportMessage.textContent = `Error downloading PDF: ${error.message}`;
                            reportMessage.className = 'mt-3 text-center text-sm text-red-600';
                        } finally {
                            downloadPdfButton.disabled = false;
                            downloadTxtButton.disabled = false;
                        }
                    });
                    
                    downloadTxtButton.addEventListener('click', async () => {
                        reportMessage.textContent = 'Preparing text report for download...';
                        reportMessage.className = 'mt-3 text-center text-sm text-blue-600';
                        downloadPdfButton.disabled = true;
                        downloadTxtButton.disabled = true;
                        
                        try {
                            await api.downloadPersonalReportTxt();
                            reportMessage.textContent = 'Text report download started. Check your browser downloads.';
                            reportMessage.className = 'mt-3 text-center text-sm text-green-600';
                        } catch (error) {
                            reportMessage.textContent = `Error downloading text report: ${error.message}`;
                            reportMessage.className = 'mt-3 text-center text-sm text-red-600';
                        } finally {
                            downloadPdfButton.disabled = false;
                            downloadTxtButton.disabled = false;
                        }
                    });
                } else {
                    studentContentDiv.innerHTML = `<p class="text-red-600 text-center py-6">Error loading student data.</p>`;
                }
            } catch (error) {
                studentContentDiv.innerHTML = `<p class="text-red-600 text-center py-6">An error occurred: ${error.message}</p>`;
            }
        };

        // --- Main App Logic ---
        const renderApp = () => {
            const storedUser = sessionStorage.getItem('srmsUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                if (currentUser.role === 'admin') {
                    renderAdminDashboard();
                } else {
                    renderStudentDashboard();
                }
            } else {
                renderLoginPage();
            }
        };

        window.addEventListener('DOMContentLoaded', renderApp);
    </script>
</body>
</html>