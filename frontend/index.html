<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Result Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <style>
        /* Enhanced Search Interface Styles */
        .search-container {
            background: #3b82f6;
        }
        
        .search-input-group {
            position: relative;
        }
        
        .search-input-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            z-index: 10;
        }
        
        .search-input-with-icon {
            padding-left: 2.75rem;
        }
        
        .search-spinner {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
        }
        
        .advanced-filters-toggle {
            transition: all 0.3s ease;
        }
        
        .advanced-filters-toggle:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        .filter-badge {
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .search-results-summary {
            border-left: 4px solid #10b981;
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
        }
        
        /* Export button hover effect */
        .export-btn {
            position: relative;
            overflow: hidden;
        }
        
        .export-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .export-btn:hover::before {
            left: 100%;
        }
        
        /* Autocomplete Styles */
        .autocomplete-item {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .autocomplete-item:hover,
        .autocomplete-item.highlighted {
            background-color: #f3f4f6;
        }
        
        .autocomplete-item.selected {
            background-color: #dbeafe;
            color: #1d4ed8;
        }
        
        /* Search History Styles */
        .history-item {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .history-item:hover {
            background-color: #f9fafb;
        }
        
        /* Enhanced Animations */
        .slide-down {
            animation: slideDown 0.3s ease;
        }
        
        .slide-up {
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }
        
        .pulse-subtle {
            animation: pulseSubtle 2s infinite;
        }
        
        @keyframes pulseSubtle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Keyboard shortcuts styling */
        kbd {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 3px;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.2), 0 2px 0 0 rgba(255, 255, 255, 0.7) inset;
            color: #374151;
            display: inline-block;
            font-size: 0.75rem;
            font-weight: 700;
            line-height: 1;
            padding: 2px 4px;
            white-space: nowrap;
        }
        
        /* Skeleton Loading Animations */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }
        
        .skeleton-line {
            height: 16px;
            margin-bottom: 8px;
        }
        
        .skeleton-line.short {
            width: 60%;
        }
        
        .skeleton-line.medium {
            width: 80%;
        }
        
        .skeleton-line.long {
            width: 100%;
        }
        
        .skeleton-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
        }
        
        /* Enhanced Transitions */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .fade-out {
            animation: fadeOut 0.3s ease-in-out;
        }
        
        .scale-in {
            animation: scaleIn 0.3s ease-out;
        }
        
        .slide-in-left {
            animation: slideInLeft 0.4s ease-out;
        }
        
        .slide-in-right {
            animation: slideInRight 0.4s ease-out;
        }
        
        /* Enhanced Student Card Hover Effects */
        .student-card {
            transform: translateY(0);
            border-color: #e5e7eb;
        }
        
        .student-card:hover {
            transform: translateY(-2px);
            border-color: #d1d5db;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Quick Action Button Animations */
        .quick-action-btn {
            transform: scale(0.8);
            opacity: 0;
            transition: all 0.2s ease;
        }
        
        .student-card:hover .quick-action-btn {
            transform: scale(1);
            opacity: 1;
        }
        
        .quick-action-btn:hover {
            transform: scale(1.1);
        }
        
        /* Checkbox fade-in effect */
        .student-card .bulk-checkbox {
            transition: opacity 0.2s ease;
        }
        
        /* Avatar pulse effect on hover */
        .student-card:hover .w-14.h-14 {
            animation: avatarPulse 2s infinite;
        }
        
        @keyframes avatarPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* Micro-interactions */
        .hover-lift {
            transition: all 0.2s ease;
        }
        
        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .button-press {
            transition: all 0.1s ease;
        }
        
        .button-press:active {
            transform: scale(0.98);
        }
        
        /* Progress Indicators */
        .progress-bar {
            background: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
            height: 8px;
        }
        
        .progress-fill {
            background: #3b82f6;
            height: 100%;
            border-radius: 9999px;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: progressShine 2s infinite;
        }
        
        @keyframes progressShine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        /* Loading States */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mobile & Tablet Responsive Design */
        @media (max-width: 768px) {
            /* Mobile-specific adjustments */
            .student-card, .course-card, .grade-card {
                margin-bottom: 1rem;
                padding: 1rem;
            }
            
            /* Touch-friendly buttons */
            button {
                min-height: 44px;
                min-width: 44px;
                padding: 12px 16px;
            }
            
            /* Search interface mobile optimization */
            .search-container {
                padding: 1rem;
                margin: 0 -1rem;
            }
            
            /* Autocomplete dropdown mobile adjustments */
            #search-autocomplete {
                left: -1rem;
                right: -1rem;
                max-height: 40vh;
            }
            
            /* Mobile navigation */
            .navigation-tabs {
                overflow-x: auto;
                /* Hide scrollbar for better compatibility */
                -ms-overflow-style: none;
            }
            
            .navigation-tabs::-webkit-scrollbar {
                display: none;
            }
            
            /* Mobile grid adjustments */
            .grid-responsive {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            /* Mobile forms */
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            /* Mobile modals */
            .modal-content {
                margin: 1rem;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            /* Hide desktop-only elements */
            .desktop-only {
                display: none !important;
            }
            
            /* Show mobile-only elements */
            .mobile-only {
                display: block !important;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            /* Tablet-specific adjustments */
            .grid-responsive {
                grid-template-columns: repeat(2, 1fr);
            }
            
            /* Tablet search interface */
            .search-container {
                padding: 1.5rem;
            }
        }
        
        @media (min-width: 1025px) {
            /* Desktop adjustments */
            .grid-responsive {
                grid-template-columns: repeat(3, 1fr);
            }
            
            /* Hide mobile-only elements */
            .mobile-only {
                display: none !important;
            }
        }
        
        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            /* Touch-specific hover states */
            .hover-lift:hover {
                transform: none;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
            
            /* Larger touch targets */
            .touch-target {
                min-height: 48px;
                min-width: 48px;
            }
            
            /* Remove hover animations on touch devices */
            .hover-animation {
                transition: none;
            }
        }
        
        /* Swipe gestures support */
        .swipeable {
            touch-action: pan-x;
            /* Touch scrolling optimization */
        }
        
        .mobile-scroll::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        .mobile-scroll::-webkit-scrollbar-track {
            background: #f7fafc;
        }
        
        .mobile-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }
        
        /* Bulk Operations Styles */
        #bulk-operations-panel.active {
            opacity: 1;
        }
        
        .bulk-action-btn-new {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            background: white;
            color: #6b7280;
            transition: all 0.2s ease;
            cursor: not-allowed;
        }
        
        .bulk-action-btn-new:enabled {
            cursor: pointer;
            color: #374151;
            border-color: #9ca3af;
        }
        
        .bulk-action-btn-new:enabled:hover {
            background: #f9fafb;
            border-color: #6b7280;
        }
        
        .bulk-action-btn-new.export:enabled:hover {
            background: #ecfdf5;
            border-color: #10b981;
            color: #059669;
        }
        
        .bulk-action-btn-new.edit:enabled:hover {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #2563eb;
        }
        
        .bulk-action-btn-new.delete:enabled:hover {
            background: #fef2f2;
            border-color: #ef4444;
            color: #dc2626;
        }
        
        .bulk-checkbox {
            position: relative;
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .bulk-checkbox:checked {
            background: #3b82f6;
            border-color: #3b82f6;
        }
        
        .bulk-checkbox:checked::before {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .bulk-checkbox:hover {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .select-all-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #6b7280;
        }
        
        .select-all-checkbox:checked {
            background: #1f2937;
            border-color: #1f2937;
        }
        
        /* Batch Progress Indicator */
        .batch-progress {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            z-index: 100;
            min-width: 320px;
            max-width: 90vw;
        }
        
        .batch-progress-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
        }
        
        .progress-step {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            border-left: 3px solid #e5e7eb;
            padding-left: 1rem;
            margin-left: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .progress-step.active {
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.05);
        }
        
        .progress-step.completed {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.05);
        }
        
        .progress-step.error {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.05);
        }
        
        /* Selection Counter */
        .selection-counter {
            background: #3b82f6;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* Autocomplete Styles */
        .autocomplete-item {
            transition: all 0.2s ease;
        }
        
        .autocomplete-item:hover,
        .autocomplete-item.highlighted {
            background-color: #f3f4f6;
        }
        
        .autocomplete-item.selected {
            background-color: #dbeafe;
            color: #1d4ed8;
        }
        
        /* Search History Styles */
        .history-item {
            transition: all 0.2s ease;
        }
        
        .history-item:hover {
            background-color: #f9fafb;
        }
        
        /* Enhanced Animations */
        .slide-down {
            animation: slideDown 0.3s ease;
        }
        
        .slide-up {
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }
        
        .pulse-subtle {
            animation: pulseSubtle 2s infinite;
        }
        
        @keyframes pulseSubtle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Analytics Dashboard Styles */
        .analytics-toggle {
            margin-left: 1rem;
            padding: 0.5rem 1rem;
            background-color: #2563eb;
            color: white;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }
        
        .analytics-toggle:hover {
            background-color: #1d4ed8;
        }
        
        .analytics-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 60;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            padding: 2rem;
            overflow-y: auto;
        }
        
        .analytics-panel.show {
            opacity: 1;
            pointer-events: all;
        }
        
        .analytics-panel > div {
            background: white;
            border-radius: 1rem;
            max-width: 1400px;
            margin: 0 auto;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        
        .analytics-panel.show > div {
            transform: translateY(0);
        }
        
        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .close-analytics {
            padding: 0.5rem;
            color: #6b7280;
            border-radius: 0.5rem;
            transition: all 0.2s;
            border: none;
            background: none;
            cursor: pointer;
        }
        
        .close-analytics:hover {
            color: #374151;
            background-color: #f3f4f6;
        }
        
        .analytics-content {
            padding: 1.5rem;
        }
        
        .analytics-grid {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        
        @media (min-width: 768px) {
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .summary-cards {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .summary-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: box-shadow 0.2s;
        }
        
        .summary-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .summary-card .summary-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }
        
        .summary-value {
            font-size: 1.875rem;
            font-weight: bold;
            color: #111827;
        }
        
        .summary-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        
        @media (min-width: 1024px) {
            .charts-section {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .chart-container {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        
        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .chart-canvas {
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .chart-loading, .chart-error {
            text-align: center;
            color: #6b7280;
            padding: 3rem 0;
        }
        
        .chart-error {
            color: #ef4444;
        }
        
        /* Bar Chart Styles */
        .bar-item {
            margin-bottom: 1rem;
        }
        
        .bar-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .bar-container {
            position: relative;
            background-color: #e5e7eb;
            border-radius: 9999px;
            height: 2rem;
            display: flex;
            align-items: center;
        }
        
        .bar-fill {
            background-color: #3b82f6;
            height: 100%;
            border-radius: 9999px;
            transition: all 0.5s;
            position: relative;
        }
        
        .bar-fill.gpa-bar {
            background-color: #10b981;
        }
        
        .bar-value {
            position: absolute;
            right: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #374151;
        }
        
        /* Line Chart Styles */
        .line-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 16rem;
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
        }
        
        .line-point {
            flex: 1;
            background-color: #3b82f6;
            border-radius: 0.375rem 0.375rem 0 0;
            margin: 0 0.25rem;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            transition: all 0.3s;
            min-height: 20px;
            cursor: pointer;
        }
        
        .line-point:hover {
            background-color: #2563eb;
        }
        
        .point-value {
            position: absolute;
            top: -2rem;
            background-color: #1f2937;
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .line-point:hover .point-value {
            opacity: 1;
        }
        
        .point-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.5rem;
            text-align: center;
        }
        
        /* Pie Chart Styles */
        .pie-chart {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .pie-segment {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        
        .pie-segment:hover {
            background-color: #f9fafb;
        }
        
        .pie-color {
            width: 1rem;
            height: 1rem;
            border-radius: 9999px;
        }
        
        .pie-label {
            flex: 1;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }
        
        .pie-value {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        /* Mobile Analytics Adjustments */
        @media (max-width: 768px) {
            .analytics-panel {
                padding: 1rem;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .analytics-toggle {
                margin-left: 0;
                margin-top: 0.5rem;
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div id="app" class="flex-grow">
        </div>

    <div id="modal-overlay" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 modal-overlay hidden">
        <div id="modal-content" class="bg-white p-6 sm:p-8 rounded-lg shadow-lg max-w-lg w-full mx-auto modal-content">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800"></h3>
                <button id="modal-close-btn" class="text-gray-500 hover:text-gray-700 text-2xl font-bold leading-none">&times;</button>
            </div>
            <div id="modal-body">
                </div>
        </div>
    </div>

    <div id="confirmation-modal-overlay" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 modal-overlay hidden">
        <div id="confirmation-modal-content" class="bg-white p-6 sm:p-8 rounded-lg shadow-lg max-w-lg w-full mx-auto modal-content">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 id="confirmation-modal-title" class="text-xl font-bold text-gray-800"></h3>
                <button id="confirmation-modal-close-btn" class="text-gray-500 hover:text-gray-700 text-2xl font-bold leading-none">&times;</button>
            </div>
            <div id="confirmation-modal-body" class="text-gray-700 mb-6">
                </div>
            <div class="flex justify-end space-x-2">
                <button id="confirmation-modal-cancel-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 font-semibold">
                    Cancel
                </button>
                <button id="confirmation-modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 font-semibold">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Global Loading Spinner (singleton) -->
    <div id="loading-spinner" class="loading-spinner" aria-hidden="true" role="status">
        <div class="spinner" aria-label="Loading"></div>
    </div>

    <script>
        // Constants
        const API_BASE_URL = 'http://127.0.0.1:8000';
        const appDiv = document.getElementById('app');

        // Toast Notification System
        const showToast = (message, type = 'info', duration = 4000) => {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; color: white; font-size: 18px; margin-left: 10px; cursor: pointer;"
                            aria-label="Close notification">&times;</button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto remove
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        };

        // Loading Spinner Management
        // Delegated to helpers.js (reference-counted).
        // A small module script at the end of body binds window.showLoading/hideLoading.

        // Authentication State Management
        let currentUser = null;

        const setAuthUser = (user) => {
            currentUser = user;
            if (user) {
                sessionStorage.setItem('srmsUser', JSON.stringify(user));
                console.log('User authenticated:', user); // Debug log
            } else {
                console.log('User logged out'); // Debug log
                clearAuthData();
            }
            renderApp(); // Re-render the app based on new auth state
        };

        const getAuthUser = () => currentUser;
        const isAuthenticated = () => currentUser !== null;

        const getAuthHeader = () => {
            const storedAuth = sessionStorage.getItem('srmsAuth');
            if (storedAuth) {
                const { username, password } = JSON.parse(storedAuth);
                return 'Basic ' + btoa(`${username}:${password}`);
            }
            return '';
        };

    // --- Virtual Scrolling Component for Large Datasets ---
        class VirtualScrollManager {
            constructor(container, itemHeight = 120, bufferSize = 5) {
                this.container = container;
                this.itemHeight = itemHeight;
                this.bufferSize = bufferSize;
                this.totalItems = 0;
                this.visibleItems = [];
                this.startIndex = 0;
                this.endIndex = 0;
                this.containerHeight = 0;
                this.scrollTop = 0;
                
                this.setupContainer();
                this.attachScrollListener();
            }

            setupContainer() {
                this.container.style.position = 'relative';
                this.container.style.overflow = 'auto';
                this.container.style.height = '600px'; // Default height
                
                this.viewport = document.createElement('div');
                this.viewport.style.position = 'relative';
                this.container.appendChild(this.viewport);
                
                this.updateContainerHeight();
            }

            updateContainerHeight() {
                this.containerHeight = this.container.clientHeight;
                this.visibleCount = Math.ceil(this.containerHeight / this.itemHeight) + (this.bufferSize * 2);
            }

            attachScrollListener() {
                this.container.addEventListener('scroll', () => {
                    this.scrollTop = this.container.scrollTop;
                    this.updateVisibleRange();
                });

                // Handle resize
                window.addEventListener('resize', () => {
                    this.updateContainerHeight();
                    this.updateVisibleRange();
                });
            }

            setData(items) {
                this.totalItems = items.length;
                this.allItems = items;
                this.viewport.style.height = `${this.totalItems * this.itemHeight}px`;
                this.updateVisibleRange();
            }

            updateVisibleRange() {
                const newStartIndex = Math.max(0, Math.floor(this.scrollTop / this.itemHeight) - this.bufferSize);
                const newEndIndex = Math.min(this.totalItems - 1, newStartIndex + this.visibleCount - 1);

                if (newStartIndex !== this.startIndex || newEndIndex !== this.endIndex) {
                    this.startIndex = newStartIndex;
                    this.endIndex = newEndIndex;
                    this.renderVisibleItems();
                }
            }

            renderVisibleItems() {
                if (!this.allItems) return;

                this.visibleItems = this.allItems.slice(this.startIndex, this.endIndex + 1);
                
                // Clear existing content
                while (this.viewport.firstChild) {
                    this.viewport.removeChild(this.viewport.firstChild);
                }

                // Create spacer for items above viewport
                if (this.startIndex > 0) {
                    const topSpacer = document.createElement('div');
                    topSpacer.style.height = `${this.startIndex * this.itemHeight}px`;
                    this.viewport.appendChild(topSpacer);
                }

                // Render visible items
                const itemsContainer = document.createElement('div');
                this.visibleItems.forEach((item, index) => {
                    const actualIndex = this.startIndex + index;
                    const itemElement = this.renderItem(item, actualIndex);
                    itemsContainer.appendChild(itemElement);
                });
                this.viewport.appendChild(itemsContainer);

                // Create spacer for items below viewport
                const remainingItems = this.totalItems - this.endIndex - 1;
                if (remainingItems > 0) {
                    const bottomSpacer = document.createElement('div');
                    bottomSpacer.style.height = `${remainingItems * this.itemHeight}px`;
                    this.viewport.appendChild(bottomSpacer);
                }
            }

            renderItem(item, index) {
                // This should be overridden by the implementing class
                const div = document.createElement('div');
                div.style.height = `${this.itemHeight}px`;
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.textContent = `Item ${index}: ${JSON.stringify(item)}`;
                return div;
            }

            scrollToIndex(index) {
                const scrollTop = Math.max(0, (index - this.bufferSize) * this.itemHeight);
                this.container.scrollTop = scrollTop;
            }

            destroy() {
                this.container.removeEventListener('scroll', this.updateVisibleRange);
                window.removeEventListener('resize', this.updateContainerHeight);
            }
        }

        // --- Enhanced Student Virtual Scroll Implementation ---
        class StudentVirtualScroll extends VirtualScrollManager {
            constructor(container, onEdit, onDelete) {
                super(container, 140, 3); // 140px height per student card
                this.onEdit = onEdit;
                this.onDelete = onDelete;
            }

            renderItem(student, index) {
                const div = document.createElement('div');
                div.className = 'student-card bg-white border border-gray-200 rounded-lg p-4 mb-2';
                div.style.height = `${this.itemHeight - 8}px`; // Account for margin
                div.dataset.studentName = student.full_name;
                div.dataset.studentIndex = student.index_number;

                const initials = student.full_name 
                    ? student.full_name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase()
                    : student.index_number.substring(0, 2).toUpperCase();

                div.innerHTML = `
                    <div class="flex justify-between items-start h-full">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0 w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-medium text-sm">
                                    ${initials}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h4 class="student-name text-lg font-medium text-gray-900 truncate">${student.full_name}</h4>
                                    <p class="text-sm text-gray-600 truncate">${student.index_number}</p>
                                </div>
                            </div>
                            <div class="mt-2 grid grid-cols-2 gap-2 text-sm text-gray-600">
                                <p class="student-email truncate">${student.contact_email || 'No email'}</p>
                                <p class="student-course truncate">Course: ${student.program || 'N/A'}</p>
                                <p class="student-semester">Year: ${student.year_of_study || 'N/A'}</p>
                                <div class="flex space-x-1">
                                    <button data-action="edit" data-index="${student.index_number}" 
                                            class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors">
                                        Edit
                                    </button>
                                    <button data-action="delete" data-index="${student.index_number}" 
                                            class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition-colors">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Add click handlers
                div.addEventListener('click', (e) => {
                    const target = e.target;
                    if (target.tagName === 'BUTTON' && target.dataset.action) {
                        const indexNumber = target.dataset.index;
                        if (target.dataset.action === 'edit') {
                            this.onEdit(student, indexNumber);
                        } else if (target.dataset.action === 'delete') {
                            this.onDelete(student, indexNumber);
                        }
                    }
                });

                return div;
            }
        }

        // --- Infinite Scroll Pagination (Alternative to traditional pagination) ---
        class InfiniteScrollManager {
            constructor(container, paginationManager, renderCallback) {
                this.container = container;
                this.paginationManager = paginationManager;
                this.renderCallback = renderCallback;
                this.loading = false;
                this.allData = [];
                this.observer = null;
                
                this.setupIntersectionObserver();
            }

            setupIntersectionObserver() {
                const options = {
                    root: this.container,
                    rootMargin: '50px',
                    threshold: 0.1
                };

                this.observer = new IntersectionObserver(async (entries) => {
                    const entry = entries[0];
                    if (entry.isIntersecting && !this.loading && this.paginationManager.hasNextPage) {
                        await this.loadNextPage();
                    }
                }, options);
            }

            async loadNextPage() {
                if (this.loading) return;
                
                this.loading = true;
                this.showLoadingIndicator();
                
                try {
                    const data = await this.paginationManager.nextPage();
                    if (data && data.records) {
                        this.allData.push(...data.records);
                        this.renderCallback(this.allData, false); // false = don't replace, append
                        this.updateLoadingTrigger();
                    }
                } catch (error) {
                    showToast('Failed to load more data: ' + error.message, 'error');
                } finally {
                    this.loading = false;
                    this.hideLoadingIndicator();
                }
            }

            async reset() {
                this.allData = [];
                this.paginationManager.currentPage = 1;
                
                try {
                    const data = await this.paginationManager.goToPage(1);
                    if (data && data.records) {
                        this.allData = [...data.records];
                        this.renderCallback(this.allData, true); // true = replace existing
                        this.updateLoadingTrigger();
                    }
                } catch (error) {
                    showToast('Failed to load data: ' + error.message, 'error');
                }
            }

            updateLoadingTrigger() {
                // Remove existing trigger
                const existingTrigger = this.container.querySelector('.infinite-scroll-trigger');
                if (existingTrigger) {
                    this.observer.unobserve(existingTrigger);
                    existingTrigger.remove();
                }

                // Add new trigger if more pages available
                if (this.paginationManager.hasNextPage) {
                    const trigger = document.createElement('div');
                    trigger.className = 'infinite-scroll-trigger h-10 flex items-center justify-center';
                    trigger.innerHTML = '<div class="text-gray-500 text-sm">Loading more...</div>';
                    this.container.appendChild(trigger);
                    this.observer.observe(trigger);
                }
            }

            showLoadingIndicator() {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'infinite-scroll-loading flex items-center justify-center py-4';
                loadingDiv.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <div class="spinner w-5 h-5"></div>
                        <span class="text-gray-600">Loading more results...</span>
                    </div>
                `;
                this.container.appendChild(loadingDiv);
            }

            hideLoadingIndicator() {
                const loadingDiv = this.container.querySelector('.infinite-scroll-loading');
                if (loadingDiv) {
                    loadingDiv.remove();
                }
            }

            destroy() {
                if (this.observer) {
                    this.observer.disconnect();
                }
            }
        }

        // --- Debounced Search Component ---
        class DebouncedSearch {
            constructor(searchCallback, debounceMs = 300) {
                this.searchCallback = searchCallback;
                this.debounceMs = debounceMs;
                this.searchTimer = null;
                this.lastSearchTerm = '';
                this.isSearching = false;
            }

            search(searchTerm, filters = {}) {
                // Don't search if the term hasn't changed
                if (searchTerm === this.lastSearchTerm && !Object.keys(filters).length) {
                    return;
                }

                clearTimeout(this.searchTimer);
                
                this.searchTimer = setTimeout(async () => {
                    this.lastSearchTerm = searchTerm;
                    this.isSearching = true;
                    
                    try {
                        await this.searchCallback(searchTerm, filters);
                    } catch (error) {
                        console.error('Search failed:', error);
                        showToast('Search failed: ' + error.message, 'error');
                    } finally {
                        this.isSearching = false;
                    }
                }, this.debounceMs);
            }

            clearSearch() {
                clearTimeout(this.searchTimer);
                this.lastSearchTerm = '';
                this.isSearching = false;
            }

            destroy() {
                this.clearSearch();
            }
        }

        // --- Accessibility and Keyboard Navigation Enhancement ---
        class AccessibilityManager {
            constructor() {
                this.focusableElements = [
                    'button:not([disabled])',
                    'input:not([disabled])',
                    'select:not([disabled])',
                    'textarea:not([disabled])',
                    '[tabindex]:not([tabindex="-1"])',
                    'a[href]'
                ];
                this.setupGlobalKeyboardHandlers();
            }

            setupGlobalKeyboardHandlers() {
                document.addEventListener('keydown', (e) => {
                    // Handle global keyboard shortcuts
                    if (e.ctrlKey || e.metaKey) {
                        switch (e.key) {
                            case 'f':
                                e.preventDefault();
                                this.focusSearch();
                                break;
                            case 'n':
                                if (e.shiftKey) {
                                    e.preventDefault();
                                    this.navigateToNextPage();
                                }
                                break;
                            case 'p':
                                if (e.shiftKey) {
                                    e.preventDefault();
                                    this.navigateToPrevPage();
                                }
                                break;
                        }
                    }

                    // Handle escape key
                    if (e.key === 'Escape') {
                        this.closeModals();
                    }
                });
            }

            focusSearch() {
                const searchInput = document.querySelector('#search-term');
                if (searchInput) {
                    searchInput.focus();
                    searchInput.select();
                }
            }

            navigateToNextPage() {
                if (studentPaginationManager?.hasNextPage) {
                    studentPaginationManager.nextPage();
                }
            }

            navigateToPrevPage() {
                if (studentPaginationManager?.hasPrevPage) {
                    studentPaginationManager.prevPage();
                }
            }

            closeModals() {
                // Close any open modals
                if (!modalOverlay.classList.contains('hidden')) {
                    closeModal();
                }
                if (!confirmModalOverlay.classList.contains('hidden')) {
                    closeConfirmationModal();
                }
            }

            announceToScreenReader(message, priority = 'polite') {
                const announcement = document.createElement('div');
                announcement.setAttribute('aria-live', priority);
                announcement.setAttribute('aria-atomic', 'true');
                announcement.className = 'sr-only';
                announcement.textContent = message;
                
                document.body.appendChild(announcement);
                
                setTimeout(() => {
                    document.body.removeChild(announcement);
                }, 1000);
            }

            updatePageInfo(currentPage, totalPages, totalRecords) {
                const pageInfo = document.getElementById('pagination-page-info');
                if (pageInfo) {
                    pageInfo.setAttribute('aria-label', 
                        `Page ${currentPage} of ${totalPages}, showing results from ${totalRecords} total records`
                    );
                }
            }
        }

        // Initialize accessibility manager
        const accessibilityManager = new AccessibilityManager();

        // --- Enhanced Search Interface Component ---
        class EnhancedSearchInterface {
            constructor(container, paginationManager, onSearchChange) {
                this.container = container;
                this.paginationManager = paginationManager;
                this.onSearchChange = onSearchChange;
                this.debouncedSearch = new DebouncedSearch((term, filters) => {
                    return this.performSearch(term, filters);
                }, 300);
                
                this.filters = {};
                this.searchTerm = '';
                
                this.render();
                this.attachEventListeners();
            }

            render() {
                this.container.innerHTML = `
                    <div class="bg-white p-4 md:p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <!-- Search Term Input -->
                            <div class="col-span-1 md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                                <div class="relative">
                                    <input type="text" 
                                           id="search-term" 
                                           placeholder="Search by name, index number, or email..."
                                           class="w-full pl-10 pr-4 py-3 md:py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-base touch-target">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                        </svg>
                                    </div>
                                    <div id="search-loading" class="absolute inset-y-0 right-0 pr-3 flex items-center hidden">
                                        <div class="animate-spin h-4 w-4 border-2 border-blue-500 border-t-transparent rounded-full"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Program Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Program</label>
                                <select id="program-filter" class="w-full py-2 px-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">All Programs</option>
                                </select>
                            </div>

                            <!-- Year Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Year of Study</label>
                                <select id="year-filter" class="w-full py-2 px-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">All Years</option>
                                    <option value="1">Year 1</option>
                                    <option value="2">Year 2</option>
                                    <option value="3">Year 3</option>
                                    <option value="4">Year 4</option>
                                    <option value="5">Year 5</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Gender Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Gender</label>
                                <select id="gender-filter" class="w-full py-2 px-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">All Genders</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>

                            <!-- Sort Options -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                                <select id="sort-filter" class="w-full py-2 px-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                    <option value="name_asc">Name (A-Z)</option>
                                    <option value="name_desc">Name (Z-A)</option>
                                    <option value="index_asc">Index Number (A-Z)</option>
                                    <option value="index_desc">Index Number (Z-A)</option>
                                    <option value="program_asc">Program (A-Z)</option>
                                    <option value="year_asc">Year (1-4)</option>
                                </select>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex items-end space-x-2">
                                <button id="clear-filters" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 flex-1">
                                    Clear
                                </button>
                                <button id="advanced-search" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 flex-1">
                                    Advanced
                                </button>
                            </div>
                        </div>

                        <!-- Search Results Summary -->
                        <div id="search-summary" class="mt-4 text-sm text-gray-600 hidden">
                            <div class="flex items-center justify-between">
                                <span id="search-results-text"></span>
                                <div class="flex items-center space-x-2">
                                    <span>View:</span>
                                    <button id="view-grid" class="p-1 rounded text-blue-600 hover:bg-blue-50" title="Grid View">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                                        </svg>
                                    </button>
                                    <button id="view-table" class="p-1 rounded text-gray-400 hover:bg-gray-50" title="Table View">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm0 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V8zm0 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2z" clip-rule="evenodd"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            attachEventListeners() {
                const searchInput = this.container.querySelector('#search-term');
                const programFilter = this.container.querySelector('#program-filter');
                const yearFilter = this.container.querySelector('#year-filter');
                const genderFilter = this.container.querySelector('#gender-filter');
                const sortFilter = this.container.querySelector('#sort-filter');
                const clearButton = this.container.querySelector('#clear-filters');
                const advancedButton = this.container.querySelector('#advanced-search');

                // Search input with debouncing
                searchInput.addEventListener('input', (e) => {
                    this.searchTerm = e.target.value;
                    this.showSearchLoading(true);
                    this.debouncedSearch.search(this.searchTerm, this.filters);
                });

                // Filter changes
                [programFilter, yearFilter, genderFilter, sortFilter].forEach(filter => {
                    filter.addEventListener('change', (e) => {
                        this.updateFilter(e.target.id.replace('-filter', ''), e.target.value);
                        this.performSearch(this.searchTerm, this.filters);
                    });
                });

                // Clear filters
                clearButton.addEventListener('click', () => {
                    this.clearAllFilters();
                });

                // Advanced search (could open a modal with more options)
                advancedButton.addEventListener('click', () => {
                    this.openAdvancedSearch();
                });

                // View toggles
                this.container.querySelector('#view-grid').addEventListener('click', () => {
                    this.toggleView('grid');
                });

                this.container.querySelector('#view-table').addEventListener('click', () => {
                    this.toggleView('table');
                });
            }

            updateFilter(filterName, value) {
                if (value) {
                    this.filters[filterName] = value;
                } else {
                    delete this.filters[filterName];
                }
            }

            async performSearch(searchTerm, filters) {
                try {
                    // Build search filters object
                    const searchFilters = { ...filters };
                    if (searchTerm.trim()) {
                        searchFilters.name = searchTerm.trim();
                    }

                    // Update pagination manager filters
                    await this.paginationManager.search(searchFilters, 0); // No debounce since we already debounced
                    const data = await this.paginationManager.goToPage(1);
                    
                    this.showSearchSummary(data.totalCount, searchTerm, filters);
                    this.onSearchChange(data);
                } catch (error) {
                    console.error('Search failed:', error);
                    throw error;
                } finally {
                    this.showSearchLoading(false);
                }
            }

            showSearchLoading(show) {
                const loadingIndicator = this.container.querySelector('#search-loading');
                if (show) {
                    loadingIndicator.classList.remove('hidden');
                } else {
                    loadingIndicator.classList.add('hidden');
                }
            }

            showSearchSummary(totalCount, searchTerm, filters) {
                const summary = this.container.querySelector('#search-summary');
                const resultsText = this.container.querySelector('#search-results-text');
                
                let summaryText = `Found ${totalCount} result${totalCount !== 1 ? 's' : ''}`;
                
                if (searchTerm || Object.keys(filters).length > 0) {
                    summaryText += ' for';
                    if (searchTerm) {
                        summaryText += ` "${searchTerm}"`;
                    }
                    if (Object.keys(filters).length > 0) {
                        const filterDescriptions = [];
                        if (filters.program) filterDescriptions.push(`Program: ${filters.program}`);
                        if (filters.year) filterDescriptions.push(`Year: ${filters.year}`);
                        if (filters.gender) filterDescriptions.push(`Gender: ${filters.gender}`);
                        
                        if (filterDescriptions.length > 0) {
                            summaryText += ` (${filterDescriptions.join(', ')})`;
                        }
                    }
                }
                
                resultsText.textContent = summaryText;
                summary.classList.remove('hidden');
            }

            clearAllFilters() {
                // Clear input fields with null checks
                const searchTerm = this.container.querySelector('#search-term');
                const programFilter = this.container.querySelector('#program-filter');
                const yearFilter = this.container.querySelector('#year-filter');
                const genderFilter = this.container.querySelector('#gender-filter');
                const sortFilter = this.container.querySelector('#sort-filter');
                
                if (searchTerm) searchTerm.value = '';
                if (programFilter) programFilter.value = '';
                if (yearFilter) yearFilter.value = '';
                if (genderFilter) genderFilter.value = '';
                if (sortFilter) sortFilter.value = 'name_asc';

                // Clear internal state
                this.searchTerm = '';
                this.filters = {};

                // Perform empty search to show all results
                this.performSearch('', {});
            }

            toggleView(viewType) {
                const gridBtn = this.container.querySelector('#view-grid');
                const tableBtn = this.container.querySelector('#view-table');
                
                if (viewType === 'grid') {
                    gridBtn.classList.add('text-blue-600');
                    gridBtn.classList.remove('text-gray-400');
                    tableBtn.classList.add('text-gray-400');
                    tableBtn.classList.remove('text-blue-600');
                } else {
                    tableBtn.classList.add('text-blue-600');
                    tableBtn.classList.remove('text-gray-400');
                    gridBtn.classList.add('text-gray-400');
                    gridBtn.classList.remove('text-blue-600');
                }
                
                // Notify parent component of view change
                if (this.onViewChange) {
                    this.onViewChange(viewType);
                }
            }

            openAdvancedSearch() {
                // This could open a modal with additional search options
                openModal('Advanced Search', `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contact Email</label>
                            <input type="email" id="advanced-email" class="w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contact Phone</label>
                            <input type="tel" id="advanced-phone" class="w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date of Birth Range</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="date" id="advanced-dob-from" class="w-full p-2 border border-gray-300 rounded-md">
                                <input type="date" id="advanced-dob-to" class="w-full p-2 border border-gray-300 rounded-md">
                            </div>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button onclick="closeModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                Cancel
                            </button>
                            <button onclick="applyAdvancedSearch()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                Apply Filters
                            </button>
                        </div>
                    </div>
                `);
            }

            updateProgramOptions(programs) {
                const programSelect = this.container.querySelector('#program-filter');
                const currentValue = programSelect.value;
                
                programSelect.innerHTML = '<option value="">All Programs</option>';
                programs.forEach(program => {
                    const option = document.createElement('option');
                    option.value = program;
                    option.textContent = program;
                    if (program === currentValue) {
                        option.selected = true;
                    }
                    programSelect.appendChild(option);
                });
            }

            destroy() {
                this.debouncedSearch.destroy();
            }
        }

        // --- Skeleton Loading Component ---
        const createSkeletonLoader = (count = 5, type = 'card') => {
            const skeletons = [];
            for (let i = 0; i < count; i++) {
                if (type === 'card') {
                    skeletons.push(`
                        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4 animate-pulse">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-gray-300 rounded-full"></div>
                                <div class="flex-1 space-y-2">
                                    <div class="h-4 bg-gray-300 rounded w-3/4"></div>
                                    <div class="h-3 bg-gray-300 rounded w-1/2"></div>
                                </div>
                            </div>
                            <div class="mt-3 space-y-2">
                                <div class="h-3 bg-gray-300 rounded w-full"></div>
                                <div class="h-3 bg-gray-300 rounded w-2/3"></div>
                            </div>
                        </div>
                    `);
                } else if (type === 'table') {
                    skeletons.push(`
                        <tr class="animate-pulse">
                            <td class="px-6 py-4"><div class="h-4 bg-gray-300 rounded"></div></td>
                            <td class="px-6 py-4"><div class="h-4 bg-gray-300 rounded"></div></td>
                            <td class="px-6 py-4"><div class="h-4 bg-gray-300 rounded"></div></td>
                            <td class="px-6 py-4"><div class="h-4 bg-gray-300 rounded"></div></td>
                        </tr>
                    `);
                }
            }
            return skeletons.join('');
        };

        // --- Pagination State Management ---
        class PaginationManager {
            constructor(apiEndpoint, defaultPageSize = 20) {
                this.apiEndpoint = apiEndpoint;
                this.currentPage = 1;
                this.pageSize = defaultPageSize;
                this.totalRecords = 0;
                this.totalPages = 0;
                this.loading = false;
                this.error = null;
                this.cache = new Map();
                this.searchFilters = {};
                this.searchDebounceTimer = null;
                this.prefetchedPages = new Set();
            }

            get skip() {
                return (this.currentPage - 1) * this.pageSize;
            }

            get hasNextPage() {
                return this.currentPage < this.totalPages;
            }

            get hasPrevPage() {
                return this.currentPage > 1;
            }

            setFilters(filters) {
                this.searchFilters = { ...filters };
                this.cache.clear();
                this.prefetchedPages.clear();
                this.currentPage = 1;
            }

            setPageSize(size) {
                const prevSize = this.pageSize;
                this.pageSize = size;
                // Recalculate current page to maintain position
                const currentRecord = (this.currentPage - 1) * prevSize;
                this.currentPage = Math.floor(currentRecord / size) + 1;
                this.cache.clear();
                this.prefetchedPages.clear();
            }

            getCacheKey(page, filters = {}) {
                return JSON.stringify({ page, filters, pageSize: this.pageSize });
            }

            async fetchPage(page, filters = null, useCache = true) {
                const filtersToUse = filters || this.searchFilters;
                const cacheKey = this.getCacheKey(page, filtersToUse);
                
                if (useCache && this.cache.has(cacheKey)) {
                    return this.cache.get(cacheKey);
                }

                const skip = (page - 1) * this.pageSize;
                const params = new URLSearchParams({
                    skip: skip.toString(),
                    limit: this.pageSize.toString(),
                    ...filtersToUse
                });

                try {
                    const response = await api.fetchData(`${this.apiEndpoint}?${params}`, 'GET', null, false);
                    
                    if (response.success) {
                        const data = {
                            records: response.data.students || response.data.courses || response.data.grades || response.data,
                            totalCount: response.data.total_count || 0,
                            pagination: response.data.pagination || { skip, limit: this.pageSize }
                        };
                        
                        this.totalRecords = data.totalCount;
                        this.totalPages = Math.ceil(this.totalRecords / this.pageSize);
                        
                        // Cache the result
                        this.cache.set(cacheKey, data);
                        
                        // Prefetch adjacent pages
                        this.prefetchAdjacentPages(page, filtersToUse);
                        
                        return data;
                    } else {
                        throw new Error(response.message || 'Failed to fetch data');
                    }
                } catch (error) {
                    this.error = error.message;
                    throw error;
                }
            }

            async prefetchAdjacentPages(currentPage, filters) {
                const pagesToPrefetch = [currentPage - 1, currentPage + 1];
                
                for (const page of pagesToPrefetch) {
                    if (page > 0 && page <= this.totalPages && !this.prefetchedPages.has(page)) {
                        this.prefetchedPages.add(page);
                        // Prefetch in background without awaiting
                        this.fetchPage(page, filters, true).catch(() => {
                            // Ignore prefetch errors
                            this.prefetchedPages.delete(page);
                        });
                    }
                }
            }

            async goToPage(page) {
                if (page < 1 || page > this.totalPages) return null;
                this.currentPage = page;
                this.loading = true;
                try {
                    const data = await this.fetchPage(page);
                    this.error = null;
                    return data;
                } catch (error) {
                    this.error = error.message;
                    throw error;
                } finally {
                    this.loading = false;
                }
            }

            async nextPage() {
                if (this.hasNextPage) {
                    return await this.goToPage(this.currentPage + 1);
                }
                return null;
            }

            async prevPage() {
                if (this.hasPrevPage) {
                    return await this.goToPage(this.currentPage - 1);
                }
                return null;
            }

            async search(filters, debounceMs = 300) {
                return new Promise((resolve, reject) => {
                    clearTimeout(this.searchDebounceTimer);
                    this.searchDebounceTimer = setTimeout(async () => {
                        try {
                            this.setFilters(filters);
                            const data = await this.goToPage(1);
                            resolve(data);
                        } catch (error) {
                            reject(error);
                        }
                    }, debounceMs);
                });
            }
        }

        // --- Pagination UI Component ---
        class PaginationUI {
            constructor(container, paginationManager, onPageChange) {
                this.container = container;
                this.manager = paginationManager;
                this.onPageChange = onPageChange;
                this.lastKnownRecordCount = 0; // Track records for fallback scenarios
            }

            render() {
                const { currentPage, totalPages, totalRecords, pageSize, loading } = this.manager;
                
                // Debug logging for troubleshooting
                console.log('PaginationUI render - currentPage:', currentPage, 'totalPages:', totalPages, 'totalRecords:', totalRecords, 'pageSize:', pageSize);
                
                // Don't show pagination if truly no records
                if (totalRecords === 0 && currentPage === 1) {
                    this.container.innerHTML = '';
                    return;
                }

                // Handle cases where totalRecords might be undefined but we have data
                const recordCount = totalRecords || this.lastKnownRecordCount || 0;
                const pageCount = totalPages || Math.max(1, Math.ceil(recordCount / pageSize));
                const currentPageNum = currentPage || 1;

                const startRecord = ((currentPageNum - 1) * pageSize) + 1;
                const endRecord = Math.min(currentPageNum * pageSize, recordCount);
                
                const paginationHTML = `
                    <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                        <div class="flex-1 flex justify-between sm:hidden">
                            <button ${!this.manager.hasPrevPage || loading ? 'disabled' : ''} 
                                    class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                    data-action="prev">
                                Previous
                            </button>
                            <button ${!this.manager.hasNextPage || loading ? 'disabled' : ''} 
                                    class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                    data-action="next">
                                Next
                            </button>
                        </div>
                        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                            <div class="flex items-center space-x-4">
                                <p class="text-sm text-gray-700">
                                    Showing <span class="font-medium">${startRecord}</span> to <span class="font-medium">${endRecord}</span> of <span class="font-medium">${recordCount}</span> results
                                </p>
                                <div class="flex items-center space-x-2">
                                    <label class="text-sm text-gray-700">Per page:</label>
                                    <select class="border border-gray-300 rounded-md text-sm py-1 px-2 focus:ring-blue-500 focus:border-blue-500" 
                                            data-action="pageSize">
                                        <option value="10" ${pageSize === 10 ? 'selected' : ''}>10</option>
                                        <option value="20" ${pageSize === 20 ? 'selected' : ''}>20</option>
                                        <option value="50" ${pageSize === 50 ? 'selected' : ''}>50</option>
                                        <option value="100" ${pageSize === 100 ? 'selected' : ''}>100</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                    ${this.renderPageButtons()}
                                </nav>
                            </div>
                        </div>
                        ${loading ? '<div class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center"><div class="spinner"></div></div>' : ''}
                    </div>
                `;
                
                this.container.innerHTML = paginationHTML;
                this.lastKnownRecordCount = recordCount; // Store for future renders
                this.attachEventListeners();
            }

            renderPageButtons() {
                const { currentPage, totalPages } = this.manager;
                const buttons = [];
                
                // Previous button
                buttons.push(`
                    <button ${!this.manager.hasPrevPage ? 'disabled' : ''} 
                            class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                            data-action="prev">
                        <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `);

                // Page number buttons
                const { start, end } = this.calculatePageRange(currentPage, totalPages);
                
                if (start > 1) {
                    buttons.push(this.createPageButton(1));
                    if (start > 2) {
                        buttons.push('<span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">...</span>');
                    }
                }

                for (let i = start; i <= end; i++) {
                    buttons.push(this.createPageButton(i, i === currentPage));
                }

                if (end < totalPages) {
                    if (end < totalPages - 1) {
                        buttons.push('<span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">...</span>');
                    }
                    buttons.push(this.createPageButton(totalPages));
                }

                // Next button
                buttons.push(`
                    <button ${!this.manager.hasNextPage ? 'disabled' : ''} 
                            class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                            data-action="next">
                        <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `);

                return buttons.join('');
            }

            calculatePageRange(currentPage, totalPages) {
                const maxVisible = 7;
                const half = Math.floor(maxVisible / 2);
                
                let start = Math.max(1, currentPage - half);
                let end = Math.min(totalPages, start + maxVisible - 1);
                
                if (end - start + 1 < maxVisible) {
                    start = Math.max(1, end - maxVisible + 1);
                }
                
                return { start, end };
            }

            createPageButton(page, isActive = false) {
                return `
                    <button class="relative inline-flex items-center px-4 py-2 border text-sm font-medium ${
                        isActive 
                            ? 'z-10 bg-blue-50 border-blue-500 text-blue-600' 
                            : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'
                    }" data-action="page" data-page="${page}">
                        ${page}
                    </button>
                `;
            }

            attachEventListeners() {
                this.container.addEventListener('click', async (e) => {
                    const action = e.target.dataset.action;
                    if (!action) return;

                    e.preventDefault();
                    
                    try {
                        let result = null;
                        switch (action) {
                            case 'prev':
                                result = await this.manager.prevPage();
                                break;
                            case 'next':
                                result = await this.manager.nextPage();
                                break;
                            case 'page':
                                const page = parseInt(e.target.dataset.page);
                                result = await this.manager.goToPage(page);
                                break;
                        }
                        
                        if (result) {
                            this.render();
                            this.onPageChange(result);
                        }
                    } catch (error) {
                        showToast('Failed to load page: ' + error.message, 'error');
                    }
                });

                this.container.addEventListener('change', async (e) => {
                    if (e.target.dataset.action === 'pageSize') {
                        const newSize = parseInt(e.target.value);
                        this.manager.setPageSize(newSize);
                        try {
                            const result = await this.manager.goToPage(this.manager.currentPage);
                            this.render();
                            this.onPageChange(result);
                        } catch (error) {
                            showToast('Failed to update page size: ' + error.message, 'error');
                        }
                    }
                });
            }
        }

        // --- API Utility ---
        const api = {
            fetchData: async (endpoint, method = 'GET', body = null, showLoader = true) => {
                if (showLoader) showLoading();
                
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': getAuthHeader(),
                };

                const options = {
                    method,
                    headers,
                    body: body ? JSON.stringify(body) : null,
                };

                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                    let data;
                    try {
                        data = await response.json();
                    } catch (e) {
                        data = {};
                    }
                    if (!response.ok) {
                        // Only force logout on 401/403 errors
                        if (response.status === 401 || response.status === 403) {
                            setAuthUser(null);
                            showToast('Session expired. Please log in again.', 'error');
                            throw new Error('Session expired or unauthorized. Please log in again.');
                        }
                        
                        // Show user-friendly error messages
                        const errorMessage = data.message || `Server error (${response.status})`;
                        showToast(errorMessage, 'error');
                        throw new Error(errorMessage);
                    }
                    
                    // Show success message for successful operations that modify data
                    if ((method === 'POST' || method === 'PUT' || method === 'DELETE') && data.success && data.message) {
                        showToast(data.message, 'success');
                    }
                    
                    return data;
                } catch (error) {
                    // Only log out on explicit 401/403 above
                    console.error('API Call Failed:', endpoint, error);
                    if (!error.message.includes('Session expired')) {
                        showToast(error.message || 'An unexpected error occurred', 'error');
                    }
                    throw error;
                } finally {
                    if (showLoader) hideLoading();
                }
            },

            login: async (username, password) => {
                const tempAuthHeader = 'Basic ' + btoa(`${username}:${password}`);
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': tempAuthHeader,
                };
                const options = {
                    method: 'GET',
                    headers,
                };
                const response = await fetch(`${API_BASE_URL}/me`, options);
                const data = await response.json();

                if (response.ok && data.success) {
                    sessionStorage.setItem('srmsAuth', JSON.stringify({ username, password }));
                    return { success: true, user: data.data };
                } else {
                    throw new Error(data.message || 'Login failed: Invalid credentials');
                }
            },

            // --- Admin Endpoints (mimicking React structure) ---
            getAllStudents: async (skip = 0, limit = 100) => api.fetchData(`/admin/students?skip=${skip}&limit=${limit}`),
            searchStudents: async (filters = {}, skip = 0, limit = 100) => {
                const query = new URLSearchParams(filters).toString();
                return api.fetchData(`/admin/students/search?${query}&skip=${skip}&limit=${limit}`);
            },
            createStudent: async (studentData) => api.fetchData('/admin/students', 'POST', studentData),
            updateStudent: async (index_number, studentData) => api.fetchData(`/admin/students/${encodeURIComponent(index_number)}`, 'PUT', studentData),
            deleteStudent: async (index_number) => api.fetchData(`/admin/students/${encodeURIComponent(index_number)}`, 'DELETE'),

            getAllCourses: async (skip = 0, limit = 100) => api.fetchData(`/admin/courses?skip=${skip}&limit=${limit}`),
            createCourse: async (courseData) => api.fetchData('/admin/courses', 'POST', courseData),
            updateCourse: async (course_code, courseData) => api.fetchData(`/admin/courses/${encodeURIComponent(course_code)}`, 'PUT', courseData),
            deleteCourse: async (course_code) => api.fetchData(`/admin/courses/${encodeURIComponent(course_code)}`, 'DELETE'),

            getAllSemesters: async () => api.fetchData('/admin/semesters'),
            createSemester: async (semesterData) => api.fetchData('/admin/semesters', 'POST', semesterData),
            updateSemester: async (semester_name, semesterData) => api.fetchData(`/admin/semesters/${encodeURIComponent(semester_name)}`, 'PUT', semesterData),
            deleteSemester: async (semester_name) => api.fetchData(`/admin/semesters/${encodeURIComponent(semester_name)}`, 'DELETE'),

            getAllGrades: async (filters = {}, skip = 0, limit = 100) => {
                const query = new URLSearchParams(filters).toString();
                return api.fetchData(`/admin/grades?${query}&skip=${skip}&limit=${limit}`);
            },
            createGrade: async (gradeData) => api.fetchData('/admin/grades', 'POST', gradeData),
            updateGrade: async (grade_id, gradeData) => api.fetchData(`/admin/grades/${encodeURIComponent(grade_id)}`, 'PUT', gradeData),
            deleteGrade: async (grade_id) => api.fetchData(`/admin/grades/${encodeURIComponent(grade_id)}`, 'DELETE'),

            createUserAccount: async (userData) => api.fetchData('/admin/users', 'POST', userData),
            createStudentAccount: async (accountData) => api.fetchData('/admin/student-accounts', 'POST', accountData),
            resetStudentPassword: async (passwordResetData) => api.fetchData('/admin/reset-password', 'POST', passwordResetData),

            bulkImportData: async (importData) => api.fetchData('/admin/bulk-import', 'POST', importData),

            generateSummaryReport: async (filters = {}) => {
                const query = new URLSearchParams(filters).toString();
                return api.fetchData(`/admin/reports/summary?${query}`);
            },

            // Functions for downloading reports
            downloadSummaryReportPdf: async (filters = {}) => {
                const query = new URLSearchParams(filters).toString();
                const headers = { 'Authorization': getAuthHeader() };
                const response = await fetch(`${API_BASE_URL}/admin/reports/summary/pdf?${query}`, { headers });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `API Error: ${response.status} ${response.statusText}`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'summary_report.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            },
            
            downloadSummaryReportTxt: async (filters = {}) => {
                const query = new URLSearchParams(filters).toString();
                const headers = { 'Authorization': getAuthHeader() };
                const response = await fetch(`${API_BASE_URL}/admin/reports/summary/txt?${query}`, { headers });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `API Error: ${response.status} ${response.statusText}`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'summary_report.txt';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            },

            downloadSummaryReportExcel: async (filters = {}) => {
                const query = new URLSearchParams(filters).toString();
                const headers = { 'Authorization': getAuthHeader() };
                
                console.log('Calling Excel download API:', `${API_BASE_URL}/admin/reports/summary/excel?${query}`);
                console.log('Headers being sent:', headers);
                
                try {
                    const response = await fetch(`${API_BASE_URL}/admin/reports/summary/excel?${query}`, { 
                        headers,
                        method: 'GET'
                    });
                    
                    console.log('Excel API response status:', response.status);
                    console.log('Excel API response headers:', [...response.headers.entries()]);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Excel API error response:', errorText);
                        
                        // If it's a 401 error, suggest re-login
                        if (response.status === 401) {
                            throw new Error(`Authentication failed. Please log out and log back in. Error: ${response.status} - ${errorText}`);
                        }
                        
                        throw new Error(`Failed to download Excel report: ${response.status} - ${errorText}`);
                    }
                    
                    // Check if response has content
                    const contentLength = response.headers.get('content-length');
                    console.log('Excel response content-length:', contentLength);
                    
                    const contentType = response.headers.get('content-type');
                    console.log('Excel response content-type:', contentType);
                    
                    const contentDisposition = response.headers.get('content-disposition');
                    console.log('Excel response content-disposition:', contentDisposition);
                    
                    // Convert response to blob
                    const blob = await response.blob();
                    console.log('Excel blob size:', blob.size);
                    console.log('Excel blob type:', blob.type);
                    
                    if (blob.size === 0) {
                        throw new Error('Downloaded Excel file is empty. Please check server logs.');
                    }
                    
                    // Create download link with improved handling
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    
                    // Extract filename from Content-Disposition header or use default
                    let filename = 'summary_report.xlsx';
                    if (contentDisposition) {
                        const match = contentDisposition.match(/filename[^;=\\n]*=((['\"]*)(.*?)\\2|[^;\\n]*)/);
                        if (match && match[3]) {
                            filename = match[3];
                        }
                    }
                    a.download = filename;
                    
                    // Force download with user interaction protection
                    document.body.appendChild(a);
                    console.log('Triggering download for file:', filename, 'with size:', blob.size);
                    
                    // Use a small delay to ensure element is fully attached
                    await new Promise(resolve => setTimeout(resolve, 10));
                    try {
                        a.click();
                    } catch(clickErr) {
                        console.warn('Primary click() failed, attempting fallback open', clickErr);
                        try {
                            window.open(url);
                        } catch(openErr) {
                            console.warn('window.open fallback failed', openErr);
                        }
                    }

                    // IE / Edge (legacy) fallback
                    if (window.navigator && window.navigator.msSaveOrOpenBlob) {
                        try {
                            window.navigator.msSaveOrOpenBlob(blob, filename);
                            console.log('Used msSaveOrOpenBlob fallback');
                        } catch(msErr) {
                            console.warn('msSaveOrOpenBlob failed', msErr);
                        }
                    }
                    
                    // Clean up with a longer delay to ensure download starts
                    setTimeout(() => {
                        window.URL.revokeObjectURL(url);
                        if (document.body.contains(a)) {
                            document.body.removeChild(a);
                        }
                        console.log('Download cleanup completed');
                    }, 500);
                    
                    console.log('Excel download initiated successfully');

                    // Provide a manual link area in case user needs it
                    const existingManual = document.getElementById('manual-excel-link');
                    if (existingManual) existingManual.remove();
                    const manualDiv = document.createElement('div');
                    manualDiv.id = 'manual-excel-link';
                    manualDiv.className = 'mt-2 text-xs text-gray-500 text-center';
                    manualDiv.innerHTML = `If the download did not start <a href="${url}" download="${filename}">click here to download manually</a>.`;
                    document.body.appendChild(manualDiv);
                    
                } catch (fetchError) {
                    console.error('Fetch error during Excel download:', fetchError);
                    throw fetchError;
                }
            },

            downloadSummaryReportCsv: async (filters = {}) => {
                const query = new URLSearchParams(filters).toString();
                const headers = { 'Authorization': getAuthHeader() };
                
                console.log('Calling CSV download API:', `${API_BASE_URL}/admin/reports/summary/csv?${query}`);
                console.log('Headers being sent:', headers);
                
                const response = await fetch(`${API_BASE_URL}/admin/reports/summary/csv?${query}`, { headers });
                
                console.log('CSV API response status:', response.status);
                console.log('CSV API response headers:', [...response.headers.entries()]);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('CSV API error response:', errorText);
                    
                    // If it's a 401 error, suggest re-login
                    if (response.status === 401) {
                        throw new Error(`Authentication failed. Please log out and log back in. Error: ${response.status} - ${errorText}`);
                    }
                    
                    throw new Error(`Failed to download CSV report: ${response.status} - ${errorText}`);
                }
                
                const blob = await response.blob();
                console.log('CSV blob size:', blob.size);
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'summary_report.csv';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                console.log('CSV download initiated successfully');
            },

            downloadAcademicTranscript: async (studentIndex) => {
                const headers = { 'Authorization': `Bearer ${localStorage.getItem('token')}` };
                const response = await fetch(`${API_BASE_URL}/admin/reports/transcript/${encodeURIComponent(studentIndex)}?format=excel`, { headers });
                
                if (!response.ok) {
                    throw new Error('Failed to download academic transcript');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `transcript_${studentIndex}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            },

            getAdminDashboardAnalytics: async () => api.fetchData('/admin/analytics/dashboard'),
            
            // =============================
            // Notification API Helpers
            // =============================
            fetchNotifications: async ({ unreadOnly = false, limit = 20, beforeId = null } = {}) => {
                const params = new URLSearchParams();
                if (unreadOnly) params.append('unread_only', 'true');
                if (limit) params.append('limit', limit);
                if (beforeId) params.append('before_id', beforeId);
                const headers = { 'Authorization': getAuthHeader() };
                const url = `${API_BASE_URL}/notifications?${params.toString()}`;
                console.log('[Notifications] Fetch list:', url);
                const resp = await fetch(url, { headers });
                if (!resp.ok) {
                    const t = await resp.text();
                    throw new Error(`Failed to fetch notifications: ${resp.status} ${t}`);
                }
                return resp.json();
            },
            fetchUnreadCount: async () => {
                const headers = { 'Authorization': getAuthHeader() };
                const url = `${API_BASE_URL}/notifications/unread-count`;
                const resp = await fetch(url, { headers });
                if (!resp.ok) throw new Error('Failed to fetch unread count');
                return resp.json();
            },
            markNotificationRead: async (userNotificationId) => {
                const headers = { 'Authorization': getAuthHeader(), 'Content-Type': 'application/json' };
                const url = `${API_BASE_URL}/notifications/${userNotificationId}/read`;
                const resp = await fetch(url, { method: 'POST', headers });
                if (!resp.ok) throw new Error('Failed to mark notification read');
                return resp.json();
            },
            markAllNotificationsRead: async () => {
                const headers = { 'Authorization': getAuthHeader(), 'Content-Type': 'application/json' };
                const url = `${API_BASE_URL}/notifications/read-all`;
                const resp = await fetch(url, { method: 'POST', headers });
                if (!resp.ok) throw new Error('Failed to mark all notifications read');
                return resp.json();
            },
            createAdminNotification: async (payload) => {
                const headers = { 'Authorization': getAuthHeader(), 'Content-Type': 'application/json' };
                const resp = await fetch(`${API_BASE_URL}/admin/notifications`, { method: 'POST', headers, body: JSON.stringify(payload) });
                if (!resp.ok) {
                    const t = await resp.text();
                    throw new Error(`Failed to create notification: ${resp.status} ${t}`);
                }
                return resp.json();
            },
            getEnrollmentStatistics: async (academicYear = null) => {
                const query = academicYear ? `academic_year=${encodeURIComponent(academicYear)}` : '';
                return api.fetchData(`/admin/statistics/enrollment?${query}`);
            },
            getGradesDistribution: async (semesterName = null, courseCode = null) => {
                let query = '';
                if (semesterName) query += `semester_name=${encodeURIComponent(semesterName)}&`;
                if (courseCode) query += `course_code=${encodeURIComponent(courseCode)}&`;
                return api.fetchData(`/admin/statistics/grades-distribution?${query}`);
            },
            generateStudentTranscript: async (index_number) => api.fetchData(`/admin/reports/transcript/${encodeURIComponent(index_number)}`),

            initializeSystem: async () => api.fetchData('/initialize', 'POST'),
            seedDatabase: async (numStudents = 100, cleanupFirst = true) => api.fetchData(`/admin/seed-comprehensive?num_students=${numStudents}&cleanup_first=${cleanupFirst}`, 'POST'),

            // --- Student Endpoints ---
            getStudentProfile: async () => api.fetchData('/student/profile'),
            getStudentGrades: async (semester = null, academicYear = null) => {
                let query = '';
                if (semester) query += `semester=${encodeURIComponent(semester)}&`;
                if (academicYear) query += `academic_year=${encodeURIComponent(academicYear)}&`;
                return api.fetchData(`/student/grades?${query}`);
            },
            getStudentGPA: async (semester = null, academicYear = null) => {
                let query = '';
                if (semester) query += `semester=${encodeURIComponent(semester)}&`;
                if (academicYear) query += `academic_year=${encodeURIComponent(academicYear)}&`;
                return api.fetchData(`/student/gpa?${query}`);
            },
            
            // Student report download functions
            downloadPersonalReportPdf: async () => {
                const headers = { 'Authorization': getAuthHeader() };
                const response = await fetch(`${API_BASE_URL}/student/report/pdf`, { headers });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `API Error: ${response.status} ${response.statusText}`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'personal_academic_report.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            },
            
            downloadPersonalReportTxt: async () => {
                const headers = { 'Authorization': getAuthHeader() };
                const response = await fetch(`${API_BASE_URL}/student/report/txt`, { headers });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `API Error: ${response.status} ${response.statusText}`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'personal_academic_report.txt';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            },
        };

        // --- Modal Functions ---
        const modalOverlay = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        let onModalCloseCallback = null;

        const openModal = (title, contentHtml, onClose = null) => {
            modalTitle.textContent = title;
            modalBody.innerHTML = contentHtml;
            modalOverlay.classList.remove('hidden');
            onModalCloseCallback = onClose;
        };

        const closeModal = () => {
            modalOverlay.classList.add('hidden');
            modalTitle.textContent = '';
            modalBody.innerHTML = '';
            if (onModalCloseCallback) {
                onModalCloseCallback();
                onModalCloseCallback = null;
            }
        };

        modalCloseBtn.addEventListener('click', closeModal);
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) {
                closeModal();
            }
        });

        // --- Confirmation Modal Functions ---
        const confirmModalOverlay = document.getElementById('confirmation-modal-overlay');
        const confirmModalTitle = document.getElementById('confirmation-modal-title');
        const confirmModalBody = document.getElementById('confirmation-modal-body');
        const confirmModalCloseBtn = document.getElementById('confirmation-modal-close-btn');
        const confirmModalCancelBtn = document.getElementById('confirmation-modal-cancel-btn');
        const confirmModalConfirmBtn = document.getElementById('confirmation-modal-confirm-btn');

        let onConfirmCallback = null;
        let onCancelCallback = null;

        const openConfirmationModal = (title, message, onConfirm, onCancel = null) => {
            confirmModalTitle.textContent = title;
            confirmModalBody.textContent = message;
            confirmModalOverlay.classList.remove('hidden');
            onConfirmCallback = onConfirm;
            onCancelCallback = onCancel;
        };

        const closeConfirmationModal = () => {
            confirmModalOverlay.classList.add('hidden');
            confirmModalTitle.textContent = '';
            confirmModalBody.textContent = '';
            onConfirmCallback = null;
            onCancelCallback = null;
        };

        confirmModalCloseBtn.addEventListener('click', closeConfirmationModal);
        confirmModalCancelBtn.addEventListener('click', () => {
            if (onCancelCallback) onCancelCallback();
            closeConfirmationModal();
        });
        confirmModalConfirmBtn.addEventListener('click', () => {
            if (onConfirmCallback) onConfirmCallback();
            closeConfirmationModal();
        });
        confirmModalOverlay.addEventListener('click', (e) => {
            if (e.target === confirmModalOverlay) {
                closeConfirmationModal();
            }
        });

        // --- Student Edit Modal ---
        const openStudentEditModal = (indexNumber, name, email, course, semester) => {
            const modalHTML = `
                <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" id="student-edit-modal">
                    <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4 p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Edit Student</h3>
                            <button id="student-edit-modal-close" class="text-gray-400 hover:text-gray-600 text-xl font-bold">&times;</button>
                        </div>
                        <form id="student-edit-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Index Number</label>
                                <input type="text" id="edit-index-number" value="${indexNumber}" readonly 
                                       class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                                <input type="text" id="edit-student-name" value="${name}" required 
                                       class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" id="edit-student-email" value="${email}" required 
                                       class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Course</label>
                                <input type="text" id="edit-student-course" value="${course}" required 
                                       class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
                                <input type="text" id="edit-student-semester" value="${semester}" required 
                                       class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" id="student-edit-cancel" 
                                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="submit" id="student-edit-save" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    Save Changes
                                </button>
                            </div>
                        </form>
                        <p id="student-edit-message" class="mt-3 text-center text-sm"></p>
                        <p id="student-edit-error" class="mt-3 text-center text-sm"></p>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = document.getElementById('student-edit-modal');
            const form = document.getElementById('student-edit-form');
            const closeBtn = document.getElementById('student-edit-modal-close');
            const cancelBtn = document.getElementById('student-edit-cancel');
            
            const closeModal = () => {
                modal.remove();
            };
            
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const saveBtn = document.getElementById('student-edit-save');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';
                
                try {
                    const updatedData = {
                        full_name: document.getElementById('edit-student-name').value,
                        contact_email: document.getElementById('edit-student-email').value,
                        program: document.getElementById('edit-student-course').value,
                        year_of_study: parseInt(document.getElementById('edit-student-semester').value) || null
                    };
                    
                    const result = await api.updateStudent(indexNumber, updatedData);
                    if (result.success) {
                        displayMessage('student-edit-message', 'Student updated successfully!', 'success');
                        setTimeout(() => {
                            closeModal();
                            fetchAndRenderStudents(); // Refresh the student list
                        }, 1500);
                    } else {
                        displayMessage('student-edit-error', result.message, 'error');
                    }
                } catch (err) {
                    displayMessage('student-edit-error', err.message, 'error');
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save Changes';
                }
            });
        };

        // --- Course Edit Modal ---
        const openCourseEditModal = (courseCode, title, credits) => {
            const modalHTML = `
                <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" id="course-edit-modal">
                    <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4 p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Edit Course</h3>
                            <button id="course-edit-modal-close" class="text-gray-400 hover:text-gray-600 text-xl font-bold">&times;</button>
                        </div>
                        <form id="course-edit-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Course Code</label>
                                <input type="text" id="edit-course-code" value="${courseCode}" readonly 
                                       class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Course Title</label>
                                <input type="text" id="edit-course-title" value="${title}" required 
                                       class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Credit Hours</label>
                                <input type="number" id="edit-course-credits" value="${credits}" min="1" max="10" required 
                                       class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" id="course-edit-cancel" 
                                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="submit" id="course-edit-save" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    Save Changes
                                </button>
                            </div>
                        </form>
                        <p id="course-edit-message" class="mt-3 text-center text-sm"></p>
                        <p id="course-edit-error" class="mt-3 text-center text-sm"></p>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = document.getElementById('course-edit-modal');
            const form = document.getElementById('course-edit-form');
            const closeBtn = document.getElementById('course-edit-modal-close');
            const cancelBtn = document.getElementById('course-edit-cancel');
            
            const closeModal = () => {
                modal.remove();
            };
            
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const saveBtn = document.getElementById('course-edit-save');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';
                
                try {
                    const updatedData = {
                        course_code: document.getElementById('edit-course-code').value,
                        course_title: document.getElementById('edit-course-title').value,
                        credit_hours: parseInt(document.getElementById('edit-course-credits').value)
                    };
                    
                    const result = await api.updateCourse(courseCode, updatedData);
                    if (result.success) {
                        displayMessage('course-edit-message', 'Course updated successfully!', 'success');
                        setTimeout(() => {
                            closeModal();
                            fetchAndRenderCourses(); // Refresh the course list
                        }, 1500);
                    } else {
                        displayMessage('course-edit-error', result.message, 'error');
                    }
                } catch (err) {
                    displayMessage('course-edit-error', err.message, 'error');
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save Changes';
                }
            });
        };

        // --- Grade Edit Modal ---
        const openGradeEditModal = (gradeId, courseCode, semester, academicYear, score) => {
            const modalHTML = `
                <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" id="grade-edit-modal">
                    <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4 p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Edit Grade</h3>
                            <button id="grade-edit-modal-close" class="text-gray-400 hover:text-gray-600 text-xl font-bold">&times;</button>
                        </div>
                        <form id="grade-edit-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Course Code</label>
                                <input type="text" id="edit-grade-course" value="${courseCode}" readonly 
                                       class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
                                <input type="text" id="edit-grade-semester" value="${semester}" readonly 
                                       class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Academic Year</label>
                                <input type="text" id="edit-grade-year" value="${academicYear}" readonly 
                                       class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Score (0-100)</label>
                                <input type="number" id="edit-grade-score" value="${score || ''}" step="0.1" min="0" max="100" required 
                                       class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" id="grade-edit-cancel" 
                                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="submit" id="grade-edit-save" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    Save Changes
                                </button>
                            </div>
                        </form>
                        <p id="grade-edit-message" class="mt-3 text-center text-sm"></p>
                        <p id="grade-edit-error" class="mt-3 text-center text-sm"></p>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = document.getElementById('grade-edit-modal');
            const form = document.getElementById('grade-edit-form');
            const closeBtn = document.getElementById('grade-edit-modal-close');
            const cancelBtn = document.getElementById('grade-edit-cancel');
            
            const closeModal = () => {
                modal.remove();
            };
            
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const saveBtn = document.getElementById('grade-edit-save');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';
                
                try {
                    const updatedData = {
                        score: parseFloat(document.getElementById('edit-grade-score').value)
                    };
                    
                    const result = await api.updateGrade(gradeId, updatedData);
                    if (result.success) {
                        displayMessage('grade-edit-message', 'Grade updated successfully!', 'success');
                        setTimeout(() => {
                            closeModal();
                            // Refresh grades data if pagination is available, otherwise use legacy method
                            if (typeof refreshGradesData === 'function' && gradesPaginationState?.isLoaded) {
                                refreshGradesData();
                            } else if (typeof fetchAndRenderGrades === 'function') {
                                fetchAndRenderGrades();
                            }
                        }, 1500);
                    } else {
                        displayMessage('grade-edit-error', result.message, 'error');
                    }
                } catch (err) {
                    displayMessage('grade-edit-error', err.message, 'error');
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save Changes';
                }
            });
        };

        // --- Message Display Utility ---
        const displayMessage = (elementId, message, type = 'success') => {
            const el = document.getElementById(elementId);
            if (el) {
                el.textContent = message;
                el.className = `mt-3 text-center text-sm ${type === 'success' ? 'text-green-600' : 'text-red-600'}`;
                setTimeout(() => {
                    el.textContent = '';
                    el.className = '';
                }, 5000); // Clear message after 5 seconds
            }
        };

        // --- Login Page ---
        const renderLoginPage = () => {
            appDiv.innerHTML = `
                <div class="min-h-screen w-full flex flex-col md:flex-row bg-gradient-to-br from-blue-50 via-white to-indigo-100 relative overflow-hidden">
                    <div class="absolute inset-0 pointer-events-none" aria-hidden="true">
                        <div class="absolute -top-24 -left-24 w-96 h-96 bg-blue-200 rounded-full mix-blend-multiply filter blur-3xl opacity-40 animate-pulse"></div>
                        <div class="absolute -bottom-24 -right-24 w-[32rem] h-[32rem] bg-indigo-200 rounded-full mix-blend-multiply filter blur-3xl opacity-40 animate-pulse animation-delay-2000"></div>
                    </div>
                    <div class="flex-1 flex items-center justify-center p-6 md:p-10 order-2 md:order-1">
                        <div class="w-full max-w-md bg-white/80 backdrop-blur-sm rounded-xl shadow-lg border border-indigo-100 p-8 md:p-10 relative">
                            <div class="flex flex-col items-center mb-8">
                                <div class="h-14 w-14 flex items-center justify-center rounded-lg bg-gradient-to-br from-indigo-600 to-blue-600 text-white font-bold text-2xl shadow-md mb-3">S</div>
                                <h1 class="text-2xl font-bold text-gray-800 tracking-tight">Student Records Portal</h1>
                                <p class="text-sm text-gray-500 mt-1">Sign in to manage courses, grades & analytics</p>
                            </div>
                            <form id="login-form" class="space-y-6" autocomplete="on">
                                <div>
                                    <label class="block text-gray-700 text-sm font-medium mb-2" for="username">Username</label>
                                    <input type="text" id="username" autocomplete="username" class="peer w-full px-4 py-2.5 border rounded-md bg-white/70 border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-base transition" placeholder="e.g. admin or ug12345" required />
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm font-medium mb-2" for="password">Password</label>
                                    <div class="relative">
                                        <input type="password" id="password" autocomplete="current-password" class="w-full pr-11 px-4 py-2.5 border rounded-md bg-white/70 border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-base transition" placeholder="Enter your password" required />
                                        <button type="button" id="toggle-password" aria-label="Toggle password visibility" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-gray-700 focus:outline-none focus:text-indigo-600">
                                            <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M2.036 12.322a1.012 1.012 0 010-.644C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .644C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"/><circle cx="12" cy="12" r="3" /></svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between text-sm">
                                    <div class="flex items-center gap-2">
                                        <input id="remember-me" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" />
                                        <label for="remember-me" class="text-gray-600">Remember me</label>
                                    </div>
                                    <button type="button" id="show-samples" class="text-indigo-600 hover:text-indigo-700 font-medium" aria-expanded="false" aria-controls="sample-credentials">Sample logins</button>
                                </div>
                                <p id="login-error" class="text-red-600 text-sm text-center"></p>
                                <button type="submit" id="login-button" class="w-full bg-gradient-to-r from-indigo-600 to-blue-600 text-white py-2.5 px-4 rounded-md font-semibold shadow hover:from-indigo-500 hover:to-blue-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed transition">
                                    <span class="inline-flex items-center gap-2"><svg class="h-5 w-5 opacity-90" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M12 11c1.105 0 2-.893 2-1.995V7.995C14 6.893 13.105 6 12 6s-2 .893-2 1.995v1.01C10 10.107 10.895 11 12 11z" /><path stroke-linecap="round" stroke-linejoin="round" d="M6 11c0-3.075 2.925-5 6-5s6 1.925 6 5m-9 4h6m-9 4h12" /></svg> Sign In</span>
                                </button>
                                <div id="sample-credentials" class="mt-4 hidden bg-indigo-50/60 border border-indigo-100 rounded-md p-4 text-xs leading-relaxed" role="region" aria-label="Sample credentials">
                                    <p class="font-semibold text-gray-700 mb-1">Examples:</p>
                                    <ul class="space-y-1 text-gray-600">
                                        <li><span class="font-medium">Admin:</span> admin / admin123</li>
                                        <li><span class="font-medium">Registrar:</span> registrar / registrar123</li>
                                        <li><span class="font-medium">Student:</span> ug10432 / 43212024 (index pattern)</li>
                                        <li><span class="font-medium">Instructor:</span> firstname.lastname / firstname.lastname123</li>
                                    </ul>
                                    <p class="mt-2 text-[10px] text-gray-500">Use seeded accounts or your assigned credentials.</p>
                                </div>
                            </form>
                            <div class="mt-8 text-center text-[11px] text-gray-400">&copy; ${(new Date()).getFullYear()} SRMS â€¢ Secure Academic Data</div>
                        </div>
                    </div>
                    <div class="flex-1 flex items-center justify-center p-10 bg-gradient-to-br from-indigo-600 to-blue-700 text-white relative order-1 md:order-2">
                        <div class="max-w-lg">
                            <h2 class="text-3xl md:text-4xl font-bold mb-6 leading-tight">Unified Student Records & Instructor Analytics</h2>
                            <p class="text-indigo-100 text-base md:text-lg leading-relaxed">Access real-time course performance, instructor insights, and academic histories with a modern, secure interface. Designed for administrators, faculty and students at scale.</p>
                            <div class="mt-8 grid grid-cols-2 gap-4 text-sm">
                                <div class="bg-white/10 rounded-lg p-4 backdrop-blur-sm border border-white/10">
                                    <h3 class="font-semibold mb-1">Instructors</h3>
                                    <p class="text-indigo-100">View performance & manage materials</p>
                                </div>
                                <div class="bg-white/10 rounded-lg p-4 backdrop-blur-sm border border-white/10">
                                    <h3 class="font-semibold mb-1">Admins</h3>
                                    <p class="text-indigo-100">Oversee cohorts & integrity</p>
                                </div>
                                <div class="bg-white/10 rounded-lg p-4 backdrop-blur-sm border border-white/10">
                                    <h3 class="font-semibold mb-1">Students</h3>
                                    <p class="text-indigo-100">Track transcripts & growth</p>
                                </div>
                                <div class="bg-white/10 rounded-lg p-4 backdrop-blur-sm border border-white/10">
                                    <h3 class="font-semibold mb-1">Analytics</h3>
                                    <p class="text-indigo-100">Real-time course metrics</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const loginForm = document.getElementById('login-form');
            const loginButton = document.getElementById('login-button');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const loginError = document.getElementById('login-error');
            const togglePassword = document.getElementById('toggle-password');
            const sampleBtn = document.getElementById('show-samples');
            const samplesPanel = document.getElementById('sample-credentials');

            if (togglePassword) {
                togglePassword.addEventListener('click', () => {
                    const isPwd = passwordInput.getAttribute('type') === 'password';
                    passwordInput.setAttribute('type', isPwd ? 'text' : 'password');
                    togglePassword.setAttribute('aria-label', isPwd ? 'Hide password' : 'Show password');
                });
            }

            if (sampleBtn && samplesPanel) {
                sampleBtn.addEventListener('click', () => {
                    const hidden = samplesPanel.classList.contains('hidden');
                    if (hidden) {
                        samplesPanel.classList.remove('hidden');
                        sampleBtn.setAttribute('aria-expanded', 'true');
                    } else {
                        samplesPanel.classList.add('hidden');
                        sampleBtn.setAttribute('aria-expanded', 'false');
                    }
                });
            }

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                loginButton.disabled = true;
                loginError.textContent = '';

                const username = usernameInput.value;
                const password = passwordInput.value;

                try {
                    const result = await api.login(username, password);
                    if (result.success) {
                        setAuthUser(result.user);
                    } else {
                        loginError.textContent = result.error || 'Login failed.';
                    }
                } catch (err) {
                    loginError.textContent = err.message || 'An unexpected error occurred during login.';
                } finally {
                    loginButton.disabled = false;
                }
            });
        };

        // --- Admin View ---
        const renderAdminView = async () => {
            let activeTab = sessionStorage.getItem('adminActiveTab') || 'dashboard';

            const adminHeaderHtml = `
                <header class="bg-gray-800 text-white p-4 shadow-md">
                    <div class="flex flex-col lg:flex-row justify-between items-center mb-4">
                        <h1 class="text-2xl font-bold mb-4 lg:mb-0">Admin Dashboard</h1>
                        
                        <!-- Global Search -->
                        <div class="relative w-full lg:w-96 mb-4 lg:mb-0">
                            <div class="flex">
                                <div class="relative flex-1">
                                    <input 
                                        type="text" 
                                        id="global-search-input" 
                                        placeholder="Search students, courses, grades..." 
                                        class="w-full pl-10 pr-4 py-2 text-gray-900 bg-white border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        autocomplete="off"
                                    >
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <button 
                                    id="advanced-search-button" 
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-r-lg border border-blue-600 focus:ring-2 focus:ring-blue-500"
                                    title="Advanced Search"
                                >
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                                    </svg>
                                </button>
                            </div>
                            
                            <!-- Search Results Dropdown -->
                            <div id="search-results-dropdown" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg z-50 max-h-96 overflow-y-auto hidden">
                                <div id="search-results-content" class="p-2"></div>
                            </div>
                        </div>
                    </div>
                    
                    <nav class="w-full">
                        <ul class="flex flex-wrap justify-center sm:justify-start gap-2 sm:gap-4 overflow-x-auto pb-2">
                            <li><button data-tab="dashboard" class="tab-button px-3 py-1 rounded-md text-sm font-medium">Dashboard</button></li>
                            <li><button data-tab="students" class="tab-button px-3 py-1 rounded-md text-sm font-medium">Students</button></li>
                            <li><button data-tab="courses" class="tab-button px-3 py-1 rounded-md text-sm font-medium">Courses</button></li>
                            <li><button data-tab="semesters" class="tab-button px-3 py-1 rounded-md text-sm font-medium">Semesters</button></li>
                            <li><button data-tab="grades" class="tab-button px-3 py-1 rounded-md text-sm font-medium">Grades</button></li>
                            <li><button data-tab="users" class="tab-button px-3 py-1 rounded-md text-sm font-medium">Users</button></li>
                            <li><button data-tab="bulk" class="tab-button px-3 py-1 rounded-md text-sm font-medium">Bulk Ops</button></li>
                            <li><button data-tab="reports" class="tab-button px-3 py-1 rounded-md text-sm font-medium">Reports</button></li>
                            <li><button data-tab="system" class="tab-button px-3 py-1 rounded-md text-sm font-medium">System</button></li>
                            <li><button id="logout-button" class="px-3 py-1 bg-red-600 rounded-md text-sm font-medium hover:bg-red-700">Logout</button></li>
                        </ul>
                    </nav>
                </header>
                
                <!-- Advanced Search Modal -->
                <div id="advanced-search-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                            <div class="p-6">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-2xl font-bold text-gray-900">Advanced Search & Filters</h2>
                                    <button id="close-advanced-search" class="text-gray-400 hover:text-gray-600">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                                
                                <div id="advanced-search-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <main class="p-4 sm:p-6 lg:p-8">
                    <div id="admin-content" class="bg-white p-6 rounded-lg shadow-sm">
                        </div>
                </main>
            `;
            appDiv.innerHTML = adminHeaderHtml;

            const adminContentDiv = document.getElementById('admin-content');
            const tabButtons = document.querySelectorAll('.tab-button');
            const logoutButton = document.getElementById('logout-button');

            const switchTab = (tabName) => {
                activeTab = tabName;
                sessionStorage.setItem('adminActiveTab', activeTab);
                tabButtons.forEach(btn => {
                    if (btn.dataset.tab === activeTab) {
                        btn.classList.add('bg-blue-600');
                        btn.classList.remove('hover:bg-gray-700');
                    } else {
                        btn.classList.remove('bg-blue-600');
                        btn.classList.add('hover:bg-gray-700');
                    }
                });
                renderAdminTabContent(activeTab);
            };

            tabButtons.forEach(button => {
                button.addEventListener('click', () => switchTab(button.dataset.tab));
            });

            logoutButton.addEventListener('click', () => {
                setAuthUser(null);
                sessionStorage.removeItem('adminActiveTab'); // Clear last active tab on logout
            });

            // Setup global search functionality
            setupGlobalSearch();

            // Initial render of the active tab content
            switchTab(activeTab);

            // --- Admin Tab Content Renderers ---
            async function renderAdminTabContent(tab) {
                adminContentDiv.innerHTML = `<p class="text-center text-gray-600 py-6">Loading ${tab} management...</p>`;
                try {
                    switch (tab) {
                        case 'dashboard':
                            await renderAdminDashboard(adminContentDiv);
                            break;
                        case 'students':
                            await renderAdminStudentManagement(adminContentDiv);
                            break;
                        case 'courses':
                            await renderAdminCourseManagement(adminContentDiv);
                            break;
                        case 'semesters':
                            await renderAdminSemesterManagement(adminContentDiv);
                            break;
                        case 'grades':
                            await renderAdminGradeManagement(adminContentDiv);
                            break;
                        case 'users':
                            await renderAdminUserManagement(adminContentDiv);
                            break;
                        case 'bulk':
                            await renderAdminBulkOperations(adminContentDiv);
                            break;
                        case 'reports':
                            await renderAdminReportManagement(adminContentDiv);
                            break;
                        case 'system':
                            await renderAdminSystemManagement(adminContentDiv);
                            break;
                        default:
                            adminContentDiv.innerHTML = `<p class="text-red-600 text-center py-6">Unknown tab selected.</p>`;
                    }
                } catch (error) {
                    adminContentDiv.innerHTML = `<p class="text-red-600 text-center py-6">Error loading ${tab} management: ${error.message}</p>`;
                }
            }
        };

        // --- Global Search Functionality ---
        const setupGlobalSearch = () => {
            const searchInput = document.getElementById('global-search-input');
            const searchResults = document.getElementById('search-results-dropdown');
            const searchContent = document.getElementById('search-results-content');
            const advancedSearchButton = document.getElementById('advanced-search-button');
            const advancedSearchModal = document.getElementById('advanced-search-modal');
            const closeAdvancedSearch = document.getElementById('close-advanced-search');
            
            let searchTimeout;
            let searchHistory = JSON.parse(localStorage.getItem('adminSearchHistory') || '[]');
            
            // Global search input handler
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                clearTimeout(searchTimeout);
                
                if (query.length < 2) {
                    hideSearchResults();
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    performGlobalSearch(query);
                }, 300);
            });
            
            // Hide results when clicking outside
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    hideSearchResults();
                }
            });
            
            // Advanced search modal handlers
            advancedSearchButton.addEventListener('click', () => {
                showAdvancedSearchModal();
            });
            
            closeAdvancedSearch.addEventListener('click', () => {
                hideAdvancedSearchModal();
            });
            
            advancedSearchModal.addEventListener('click', (e) => {
                if (e.target === advancedSearchModal) {
                    hideAdvancedSearchModal();
                }
            });
            
            // Escape key handler
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hideSearchResults();
                    hideAdvancedSearchModal();
                }
            });
        };
        
        const performGlobalSearch = async (query) => {
            try {
                const searchResults = document.getElementById('search-results-content');
                searchResults.innerHTML = '<div class="p-4 text-center text-gray-500">Searching...</div>';
                showSearchResults();
                
                // Search across multiple entities
                const [studentsResponse, coursesResponse] = await Promise.all([
                    api.fetchData(`/admin/search/students?q=${encodeURIComponent(query)}&limit=10`).catch(() => ({data: {results: []}})),
                    api.fetchData(`/admin/search/courses?q=${encodeURIComponent(query)}&limit=10`).catch(() => ({data: {results: []}}))
                ]);
                
                const students = studentsResponse.data.results || [];
                const courses = coursesResponse.data.results || [];
                
                renderSearchResults(query, { students, courses });
                
                // Save to search history
                saveSearchHistory(query);
                
            } catch (error) {
                console.error('Search error:', error);
                const searchResults = document.getElementById('search-results-content');
                searchResults.innerHTML = '<div class="p-4 text-center text-red-500">Search failed. Please try again.</div>';
            }
        };
        
        const renderSearchResults = (query, results) => {
            const searchContent = document.getElementById('search-results-content');
            const { students, courses } = results;
            
            const totalResults = students.length + courses.length;
            
            if (totalResults === 0) {
                searchContent.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        No results found for "${query}"
                        <div class="mt-2">
                            <button onclick="showAdvancedSearchModal('${query}')" class="text-blue-600 hover:text-blue-800 text-sm">
                                Try advanced search
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="p-2">
                    <div class="text-sm text-gray-600 mb-3">${totalResults} result(s) found for "${query}"</div>
            `;
            
            // Students section
            if (students.length > 0) {
                html += `
                    <div class="mb-4">
                        <h4 class="text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                            Students (${students.length})
                        </h4>
                        <div class="space-y-1">
                `;
                
                students.forEach(student => {
                    html += `
                        <div class="p-2 hover:bg-gray-50 rounded cursor-pointer border-l-2 border-blue-500" 
                             onclick="navigateToStudent('${student.student_id}')">
                            <div class="font-medium text-gray-900">${student.full_name}</div>
                            <div class="text-sm text-gray-600">${student.index_number} â€¢ ${student.program || 'No program'}</div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }
            
            // Courses section
            if (courses.length > 0) {
                html += `
                    <div class="mb-4">
                        <h4 class="text-sm font-semibold text-gray-700 mb-2 flex items-center">
                            <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                            Courses (${courses.length})
                        </h4>
                        <div class="space-y-1">
                `;
                
                courses.forEach(course => {
                    html += `
                        <div class="p-2 hover:bg-gray-50 rounded cursor-pointer border-l-2 border-green-500" 
                             onclick="navigateToCourse('${course.course_id}')">
                            <div class="font-medium text-gray-900">${course.course_title}</div>
                            <div class="text-sm text-gray-600">${course.course_code} â€¢ ${course.credits || 0} credits</div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }
            
            // View all results link
            html += `
                <div class="border-t pt-2 mt-2">
                    <button onclick="showAdvancedSearchModal('${query}')" 
                            class="w-full text-center py-2 text-sm text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded">
                        View all results & advanced filters
                    </button>
                </div>
            `;
            
            html += '</div>';
            searchContent.innerHTML = html;
        };
        
        const navigateToStudent = (studentId) => {
            hideSearchResults();
            switchTab('students');
        };
        
        const navigateToCourse = (courseId) => {
            hideSearchResults();
            switchTab('courses');
        };
        
        const showSearchResults = () => {
            document.getElementById('search-results-dropdown').classList.remove('hidden');
        };
        
        const hideSearchResults = () => {
            document.getElementById('search-results-dropdown').classList.add('hidden');
        };
        
        const showAdvancedSearchModal = (query = '') => {
            const modal = document.getElementById('advanced-search-modal');
            modal.classList.remove('hidden');
            renderAdvancedSearchContent(query);
        };
        
        const hideAdvancedSearchModal = () => {
            document.getElementById('advanced-search-modal').classList.add('hidden');
        };
        
        const renderAdvancedSearchContent = (initialQuery = '') => {
            const content = document.getElementById('advanced-search-content');
            content.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Search Query -->
                    <div class="lg:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search Query</label>
                        <input type="text" id="advanced-search-query" value="${initialQuery}" 
                               placeholder="Enter keywords..." 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <!-- Student Filters -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Student Filters</label>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Program</label>
                                <select id="filter-program" class="w-full p-2 border border-gray-300 rounded text-sm">
                                    <option value="">All Programs</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Year of Study</label>
                                <select id="filter-year" class="w-full p-2 border border-gray-300 rounded text-sm">
                                    <option value="">All Years</option>
                                    <option value="1">Year 1</option>
                                    <option value="2">Year 2</option>
                                    <option value="3">Year 3</option>
                                    <option value="4">Year 4</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Course Filters -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Course Filters</label>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Department</label>
                                <select id="filter-department" class="w-full p-2 border border-gray-300 rounded text-sm">
                                    <option value="">All Departments</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Credits</label>
                                <select id="filter-credits" class="w-full p-2 border border-gray-300 rounded text-sm">
                                    <option value="">All Credits</option>
                                    <option value="1">1 Credit</option>
                                    <option value="2">2 Credits</option>
                                    <option value="3">3 Credits</option>
                                    <option value="4">4+ Credits</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search Actions -->
                    <div class="lg:col-span-2 flex justify-between items-center pt-4 border-t">
                        <div>
                            <button onclick="clearAdvancedFilters()" 
                                    class="px-4 py-2 text-gray-600 hover:text-gray-800 text-sm">
                                Clear Filters
                            </button>
                        </div>
                        <div class="space-x-3">
                            <button onclick="hideAdvancedSearchModal()" 
                                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                                Cancel
                            </button>
                            <button onclick="performAdvancedSearch()" 
                                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Search
                            </button>
                        </div>
                    </div>
                    
                    <!-- Search Results -->
                    <div id="advanced-search-results" class="lg:col-span-2 mt-6">
                        <!-- Results will be displayed here -->
                    </div>
                </div>
            `;
        };
        
        const performAdvancedSearch = async () => {
            const query = document.getElementById('advanced-search-query').value.trim();
            const resultsDiv = document.getElementById('advanced-search-results');
            resultsDiv.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div><div class="mt-2 text-gray-600">Searching...</div></div>';
            
            try {
                const [studentsResponse, coursesResponse] = await Promise.all([
                    api.fetchData(`/admin/search/students?q=${encodeURIComponent(query)}&limit=50`).catch(() => ({data: {results: []}})),
                    api.fetchData(`/admin/search/courses?q=${encodeURIComponent(query)}&limit=50`).catch(() => ({data: {results: []}}))
                ]);
                
                const students = studentsResponse.data.results || [];
                const courses = coursesResponse.data.results || [];
                
                renderAdvancedSearchResults({ students, courses }, query);
                
            } catch (error) {
                console.error('Advanced search error:', error);
                resultsDiv.innerHTML = '<div class="text-center py-8 text-red-600">Search failed. Please try again.</div>';
            }
        };
        
        const renderAdvancedSearchResults = (results, query) => {
            const { students, courses } = results;
            const totalResults = students.length + courses.length;
            const resultsDiv = document.getElementById('advanced-search-results');
            
            if (totalResults === 0) {
                resultsDiv.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <p>No results found for "${query}"</p>
                        <p class="text-sm mt-2">Try adjusting your search terms</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="border border-gray-200 rounded-lg">
                    <div class="bg-gray-50 px-4 py-3 border-b">
                        <h3 class="font-semibold text-gray-900">Search Results (${totalResults} found)</h3>
                    </div>
                    <div class="divide-y divide-gray-200">
            `;
            
            // Render all results in a unified list
            const allResults = [
                ...students.map(s => ({ ...s, type: 'student', icon: 'ðŸ‘¤' })),
                ...courses.map(c => ({ ...c, type: 'course', icon: 'ðŸ“š' }))
            ];
            
            allResults.forEach(item => {
                html += `<div class="p-4 hover:bg-gray-50 cursor-pointer" onclick="navigate${item.type.charAt(0).toUpperCase() + item.type.slice(1)}('${item[item.type + '_id']}')">`;
                
                if (item.type === 'student') {
                    html += `
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">${item.icon}</span>
                            <div>
                                <div class="font-medium text-gray-900">${item.full_name}</div>
                                <div class="text-sm text-gray-600">${item.index_number} â€¢ ${item.program || 'No program'}</div>
                            </div>
                        </div>
                    `;
                } else if (item.type === 'course') {
                    html += `
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">${item.icon}</span>
                            <div>
                                <div class="font-medium text-gray-900">${item.course_title}</div>
                                <div class="text-sm text-gray-600">${item.course_code} â€¢ ${item.credits || 0} credits</div>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
            });
            
            html += '</div></div>';
            resultsDiv.innerHTML = html;
        };
        
        const clearAdvancedFilters = () => {
            document.getElementById('advanced-search-query').value = '';
            document.getElementById('filter-program').value = '';
            document.getElementById('filter-year').value = '';
            document.getElementById('filter-department').value = '';
            document.getElementById('filter-credits').value = '';
            document.getElementById('advanced-search-results').innerHTML = '';
        };
        
        const saveSearchHistory = (query) => {
            let history = JSON.parse(localStorage.getItem('adminSearchHistory') || '[]');
            history = history.filter(h => h !== query); // Remove if exists
            history.unshift(query); // Add to beginning
            history = history.slice(0, 10); // Keep only 10 items
            localStorage.setItem('adminSearchHistory', JSON.stringify(history));
        };

        // --- Admin Dashboard ---
        let dashboardDataCache = null;
        let dashboardChartsCache = {};
        
        const renderAdminDashboard = async (parentDiv) => {
            parentDiv.innerHTML = `
                <div>
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Analytics Dashboard</h3>
                        <button id="refresh-dashboard" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50">
                            <span id="refresh-text">Refresh Data</span>
                            <span id="refresh-spinner" class="hidden ml-2">ðŸ”„</span>
                        </button>
                    </div>
                    
                    <!-- Key Metrics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-blue-50 p-6 rounded-lg border border-blue-200 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="text-sm font-medium text-blue-600">Total Students</h4>
                                <span class="text-blue-500">ðŸ‘¥</span>
                            </div>
                            <p class="text-3xl font-bold text-blue-900 mb-1" id="total-students">-</p>
                            <p class="text-xs text-blue-600" id="students-growth">Loading...</p>
                        </div>
                        <div class="bg-green-50 p-6 rounded-lg border border-green-200 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="text-sm font-medium text-green-600">Total Courses</h4>
                                <span class="text-green-500">ðŸ“š</span>
                            </div>
                            <p class="text-3xl font-bold text-green-900 mb-1" id="total-courses">-</p>
                            <p class="text-xs text-green-600" id="courses-info">Loading...</p>
                        </div>
                        <div class="bg-purple-50 p-6 rounded-lg border border-purple-200 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="text-sm font-medium text-purple-600">Total Grades</h4>
                                <span class="text-purple-500">ðŸ“Š</span>
                            </div>
                            <p class="text-3xl font-bold text-purple-900 mb-1" id="total-grades">-</p>
                            <p class="text-xs text-purple-600" id="grades-info">Loading...</p>
                        </div>
                        <div class="bg-yellow-50 p-6 rounded-lg border border-yellow-200 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="text-sm font-medium text-yellow-600">Average GPA</h4>
                                <span class="text-yellow-500">ðŸŽ¯</span>
                            </div>
                            <p class="text-3xl font-bold text-yellow-900 mb-1" id="average-gpa">-</p>
                            <p class="text-xs text-yellow-600" id="gpa-range">Loading...</p>
                        </div>
                    </div>
                    
                    <!-- Additional Stats Row -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                            <h5 class="text-sm font-medium text-indigo-600 mb-2">Active Semesters</h5>
                            <p class="text-2xl font-bold text-indigo-900" id="active-semesters">-</p>
                        </div>
                        <div class="bg-pink-50 p-4 rounded-lg border border-pink-200">
                            <h5 class="text-sm font-medium text-pink-600 mb-2">Top Performing Program</h5>
                            <p class="text-lg font-semibold text-pink-900" id="top-program">Loading...</p>
                        </div>
                        <div class="bg-teal-50 p-4 rounded-lg border border-teal-200">
                            <h5 class="text-sm font-medium text-teal-600 mb-2">Recent Activity</h5>
                            <p class="text-sm text-teal-900" id="recent-activity">Loading...</p>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Grade Distribution Chart -->
                        <div class="bg-white p-4 rounded-lg border border-gray-200">
                            <h4 class="text-lg font-semibold mb-3 text-gray-800">Grade Distribution</h4>
                            <div class="relative h-64">
                                <canvas id="gradeDistributionChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- GPA Trends Chart -->
                        <div class="bg-white p-4 rounded-lg border border-gray-200">
                            <h4 class="text-lg font-semibold mb-3 text-gray-800">GPA Trends by Semester</h4>
                            <div class="relative h-64">
                                <canvas id="gpaTrendsChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Student Performance Chart -->
                        <div class="bg-white p-4 rounded-lg border border-gray-200">
                            <h4 class="text-lg font-semibold mb-3 text-gray-800">Performance by Program</h4>
                            <div class="relative h-64">
                                <canvas id="programPerformanceChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Course Popularity Chart -->
                        <div class="bg-white p-4 rounded-lg border border-gray-200">
                            <h4 class="text-lg font-semibold mb-3 text-gray-800">Course Enrollment</h4>
                            <div class="relative h-64">
                                <canvas id="coursePopularityChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Load dashboard data and render charts
            await loadDashboardData();
            
            // Add refresh functionality
            document.getElementById('refresh-dashboard').addEventListener('click', async () => {
                const refreshBtn = document.getElementById('refresh-dashboard');
                const refreshText = document.getElementById('refresh-text');
                const refreshSpinner = document.getElementById('refresh-spinner');
                
                refreshBtn.disabled = true;
                refreshText.textContent = 'Refreshing...';
                refreshSpinner.classList.remove('hidden');
                
                try {
                    // Clear cache and reload
                    dashboardDataCache = null;
                    dashboardChartsCache = {};
                    await loadDashboardData(true);
                } finally {
                    refreshBtn.disabled = false;
                    refreshText.textContent = 'Refresh Data';
                    refreshSpinner.classList.add('hidden');
                }
            });
        };

        const loadDashboardData = async (forceRefresh = false) => {
            try {
                // Use cache if available and not forcing refresh
                if (dashboardDataCache && !forceRefresh) {
                    updateDashboardUI(dashboardDataCache);
                    return;
                }
                
                // Show loading states
                showDashboardLoading();
                
                // Load key metrics
                const [studentsResponse, coursesResponse, gradesResponse, gpaData, semestersResponse, insightsData] = await Promise.all([
                    api.fetchData('/admin/students?limit=1'),
                    api.fetchData('/admin/courses?limit=1'),
                    api.fetchData('/admin/grades?limit=1'),
                    api.fetchData('/admin/analytics/gpa-stats'),
                    api.fetchData('/admin/semesters?limit=100'),
                    api.fetchData('/admin/analytics/dashboard-insights')
                ]);

                // Cache the data
                dashboardDataCache = {
                    students: studentsResponse.data,
                    courses: coursesResponse.data,
                    grades: gradesResponse.data,
                    gpaStats: gpaData.data,
                    semesters: semestersResponse.data,
                    insights: insightsData.data
                };
                
                // Update UI
                updateDashboardUI(dashboardDataCache);
                
                // Load chart data only if not cached or forcing refresh
                if (Object.keys(dashboardChartsCache).length === 0 || forceRefresh) {
                    await Promise.all([
                        renderGradeDistributionChart(),
                        renderGPATrendsChart(),
                        renderProgramPerformanceChart(),
                        renderCoursePopularityChart()
                    ]);
                }

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showDashboardError(error.message);
            }
        };
        
        const showDashboardLoading = () => {
            const loadingElements = ['total-students', 'total-courses', 'total-grades', 'average-gpa', 'active-semesters'];
            loadingElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.innerHTML = '<div class="animate-pulse bg-gray-300 h-6 w-16 rounded"></div>';
            });
            
            const textElements = ['students-growth', 'courses-info', 'grades-info', 'gpa-range', 'top-program', 'recent-activity'];
            textElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = 'Loading...';
            });
        };
        
        const updateDashboardUI = (data) => {
            // Update metric cards with correct field names
            document.getElementById('total-students').textContent = data.students.total_count || 0;
            document.getElementById('total-courses').textContent = data.courses.total_count || 0;
            document.getElementById('total-grades').textContent = data.grades.total_count || 0;
            document.getElementById('average-gpa').textContent = data.gpaStats.average_gpa?.toFixed(2) || 'N/A';
            
            // Update additional info with more insights
            const totalStudents = data.students.total_count || 0;
            const totalCourses = data.courses.total_count || 0;
            const totalGrades = data.grades.total_count || 0;
            const avgGradesPerStudent = totalStudents > 0 ? Math.round(totalGrades / totalStudents) : 0;
            
            document.getElementById('students-growth').textContent = `${totalStudents} enrolled`;
            document.getElementById('courses-info').textContent = `${totalCourses} active courses`;
            document.getElementById('grades-info').textContent = `${avgGradesPerStudent} avg grades/student`;
            document.getElementById('gpa-range').textContent = data.gpaStats.min_gpa && data.gpaStats.max_gpa ? 
                `Range: ${data.gpaStats.min_gpa.toFixed(2)} - ${data.gpaStats.max_gpa.toFixed(2)}` : 'No range data';
            
            // Update semester count from semesters data
            const totalSemesters = data.semesters.total_count || (data.semesters.semesters ? data.semesters.semesters.length : 0);
            document.getElementById('active-semesters').textContent = totalSemesters;
            
            // Update recent activity with actual data
            if (data.insights && data.insights.recent_activities && data.insights.recent_activities.length > 0) {
                const latest = data.insights.recent_activities[0];
                const timeAgo = latest.created_at ? formatTimeAgo(latest.created_at) : 'recently';
                document.getElementById('recent-activity').textContent = `Latest: ${latest.student_name} - ${latest.grade} in ${latest.course_name} (${timeAgo})`;
            } else {
                document.getElementById('recent-activity').textContent = 'No recent activity';
            }
            
            // Update active semester info
            if (data.insights && data.insights.active_semester) {
                const activeSem = data.insights.active_semester;
                document.getElementById('active-semesters').textContent = `${activeSem.semester_name} ${activeSem.academic_year}`;
            }
        };
        
        const formatTimeAgo = (dateString) => {
            try {
                const date = new Date(dateString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                return `${diffDays}d ago`;
            } catch {
                return 'recently';
            }
        };
        
        const showDashboardError = (message) => {
            ['total-students', 'total-courses', 'total-grades', 'average-gpa', 'active-semesters'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = 'Error';
            });
            
            ['students-growth', 'courses-info', 'grades-info', 'gpa-range', 'top-program', 'recent-activity'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = `Error: ${message}`;
            });
        };

        const renderGradeDistributionChart = async () => {
            try {
                if (dashboardChartsCache.gradeDistribution) {
                    return; // Chart already rendered
                }
                
                const response = await api.fetchData('/admin/analytics/grade-distribution');
                const ctx = document.getElementById('gradeDistributionChart').getContext('2d');
                
                dashboardChartsCache.gradeDistribution = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: response.data.labels,
                        datasets: [{
                            data: response.data.values,
                            backgroundColor: [
                                '#10B981', // A
                                '#3B82F6', // B
                                '#F59E0B', // C
                                '#EF4444', // D
                                '#6B7280'  // F
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    usePointStyle: true,
                                    font: { size: 12 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return `${context.label}: ${context.parsed} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error rendering grade distribution chart:', error);
            }
        };

        const renderGPATrendsChart = async () => {
            try {
                if (dashboardChartsCache.gpaTrends) {
                    return; // Chart already rendered
                }
                
                const response = await api.fetchData('/admin/analytics/gpa-trends');
                const ctx = document.getElementById('gpaTrendsChart').getContext('2d');
                
                dashboardChartsCache.gpaTrends = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: response.data.semesters,
                        datasets: [{
                            label: 'Average GPA',
                            data: response.data.gpa_values,
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            pointBackgroundColor: '#3B82F6',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 4.0,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                },
                                ticks: {
                                    font: { size: 11 }
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: { size: 11 },
                                    maxRotation: 45
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error rendering GPA trends chart:', error);
            }
        };

        const renderProgramPerformanceChart = async () => {
            try {
                if (dashboardChartsCache.programPerformance) {
                    return; // Chart already rendered
                }
                
                const response = await api.fetchData('/admin/analytics/program-performance');
                const ctx = document.getElementById('programPerformanceChart').getContext('2d');
                
                dashboardChartsCache.programPerformance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: response.data.programs,
                        datasets: [{
                            label: 'Average GPA',
                            data: response.data.gpa_values,
                            backgroundColor: 'rgba(168, 85, 247, 0.7)',
                            borderColor: 'rgba(168, 85, 247, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 4.0,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                },
                                ticks: {
                                    font: { size: 11 }
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: { size: 10 },
                                    maxRotation: 45
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error rendering program performance chart:', error);
            }
        };

        const renderCoursePopularityChart = async () => {
            try {
                if (dashboardChartsCache.coursePopularity) {
                    return; // Chart already rendered
                }
                
                const [courseResponse, programResponse] = await Promise.all([
                    api.fetchData('/admin/analytics/course-enrollment'),
                    api.fetchData('/admin/analytics/program-performance')
                ]);
                
                const ctx = document.getElementById('coursePopularityChart').getContext('2d');
                
                dashboardChartsCache.coursePopularity = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: courseResponse.data.courses,
                        datasets: [{
                            label: 'Enrollment Count',
                            data: courseResponse.data.enrollment_counts,
                            backgroundColor: 'rgba(34, 197, 94, 0.7)',
                            borderColor: 'rgba(34, 197, 94, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                },
                                ticks: {
                                    font: { size: 11 }
                                }
                            },
                            y: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: { size: 10 }
                                }
                            }
                        }
                    }
                });
                
                // Update top program info
                if (programResponse.data.programs && programResponse.data.programs.length > 0) {
                    document.getElementById('top-program').textContent = programResponse.data.programs[0];
                }
                
            } catch (error) {
                console.error('Error rendering course popularity chart:', error);
                document.getElementById('top-program').textContent = 'Data unavailable';
            }
        };

        // --- Admin Student Management ---
        const renderAdminStudentManagement = async (parentDiv) => {
            parentDiv.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Student Management</h3>

                    <div class="mb-6 p-4 border border-gray-200 rounded-md bg-gray-50">
                        <h4 class="text-lg font-semibold mb-3 text-gray-700">Add New Student</h4>
                        <form id="add-student-form" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <input type="text" id="new-student-index" placeholder="Index Number (e.g., ug12345)" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                            <input type="text" id="new-student-name" placeholder="Full Name" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                            <input type="date" id="new-student-dob" placeholder="Date of Birth" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            <input type="text" id="new-student-gender" placeholder="Gender" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            <input type="email" id="new-student-email" placeholder="Contact Email" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            <input type="tel" id="new-student-phone" placeholder="Phone" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            <input type="text" id="new-student-program" placeholder="Program" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                            <input type="number" id="new-student-year" placeholder="Year of Study" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" min="1" max="10" />
                            <button type="submit" id="add-student-button" class="col-span-full bg-green-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-green-700 disabled:opacity-50">
                                Add Student
                            </button>
                        </form>
                        <p id="add-student-message" class="mt-3 text-center text-sm"></p>
                        <p id="add-student-error" class="mt-3 text-center text-sm"></p>
                    </div>

                    <div class="mb-6 bg-white p-6 border border-gray-200 rounded-lg shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-gray-800 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                Search & Filter Students
                            </h4>
                            <button id="toggle-advanced-filters" class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
                                <span id="toggle-text">Show Advanced Filters</span>
                                <svg id="toggle-icon" class="w-4 h-4 ml-1 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Quick Search Bar -->
                        <div class="relative mb-4">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <input 
                                type="text" 
                                id="search-term" 
                                placeholder="Search students by name, index number, or email... (Press Enter to search, Esc to clear)" 
                                class="block w-full pl-10 pr-12 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm transition-colors"
                                autocomplete="off"
                            />
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                                <div id="search-spinner" class="hidden">
                                    <svg class="animate-spin h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                                <button id="clear-search" class="hidden text-gray-400 hover:text-gray-600 ml-2">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            
                            <!-- Autocomplete Dropdown -->
                            <div id="search-autocomplete" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg mt-1 z-50 hidden max-h-60 overflow-y-auto">
                                <div id="search-suggestions" class="py-1"></div>
                                <div id="search-history" class="border-t border-gray-200 hidden">
                                    <div class="px-4 py-2 text-xs font-medium text-gray-500 bg-gray-50">Recent Searches</div>
                                    <div id="search-history-items" class="py-1"></div>
                                </div>
                                <div id="search-help" class="border-t border-gray-200 px-4 py-2 text-xs text-gray-500 bg-gray-50">
                                    <div class="flex items-center justify-between">
                                        <span>ðŸ’¡ Tip: Use <kbd class="px-1 py-0.5 bg-gray-200 rounded text-xs">Enter</kbd> to search, <kbd class="px-1 py-0.5 bg-gray-200 rounded text-xs">Esc</kbd> to clear</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Filters (Initially Hidden) -->
                        <div id="advanced-filters" class="hidden border-t pt-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                <!-- Program Filter -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Program</label>
                                    <select id="search-program" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                                        <option value="">All Programs</option>
                                        <option value="Computer Science">Computer Science</option>
                                        <option value="Information Technology">Information Technology</option>
                                        <option value="Software Engineering">Software Engineering</option>
                                        <option value="Data Science">Data Science</option>
                                        <option value="Cybersecurity">Cybersecurity</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>

                                <!-- Year Filter -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Year of Study</label>
                                    <select id="search-year" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                                        <option value="">All Years</option>
                                        <option value="1">Year 1</option>
                                        <option value="2">Year 2</option>
                                        <option value="3">Year 3</option>
                                        <option value="4">Year 4</option>
                                        <option value="5+">Year 5+</option>
                                    </select>
                                </div>

                                <!-- Gender Filter -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Gender</label>
                                    <select id="search-gender" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                                        <option value="">All Genders</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Other">Other</option>
                                        <option value="Prefer not to say">Prefer not to say</option>
                                    </select>
                                </div>

                                <!-- Sort By -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                                    <select id="sort-by" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                                        <option value="name_asc">Name (A-Z)</option>
                                        <option value="name_desc">Name (Z-A)</option>
                                        <option value="index_asc">Index Number (Low to High)</option>
                                        <option value="index_desc">Index Number (High to Low)</option>
                                        <option value="program_asc">Program (A-Z)</option>
                                        <option value="year_asc">Year (Low to High)</option>
                                        <option value="year_desc">Year (High to Low)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Filter Actions -->
                            <div class="flex flex-wrap items-center justify-between gap-3">
                                <div class="flex flex-wrap gap-2" id="active-filters">
                                    <!-- Active filter badges will appear here -->
                                </div>
                                <div class="flex gap-2">
                                    <button id="clear-all-filters" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                                        Clear All
                                    </button>
                                    <button id="apply-filters" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707v4.586a1 1 0 01-1.447.894l-4-2A1 1 0 018 15.586V11.414a1 1 0 00-.293-.707L1.293 4.293A1 1 0 011 3.586V1a1 1 0 011-1z"></path>
                                        </svg>
                                        Apply Filters
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Search Results Summary -->
                        <div id="search-results-summary" class="hidden mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center text-sm text-blue-700">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span id="results-text">Found 0 students</span>
                                </div>
                                <button id="export-results" class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    Export
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6 bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-xl font-semibold text-gray-800">Student Directory</h4>
                                <p class="text-sm text-gray-600 mt-1">Manage student profiles and perform bulk operations</p>
                            </div>
                            <div class="flex items-center space-x-3">
                                <!-- Page Size Selector -->
                                <div class="flex items-center space-x-2">
                                    <label for="students-per-page" class="text-sm text-gray-600">Per page:</label>
                                    <select id="students-per-page" class="border border-gray-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="10">10</option>
                                        <option value="20" selected>20</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                                <button id="load-all-students-button" data-loaded="false" class="bg-green-600 text-white py-2.5 px-5 rounded-lg font-medium hover:bg-green-700 focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:opacity-50 transition-colors">
                                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                    </svg>
                                    Load Students
                                </button>
                            </div>
                        </div>
                        
                        <!-- Pagination Info Bar -->
                        <div id="students-pagination-info" class="hidden mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex items-center justify-between text-sm">
                                <div id="students-count-info" class="text-blue-800"></div>
                                <div id="students-loading-progress" class="text-blue-600"></div>
                            </div>
                        </div>
                        
                        <!-- Bulk Operations Panel - Always visible but contextual -->
                        <div id="bulk-operations-panel" class="border-t border-gray-200 pt-4 opacity-50 transition-opacity duration-300">
                            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                                <div class="flex items-center gap-4">
                                    <label class="flex items-center gap-2 cursor-pointer text-sm text-gray-600">
                                        <input type="checkbox" id="select-all-students" class="select-all-checkbox rounded" disabled />
                                        <span id="selection-text">Select students for bulk operations</span>
                                    </label>
                                    <div class="selection-counter hidden" id="selection-counter">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            <span id="selected-count">0</span> selected
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="flex gap-2">
                                    <button id="bulk-export" class="bulk-action-btn-new export" disabled title="Export selected students">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        Export
                                    </button>
                                    <button id="bulk-edit" class="bulk-action-btn-new edit" disabled title="Edit selected students">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                        Edit
                                    </button>
                                    <button id="bulk-delete" class="bulk-action-btn-new delete" disabled title="Delete selected students">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    
                    
                    <p id="student-list-error" class="text-red-600 text-center py-6 hidden"></p>
                    <div id="student-list-container" class="rounded-md">
                        <div class="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">No students loaded</h3>
                            <p class="mt-1 text-sm text-gray-500">Click "Load Students" to view all students or use search filters to find specific students.</p>
                        </div>
                    </div>
                    
                    <!-- Pagination Controls -->
                    <div id="students-pagination-controls" class="hidden mt-6 flex items-center justify-between bg-white px-4 py-3 border border-gray-200 rounded-lg">
                        <div class="flex items-center text-sm text-gray-700">
                            <span id="students-pagination-showing">Showing 1 to 20 of 100 students</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="students-pagination-first" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                First
                            </button>
                            <button id="students-pagination-prev" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Previous
                            </button>
                            <div id="students-pagination-pages" class="flex items-center space-x-1">
                                <!-- Page numbers will be dynamically inserted here -->
                            </div>
                            <button id="students-pagination-next" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                Next
                            </button>
                            <button id="students-pagination-last" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                Last
                            </button>
                        </div>
                    </div>
                </div>
            `;

            const addStudentForm = document.getElementById('add-student-form');
            const addStudentButton = document.getElementById('add-student-button');
            const addStudentMessage = document.getElementById('add-student-message');
            const addStudentError = document.getElementById('add-student-error');

            const searchStudentsButton = document.getElementById('search-students-button');
            const loadAllStudentsButton = document.getElementById('load-all-students-button');
            const searchTermInput = document.getElementById('search-term');
            const searchProgramInput = document.getElementById('search-program');
            const searchYearInput = document.getElementById('search-year');
            const searchGenderInput = document.getElementById('search-gender');

            // Add null checks to prevent errors
            if (!loadAllStudentsButton) {
                console.error('Load Students button not found in DOM');
                return;
            }

            // --- Updated Student Management with Enhanced Pagination ---
            const studentListContainer = document.getElementById('student-list-container');
            const studentListError = document.getElementById('student-list-error');

            // Initialize pagination manager for students
            let studentPaginationManager = null;
            let studentPaginationUI = null;
            let studentSearchInterface = null;
            let studentVirtualScroll = null;
            let useVirtualScrolling = false; // Toggle for virtual scrolling vs traditional pagination

            // Simple Students Pagination State
            let studentsPaginationState = {
                currentPage: 1,
                pageSize: 20,
                totalStudents: 0,
                totalPages: 0,
                allStudents: [],
                isLoaded: false
            };

            // Initialize simple students pagination controls
            const initializeStudentsPagination = () => {
                const pageSize = document.getElementById('students-per-page');
                const paginationInfo = document.getElementById('students-pagination-info');
                const countInfo = document.getElementById('students-count-info');
                const progressInfo = document.getElementById('students-loading-progress');
                const paginationControls = document.getElementById('students-pagination-controls');
                const showingText = document.getElementById('students-pagination-showing');
                const firstBtn = document.getElementById('students-pagination-first');
                const prevBtn = document.getElementById('students-pagination-prev');
                const nextBtn = document.getElementById('students-pagination-next');
                const lastBtn = document.getElementById('students-pagination-last');
                const pagesContainer = document.getElementById('students-pagination-pages');

                // Page size change handler
                pageSize.addEventListener('change', (e) => {
                    studentsPaginationState.pageSize = parseInt(e.target.value);
                    studentsPaginationState.currentPage = 1;
                    if (studentsPaginationState.isLoaded) {
                        renderStudentsPage();
                        updateStudentsPaginationUI();
                    }
                });

                // Navigation button handlers
                firstBtn.addEventListener('click', () => {
                    if (studentsPaginationState.currentPage > 1) {
                        studentsPaginationState.currentPage = 1;
                        renderStudentsPage();
                        updateStudentsPaginationUI();
                    }
                });

                prevBtn.addEventListener('click', () => {
                    if (studentsPaginationState.currentPage > 1) {
                        studentsPaginationState.currentPage--;
                        renderStudentsPage();
                        updateStudentsPaginationUI();
                    }
                });

                nextBtn.addEventListener('click', () => {
                    if (studentsPaginationState.currentPage < studentsPaginationState.totalPages) {
                        studentsPaginationState.currentPage++;
                        renderStudentsPage();
                        updateStudentsPaginationUI();
                    }
                });

                lastBtn.addEventListener('click', () => {
                    if (studentsPaginationState.currentPage < studentsPaginationState.totalPages) {
                        studentsPaginationState.currentPage = studentsPaginationState.totalPages;
                        renderStudentsPage();
                        updateStudentsPaginationUI();
                    }
                });
            };

            // Update pagination UI state
            const updateStudentsPaginationUI = () => {
                const showingText = document.getElementById('students-pagination-showing');
                const firstBtn = document.getElementById('students-pagination-first');
                const prevBtn = document.getElementById('students-pagination-prev');
                const nextBtn = document.getElementById('students-pagination-next');
                const lastBtn = document.getElementById('students-pagination-last');
                const pagesContainer = document.getElementById('students-pagination-pages');
                const paginationControls = document.getElementById('students-pagination-controls');

                if (!studentsPaginationState.isLoaded || studentsPaginationState.totalStudents === 0) {
                    paginationControls.classList.add('hidden');
                    return;
                }

                // Calculate display ranges
                const startRecord = (studentsPaginationState.currentPage - 1) * studentsPaginationState.pageSize + 1;
                const endRecord = Math.min(studentsPaginationState.currentPage * studentsPaginationState.pageSize, studentsPaginationState.totalStudents);

                // Update showing text
                showingText.textContent = `Showing ${startRecord} to ${endRecord} of ${studentsPaginationState.totalStudents} students`;

                // Update button states
                firstBtn.disabled = studentsPaginationState.currentPage <= 1;
                prevBtn.disabled = studentsPaginationState.currentPage <= 1;
                nextBtn.disabled = studentsPaginationState.currentPage >= studentsPaginationState.totalPages;
                lastBtn.disabled = studentsPaginationState.currentPage >= studentsPaginationState.totalPages;

                // Generate page numbers
                generateStudentPageNumbers();

                // Show pagination controls
                paginationControls.classList.remove('hidden');
            };

            // Generate page number buttons
            const generateStudentPageNumbers = () => {
                const pagesContainer = document.getElementById('students-pagination-pages');
                pagesContainer.innerHTML = '';

                const currentPage = studentsPaginationState.currentPage;
                const totalPages = studentsPaginationState.totalPages;

                // Show max 5 page numbers
                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, startPage + 4);
                
                // Adjust if we're near the end
                if (endPage - startPage < 4) {
                    startPage = Math.max(1, endPage - 4);
                }

                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.textContent = i;
                    pageBtn.className = `px-3 py-1 text-sm border rounded hover:bg-gray-50 ${
                        i === currentPage 
                            ? 'bg-blue-600 text-white border-blue-600 font-medium' 
                            : 'border-gray-300'
                    }`;
                    
                    if (i !== currentPage) {
                        pageBtn.addEventListener('click', () => {
                            studentsPaginationState.currentPage = i;
                            renderStudentsPage();
                            updateStudentsPaginationUI();
                        });
                    }
                    
                    pagesContainer.appendChild(pageBtn);
                }
            };

            // Render current page of students
            const renderStudentsPage = () => {
                const startIndex = (studentsPaginationState.currentPage - 1) * studentsPaginationState.pageSize;
                const endIndex = startIndex + studentsPaginationState.pageSize;
                const pageStudents = studentsPaginationState.allStudents.slice(startIndex, endIndex);
                
                renderStudentCards(pageStudents);
            };

            // Load all students with progress tracking and chunked loading
            const loadAllStudentsWithPagination = async () => {
                const paginationInfo = document.getElementById('students-pagination-info');
                const countInfo = document.getElementById('students-count-info');
                const progressInfo = document.getElementById('students-loading-progress');

                try {
                    // Show loading info
                    paginationInfo.classList.remove('hidden');
                    progressInfo.textContent = 'Loading students...';
                    
                    // Start with empty array and load in chunks
                    let allStudents = [];
                    let skip = 0;
                    const chunkSize = 1000; // Maximum allowed by backend
                    let hasMore = true;
                    let totalFetched = 0;

                    while (hasMore) {
                        progressInfo.textContent = `Loading students... (${totalFetched} loaded)`;
                        
                        const response = await api.searchStudents({}, skip, chunkSize);
                        
                        if (response.success && response.data.students) {
                            const students = response.data.students;
                            allStudents = allStudents.concat(students);
                            totalFetched += students.length;
                            
                            // Update progress
                            countInfo.textContent = `Loaded ${totalFetched} students`;
                            
                            // Check if we got fewer records than requested (indicating end of data)
                            if (students.length < chunkSize) {
                                hasMore = false;
                            } else {
                                skip += chunkSize;
                            }
                        } else {
                            hasMore = false;
                            if (!response.success) {
                                throw new Error(response.message || 'Failed to load students');
                            }
                        }
                    }

                    // Update pagination state
                    studentsPaginationState.allStudents = allStudents;
                    studentsPaginationState.totalStudents = allStudents.length;
                    studentsPaginationState.totalPages = Math.ceil(allStudents.length / studentsPaginationState.pageSize);
                    studentsPaginationState.currentPage = 1;
                    studentsPaginationState.isLoaded = true;
                    
                    // Update UI
                    countInfo.textContent = `Loaded ${studentsPaginationState.totalStudents} students`;
                    progressInfo.textContent = 'Ready';
                    
                    // Render first page
                    renderStudentsPage();
                    updateStudentsPaginationUI();
                    
                    // Auto-hide info after success
                    setTimeout(() => {
                        paginationInfo.classList.add('hidden');
                    }, 2000);
                    
                } catch (error) {
                    console.error('Error loading students:', error);
                    progressInfo.textContent = 'Error loading students';
                    countInfo.textContent = error.message;
                    studentListContainer.innerHTML = `<p class="text-red-600 text-center py-6">${error.message}</p>`;
                }
            };

            const initializeStudentPagination = () => {
                // Create pagination manager
                studentPaginationManager = new PaginationManager('/admin/students/search', 20);
                
                // Create search interface
                const searchContainer = document.createElement('div');
                searchContainer.id = 'student-search-interface';
                studentListContainer.parentNode.insertBefore(searchContainer, studentListContainer);
                
                studentSearchInterface = new EnhancedSearchInterface(
                    searchContainer,
                    studentPaginationManager,
                    (data) => handleStudentDataUpdate(data)
                );

                // Create pagination UI container
                const paginationContainer = document.createElement('div');
                paginationContainer.id = 'student-pagination';
                studentListContainer.parentNode.insertBefore(paginationContainer, studentListContainer.nextSibling);
                
                studentPaginationUI = new PaginationUI(
                    paginationContainer,
                    studentPaginationManager,
                    (data) => handleStudentDataUpdate(data)
                );

                // Initialize virtual scrolling for large datasets
                if (useVirtualScrolling) {
                    studentVirtualScroll = new StudentVirtualScroll(
                        studentListContainer,
                        handleStudentEdit,
                        handleStudentDelete
                    );
                }
            };

            const handleStudentDataUpdate = (data) => {
                console.log('handleStudentDataUpdate called with:', data); // Debug log
                if (data && data.records) {
                    console.log('Found', data.records.length, 'student records'); // Debug log
                    if (useVirtualScrolling && studentVirtualScroll) {
                        studentVirtualScroll.setData(data.records);
                    } else {
                        renderStudentCards(data.records);
                    }
                    
                    // Only render pagination if it's initialized
                    if (studentPaginationUI) {
                        studentPaginationUI.render();
                    }
                    
                    // Update program options in search interface
                    if (studentSearchInterface) {
                        const programs = [...new Set(data.records.map(s => s.program).filter(Boolean))];
                        studentSearchInterface.updateProgramOptions(programs);
                    }
                } else {
                    console.log('No data or no records found:', data); // Debug log
                }
            };

            const handleStudentEdit = (student, indexNumber) => {
                openStudentEditModal(
                    indexNumber,
                    student.full_name,
                    student.contact_email || '',
                    student.program || '',
                    student.year_of_study || ''
                );
            };

            const handleStudentDelete = (student, indexNumber) => {
                openConfirmationModal(
                    'Confirm Deletion',
                    `Are you sure you want to delete student ${student.full_name} (${indexNumber})?`,
                    async () => {
                        try {
                            const result = await api.deleteStudent(indexNumber);
                            if (result.success) {
                                showToast(result.message, 'success');
                                await refreshStudentData();
                            } else {
                                showToast(result.message, 'error');
                            }
                        } catch (error) {
                            showToast('Failed to delete student: ' + error.message, 'error');
                        }
                    }
                );
            };

            const refreshStudentData = async () => {
                try {
                    const data = await studentPaginationManager.goToPage(studentPaginationManager.currentPage);
                    handleStudentDataUpdate(data);
                } catch (error) {
                    showToast('Failed to refresh data: ' + error.message, 'error');
                }
            };

            let isLoadingStudents = false; // Prevent duplicate calls
            
            const fetchAndRenderStudents = async (useFilters = true) => {
                if (isLoadingStudents) {
                    console.log('Already loading students, skipping duplicate call');
                    return;
                }
                
                isLoadingStudents = true;
                console.log('fetchAndRenderStudents called with useFilters:', useFilters);
                
                // Show skeleton loading instead of basic loading
                showSkeletonLoading();
                studentListError.classList.add('hidden');

                try {
                    // Initialize pagination if not already done
                    if (!studentPaginationManager) {
                        initializeStudentPagination();
                    }

                    // Build filters from enhanced search interface
                    const filters = {};
                    if (useFilters) {
                        // Get values from enhanced search interface
                        const searchTermInput = document.getElementById('search-term');
                        const searchProgramInput = document.getElementById('search-program');
                        const searchYearInput = document.getElementById('search-year');
                        const searchGenderInput = document.getElementById('search-gender');
                        const sortByInput = document.getElementById('sort-by');

                        if (searchTermInput?.value?.trim()) filters.name = searchTermInput.value.trim();
                        if (searchProgramInput?.value) filters.program = searchProgramInput.value;
                        if (searchYearInput?.value) filters.year_of_study = parseInt(searchYearInput.value);
                        if (searchGenderInput?.value) filters.gender = searchGenderInput.value;
                        
                        // Handle sorting
                        if (sortByInput?.value) {
                            const sortValue = sortByInput.value;
                            if (sortValue === 'name_asc') {
                                filters.order_by = 'full_name';
                                filters.order_direction = 'asc';
                            } else if (sortValue === 'name_desc') {
                                filters.order_by = 'full_name';
                                filters.order_direction = 'desc';
                            } else if (sortValue === 'id_asc') {
                                filters.order_by = 'id';
                                filters.order_direction = 'asc';
                            } else if (sortValue === 'id_desc') {
                                filters.order_by = 'id';
                                filters.order_direction = 'desc';
                            }
                        }
                    }

                    // Check if search is active (any filters applied)
                    const isSearchActive = Object.keys(filters).length > 0;

                    // Update search results summary
                    if (window.updateSearchResultsSummary) {
                        // We'll update this after getting the results
                    }

                    // Use the new pagination system
                    console.log('Searching with filters:', filters); // Debug log
                    await studentPaginationManager.search(filters, 0);
                    const data = await studentPaginationManager.goToPage(1);
                    console.log('Received data:', data); // Debug log
                    
                    if (data && data.records && data.records.length > 0) {
                        handleStudentDataUpdate(data);
                        // Update search results summary
                        if (window.updateSearchResultsSummary) {
                            window.updateSearchResultsSummary(data.totalCount || data.records.length, isSearchActive);
                        }
                    } else {
                        console.log('No data received, trying fallback API call'); // Debug log
                        // Fallback to old API call if pagination fails
                        const fallbackData = await api.searchStudents(filters, 0, 20);
                        console.log('Fallback API response:', fallbackData); // Debug log
                        
                        if (fallbackData.success && fallbackData.data.students) {
                            // Create a data structure compatible with handleStudentDataUpdate
                            const compatibleData = {
                                records: fallbackData.data.students,
                                totalCount: fallbackData.data.total_count || fallbackData.data.students.length,
                                pagination: { skip: 0, limit: 20 }
                            };
                            
                            console.log('Compatible data for fallback:', compatibleData); // Debug log
                            
                            // Update pagination manager state BEFORE calling handleStudentDataUpdate
                            if (studentPaginationManager) {
                                studentPaginationManager.totalRecords = compatibleData.totalCount;
                                studentPaginationManager.totalPages = Math.ceil(compatibleData.totalCount / studentPaginationManager.pageSize);
                                studentPaginationManager.currentPage = 1;
                                console.log('Updated pagination manager - totalRecords:', studentPaginationManager.totalRecords, 'totalPages:', studentPaginationManager.totalPages); // Debug log
                            }
                            
                            handleStudentDataUpdate(compatibleData);
                            // Update search results summary for fallback
                            if (window.updateSearchResultsSummary) {
                                window.updateSearchResultsSummary(compatibleData.totalCount, isSearchActive);
                            }
                        } else {
                            studentListContainer.innerHTML = `<p class="text-gray-600 text-center py-6">No students found.</p>`;
                            // Update search results summary for no results
                            if (window.updateSearchResultsSummary) {
                                window.updateSearchResultsSummary(0, isSearchActive);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error in fetchAndRenderStudents:', error);
                    studentListError.textContent = error.message || 'An error occurred while fetching students.';
                    studentListError.classList.remove('hidden');
                    hideSkeletonLoading(); // Make sure to hide skeleton on error
                } finally {
                    isLoadingStudents = false; // Reset flag
                }
            };

            // Skeleton loading function
            const showSkeletonLoading = (count = 6) => {
                const skeletonGrid = document.createElement('div');
                skeletonGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
                skeletonGrid.id = 'skeleton-loading';
                
                for (let i = 0; i < count; i++) {
                    const skeletonCard = document.createElement('div');
                    skeletonCard.className = 'skeleton-card';
                    skeletonCard.innerHTML = `
                        <div class="flex items-start space-x-3">
                            <div class="skeleton skeleton-avatar"></div>
                            <div class="flex-1 space-y-2">
                                <div class="skeleton skeleton-line medium"></div>
                                <div class="skeleton skeleton-line short"></div>
                                <div class="skeleton skeleton-line long"></div>
                                <div class="skeleton skeleton-line short"></div>
                            </div>
                        </div>
                        <div class="mt-4 flex space-x-2">
                            <div class="skeleton skeleton-line short" style="height: 32px; border-radius: 6px;"></div>
                            <div class="skeleton skeleton-line short" style="height: 32px; border-radius: 6px;"></div>
                        </div>
                    `;
                    skeletonGrid.appendChild(skeletonCard);
                }
                
                studentListContainer.innerHTML = '';
                studentListContainer.appendChild(skeletonGrid);
            };
            
            // Hide skeleton loading
            const hideSkeletonLoading = () => {
                const skeleton = document.getElementById('skeleton-loading');
                if (skeleton) {
                    skeleton.remove();
                }
            };

            const renderStudentCards = (students) => {
                // Hide skeleton loading first
                hideSkeletonLoading();
                
                // Enhanced student card rendering with better performance and animations
                if (!students || students.length === 0) {
                    studentListContainer.innerHTML = `
                        <div class="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 fade-in">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">No students found</h3>
                            <p class="mt-1 text-sm text-gray-500">Try adjusting your search criteria or add some students to get started.</p>
                        </div>
                    `;
                    return;
                }

                // Use document fragment for better performance
                const fragment = document.createDocumentFragment();
                const studentsGrid = document.createElement('div');
                studentsGrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4';
                studentsGrid.id = 'students-grid';

                students.forEach((student, index) => {
                    const studentCard = createStudentCard(student, index);
                    studentsGrid.appendChild(studentCard);
                });

                fragment.appendChild(studentsGrid);
                studentListContainer.innerHTML = '';
                studentListContainer.appendChild(fragment);

                // Attach event listeners for the cards
                attachStudentCardEventListeners();
            };

            const createStudentCard = (student, index = 0) => {
                const card = document.createElement('div');
                card.className = 'student-card bg-white border border-gray-200 rounded-xl p-4 sm:p-5 shadow-sm hover:shadow-lg transition-all duration-300 hover-lift fade-in relative group';
                card.dataset.studentName = student.full_name;
                card.dataset.studentIndex = student.index_number;
                card.dataset.program = student.program || '';
                card.dataset.year = student.year_of_study || '';

                const initials = student.full_name 
                    ? student.full_name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase()
                    : student.index_number.substring(0, 2).toUpperCase();
                
                const yearBadge = student.year_of_study 
                    ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Year ${student.year_of_study}</span>`
                    : '';

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex items-start space-x-2 sm:space-x-3">
                            <input type="checkbox" class="bulk-checkbox student-checkbox mt-1" 
                                   value="${student.id}" data-student-id="${student.id}" />
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center space-x-2 sm:space-x-3 mb-2 sm:mb-3">
                                    <div class="flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 bg-blue-600 rounded-full flex items-center justify-center text-white font-semibold text-xs sm:text-sm shadow-sm">
                                        ${initials}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <h4 class="student-name text-base sm:text-lg font-semibold text-gray-900 truncate">${student.full_name}</h4>
                                        <p class="text-xs sm:text-sm text-gray-600 truncate">${student.index_number}</p>
                                    </div>
                                </div>
                                <div class="space-y-1.5 sm:space-y-2">
                                    <p class="student-email text-xs sm:text-sm text-gray-600 truncate">
                                        <span class="inline-flex items-center">
                                            <svg class="w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-1.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"></path>
                                            </svg>
                                            ${student.contact_email || 'No email'}
                                        </span>
                                    </p>
                                    <p class="student-course text-xs sm:text-sm text-gray-600 truncate">
                                        <span class="inline-flex items-center">
                                            <svg class="w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-1.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                            </svg>
                                            ${student.program || 'N/A'}
                                        </span>
                                    </p>
                                <div class="flex items-center justify-between mt-3">
                                    ${yearBadge}
                                    <div class="flex space-x-1">
                                        <button data-action="edit" data-index="${student.index_number}" 
                                                class="px-2 py-1 sm:px-3 sm:py-1.5 bg-blue-600 text-white text-xs font-medium rounded-md hover:bg-blue-700 transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1"
                                                title="Edit student">
                                            Edit
                                        </button>
                                        <button data-action="delete" data-index="${student.index_number}" 
                                                class="px-2 py-1 sm:px-3 sm:py-1.5 bg-red-600 text-white text-xs font-medium rounded-md hover:bg-red-700 transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1"
                                                title="Delete student">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                `;

                return card;
            };

            const attachStudentCardEventListeners = () => {
                studentListContainer.addEventListener('click', async (e) => {
                    const target = e.target;
                    if (target.tagName === 'BUTTON' && target.dataset.action) {
                        e.preventDefault();
                        
                        const indexNumber = target.dataset.index;
                        const studentCard = target.closest('.student-card');
                        
                        if (target.dataset.action === 'edit') {
                            const name = studentCard.querySelector('.student-name').textContent;
                            const email = studentCard.querySelector('.student-email').textContent.replace(/.*/, '').trim();
                            const course = studentCard.querySelector('.student-course').textContent.replace(/.*/, '').trim();
                            const yearBadge = studentCard.querySelector('.bg-blue-100');
                            const semester = yearBadge ? yearBadge.textContent.replace('Year ', '') : '';
                            
                            openStudentEditModal(indexNumber, name, email, course, semester);
                        } else if (target.dataset.action === 'delete') {
                            const name = studentCard.querySelector('.student-name').textContent;
                            openConfirmationModal(
                                'Confirm Deletion',
                                `Are you sure you want to delete student ${name} (${indexNumber})?`,
                                async () => {
                                    try {
                                        const result = await api.deleteStudent(indexNumber);
                                        if (result.success) {
                                            showToast(result.message, 'success');
                                            await refreshStudentData();
                                        } else {
                                            showToast(result.message, 'error');
                                        }
                                    } catch (error) {
                                        showToast('Failed to delete student: ' + error.message, 'error');
                                    }
                                }
                            );
                        }
                    }
                });
            };

            // Enhanced student form submission with pagination refresh
            if (addStudentForm) {
                addStudentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (addStudentButton) addStudentButton.disabled = true;
                    displayMessage('add-student-message', '', 'success');
                    displayMessage('add-student-error', '', 'error');

                    // Safely get form values with null checks
                    const indexEl = document.getElementById('new-student-index');
                    const nameEl = document.getElementById('new-student-name');
                    const dobEl = document.getElementById('new-student-dob');
                    const genderEl = document.getElementById('new-student-gender');
                    const emailEl = document.getElementById('new-student-email');
                    const phoneEl = document.getElementById('new-student-phone');
                    const programEl = document.getElementById('new-student-program');
                    const yearEl = document.getElementById('new-student-year');

                    const newStudent = {
                        index_number: indexEl?.value || '',
                        full_name: nameEl?.value || '',
                        date_of_birth: dobEl?.value || null,
                        gender: genderEl?.value || null,
                        contact_email: emailEl?.value || null,
                        contact_phone: phoneEl?.value || null,
                        program: programEl?.value || null,
                        year_of_study: yearEl?.value ? parseInt(yearEl.value) : null,
                    };

                try {
                    const result = await api.createStudent(newStudent);
                    if (result.success) {
                        displayMessage('add-student-message', result.message, 'success');
                        addStudentForm.reset();
                        await refreshStudentData(); // Use the new pagination refresh
                    } else {
                        displayMessage('add-student-error', result.message, 'error');
                    }
                } catch (err) {
                    displayMessage('add-student-error', err.message, 'error');
                } finally {
                    if (addStudentButton) addStudentButton.disabled = false;
                }
                });
            }

            // Update legacy button handlers (keeping for compatibility)
            const legacySearchButton = document.getElementById('search-students-button');
            if (legacySearchButton) {
                legacySearchButton.addEventListener('click', () => fetchAndRenderStudents(true));
            }

            // Enhanced Search Interface Event Handlers
            const setupEnhancedSearch = () => {
                const searchTermInput = document.getElementById('search-term');
                const toggleAdvancedFilters = document.getElementById('toggle-advanced-filters');
                const advancedFilters = document.getElementById('advanced-filters');
                const clearSearchBtn = document.getElementById('clear-search');
                const clearAllFiltersBtn = document.getElementById('clear-all-filters');
                const applyFiltersBtn = document.getElementById('apply-filters');
                const searchSpinner = document.getElementById('search-spinner');
                const activeFiltersContainer = document.getElementById('active-filters');
                const searchResultsSummary = document.getElementById('search-results-summary');
                const resultsText = document.getElementById('results-text');
                
                // Autocomplete elements
                const autocompleteDropdown = document.getElementById('search-autocomplete');
                const suggestionsContainer = document.getElementById('search-suggestions');
                const historyContainer = document.getElementById('search-history');
                const historyItems = document.getElementById('search-history-items');

                let searchTimeout;
                let selectedSuggestionIndex = -1;
                let suggestions = [];
                
                // Real-time search with debouncing
                const performRealTimeSearch = async (searchTerm) => {
                    if (!searchTerm.trim()) {
                        // If search is empty, reload all students
                        await fetchAndRenderStudents(false);
                        return;
                    }
                    
                    // Show loading state
                    const searchSpinner = document.getElementById('search-spinner');
                    if (searchSpinner) searchSpinner.classList.remove('hidden');
                    
                    try {
                        // Build search filters
                        const filters = { name: searchTerm.trim() };
                        
                        // Get other filter values if they exist
                        const programInput = document.getElementById('search-program');
                        const yearInput = document.getElementById('search-year'); 
                        const genderInput = document.getElementById('search-gender');
                        
                        if (programInput?.value) filters.program = programInput.value;
                        if (yearInput?.value) filters.year_of_study = parseInt(yearInput.value);
                        if (genderInput?.value) filters.gender = genderInput.value;
                        
                        // Perform search
                        if (studentPaginationManager) {
                            await studentPaginationManager.search(filters, 0);
                            const data = await studentPaginationManager.goToPage(1);
                            if (data && data.records) {
                                handleStudentDataUpdate(data);
                            }
                        } else {
                            // Fallback search
                            await fetchAndRenderStudents(true);
                        }
                        
                        // Update search history
                        if (searchTerm.trim().length >= 2) {
                            addToSearchHistory(searchTerm.trim());
                        }
                        
                    } catch (error) {
                        console.error('Real-time search error:', error);
                    } finally {
                        if (searchSpinner) searchSpinner.classList.add('hidden');
                    }
                };
                
                // Search history management
                const getSearchHistory = () => {
                    try {
                        return JSON.parse(localStorage.getItem('srms_search_history') || '[]');
                    } catch {
                        return [];
                    }
                };
                
                const addToSearchHistory = (term) => {
                    if (!term.trim()) return;
                    let history = getSearchHistory();
                    history = history.filter(item => item !== term.trim());
                    history.unshift(term.trim());
                    history = history.slice(0, 5); // Keep only last 5 searches
                    localStorage.setItem('srms_search_history', JSON.stringify(history));
                };
                
                const renderSearchHistory = () => {
                    const history = getSearchHistory();
                    if (history.length === 0) {
                        historyContainer.classList.add('hidden');
                        return;
                    }
                    
                    historyContainer.classList.remove('hidden');
                    historyItems.innerHTML = history.map(term => `
                        <div class="history-item px-4 py-2 hover:bg-gray-50 cursor-pointer flex items-center justify-between" data-term="${term}">
                            <span class="text-sm text-gray-700">${term}</span>
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    `).join('');
                    
                    // Add click handlers for history items
                    historyItems.querySelectorAll('.history-item').forEach(item => {
                        item.addEventListener('click', () => {
                            const term = item.getAttribute('data-term');
                            searchTermInput.value = term;
                            hideAutocomplete();
                            performSearch();
                        });
                    });
                };
                
                // Autocomplete functionality
                const showAutocomplete = () => {
                    autocompleteDropdown.classList.remove('hidden');
                    autocompleteDropdown.classList.add('slide-down');
                };
                
                const hideAutocomplete = () => {
                    autocompleteDropdown.classList.add('hidden');
                    autocompleteDropdown.classList.remove('slide-down');
                    selectedSuggestionIndex = -1;
                };
                
                const generateSuggestions = async (term) => {
                    if (!term.trim()) {
                        renderSearchHistory();
                        return;
                    }
                    
                    // Simple suggestions based on common patterns
                    const commonSuggestions = [
                        `${term} Computer Science`,
                        `${term} Engineering`,
                        `${term} Business`,
                        `${term} 2024`,
                        `${term} male`,
                        `${term} female`
                    ].filter(suggestion => suggestion.toLowerCase() !== term.toLowerCase());
                    
                    suggestions = commonSuggestions.slice(0, 5);
                    renderSuggestions();
                };
                
                const renderSuggestions = () => {
                    historyContainer.classList.add('hidden');
                    
                    if (suggestions.length === 0) {
                        suggestionsContainer.innerHTML = '<div class="px-4 py-2 text-sm text-gray-500">No suggestions available</div>';
                        return;
                    }
                    
                    suggestionsContainer.innerHTML = suggestions.map((suggestion, index) => `
                        <div class="autocomplete-item px-4 py-2 hover:bg-gray-50 cursor-pointer text-sm ${index === selectedSuggestionIndex ? 'highlighted' : ''}" data-suggestion="${suggestion}">
                            ${suggestion}
                        </div>
                    `).join('');
                    
                    // Add click handlers for suggestions
                    suggestionsContainer.querySelectorAll('.autocomplete-item').forEach((item, index) => {
                        item.addEventListener('click', () => {
                            searchTermInput.value = item.getAttribute('data-suggestion');
                            hideAutocomplete();
                            performSearch();
                        });
                    });
                };

                // Define functions first before using them
                
                // Perform search function
                const performSearch = async () => {
                    try {
                        await fetchAndRenderStudents(true);
                        updateActiveFilters();
                    } catch (error) {
                        console.error('Search error:', error);
                        showToast('Search failed: ' + error.message, 'error');
                    }
                };

                // Update active filter badges
                const updateActiveFilters = () => {
                    const filters = [];
                    const searchTerm = searchTermInput.value.trim();
                    const program = document.getElementById('search-program').value;
                    const year = document.getElementById('search-year').value;
                    const gender = document.getElementById('search-gender').value;

                    if (searchTerm) filters.push({ label: `Search: "${searchTerm}"`, value: searchTerm, type: 'search' });
                    if (program) filters.push({ label: `Program: ${program}`, value: program, type: 'program' });
                    if (year) filters.push({ label: `Year: ${year}`, value: year, type: 'year' });
                    if (gender) filters.push({ label: `Gender: ${gender}`, value: gender, type: 'gender' });

                    activeFiltersContainer.innerHTML = filters.map(filter => `
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${filter.label}
                            <button type="button" class="ml-1 text-blue-600 hover:text-blue-800" onclick="removeFilter('${filter.type}')">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </span>
                    `).join('');
                };

                // Now set up event handlers

                // Toggle advanced filters
                toggleAdvancedFilters.addEventListener('click', () => {
                    const isHidden = advancedFilters.classList.contains('hidden');
                    if (isHidden) {
                        advancedFilters.classList.remove('hidden');
                        document.getElementById('toggle-text').textContent = 'Hide Advanced Filters';
                        document.getElementById('toggle-icon').style.transform = 'rotate(180deg)';
                    } else {
                        advancedFilters.classList.add('hidden');
                        document.getElementById('toggle-text').textContent = 'Show Advanced Filters';
                        document.getElementById('toggle-icon').style.transform = 'rotate(0deg)';
                    }
                });

                // Enhanced real-time search with autocomplete and keyboard shortcuts
                searchTermInput.addEventListener('input', (e) => {
                    const value = e.target.value.trim();
                    
                    // Show/hide clear button
                    if (value) {
                        clearSearchBtn.classList.remove('hidden');
                        showAutocomplete();
                        generateSuggestions(value);
                    } else {
                        clearSearchBtn.classList.add('hidden');
                        hideAutocomplete();
                    }
                    
                    // Clear previous timeout
                    if (searchTimeout) {
                        clearTimeout(searchTimeout);
                    }
                    
                    // Debounced real-time search (300ms delay)
                    searchTimeout = setTimeout(async () => {
                        await performRealTimeSearch(value);
                        
                        // Update search results summary
                        if (window.updateSearchResultsSummary) {
                            const isSearchActive = value.length > 0;
                            const studentCards = document.querySelectorAll('.student-card');
                            window.updateSearchResultsSummary(studentCards.length, isSearchActive);
                        }
                    }, 300);

                    // Show spinner during search
                    searchSpinner.classList.remove('hidden');

                    // Debounced search for real-time results
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(async () => {
                        try {
                            if (value) {
                                await performSearch();
                            }
                        } catch (error) {
                            console.error('Search error:', error);
                            showToast('Search failed: ' + error.message, 'error');
                        } finally {
                            searchSpinner.classList.add('hidden');
                        }
                    }, 500); // Slightly longer delay for real-time search
                });
                
                // Keyboard shortcuts and navigation
                searchTermInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        // Clear search and hide autocomplete
                        e.preventDefault();
                        searchTermInput.value = '';
                        clearSearchBtn.classList.add('hidden');
                        hideAutocomplete();
                        performSearch();
                        return;
                    }
                    
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (selectedSuggestionIndex >= 0 && suggestions[selectedSuggestionIndex]) {
                            // Use selected suggestion
                            searchTermInput.value = suggestions[selectedSuggestionIndex];
                        }
                        addToSearchHistory(searchTermInput.value);
                        hideAutocomplete();
                        performSearch();
                        return;
                    }
                    
                    // Navigate suggestions with arrow keys
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        if (!autocompleteDropdown.classList.contains('hidden')) {
                            selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestions.length - 1);
                            updateSuggestionHighlight();
                        }
                        return;
                    }
                    
                    if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        if (!autocompleteDropdown.classList.contains('hidden')) {
                            selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                            updateSuggestionHighlight();
                        }
                        return;
                    }
                });
                
                // Focus and blur events for autocomplete
                searchTermInput.addEventListener('focus', () => {
                    const value = searchTermInput.value.trim();
                    if (value) {
                        showAutocomplete();
                        generateSuggestions(value);
                    } else {
                        showAutocomplete();
                        renderSearchHistory();
                    }
                });
                
                // Hide autocomplete when clicking outside
                document.addEventListener('click', (e) => {
                    if (!searchTermInput.contains(e.target) && !autocompleteDropdown.contains(e.target)) {
                        hideAutocomplete();
                    }
                });
                
                // Update suggestion highlight
                const updateSuggestionHighlight = () => {
                    const items = suggestionsContainer.querySelectorAll('.autocomplete-item');
                    items.forEach((item, index) => {
                        if (index === selectedSuggestionIndex) {
                            item.classList.add('highlighted');
                        } else {
                            item.classList.remove('highlighted');
                        }
                    });
                };

                // Clear search with enhanced functionality
                clearSearchBtn.addEventListener('click', () => {
                    searchTermInput.value = '';
                    clearSearchBtn.classList.add('hidden');
                    hideAutocomplete();
                    performSearch();
                    searchTermInput.focus(); // Keep focus for better UX
                });

                // Apply filters
                applyFiltersBtn.addEventListener('click', performSearch);

                // Clear all filters
                clearAllFiltersBtn.addEventListener('click', () => {
                    // Clear all form inputs
                    searchTermInput.value = '';
                    document.getElementById('search-program').value = '';
                    document.getElementById('search-year').value = '';
                    document.getElementById('search-gender').value = '';
                    document.getElementById('sort-by').value = 'name_asc';
                    
                    // Clear UI elements
                    clearSearchBtn.classList.add('hidden');
                    updateActiveFilters();
                    performSearch();
                });

                // Monitor all filter changes
                ['search-program', 'search-year', 'search-gender', 'sort-by'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('change', () => {
                            updateActiveFilters();
                            if (!advancedFilters.classList.contains('hidden')) {
                                performSearch();
                            }
                        });
                    }
                });

                // Global function to remove individual filters
                window.removeFilter = (type) => {
                    switch (type) {
                        case 'search':
                            searchTermInput.value = '';
                            clearSearchBtn.classList.add('hidden');
                            break;
                        case 'program':
                            document.getElementById('search-program').value = '';
                            break;
                        case 'year':
                            document.getElementById('search-year').value = '';
                            break;
                        case 'gender':
                            document.getElementById('search-gender').value = '';
                            break;
                    }
                    updateActiveFilters();
                    performSearch();
                };

                // Update search results summary
                window.updateSearchResultsSummary = (count, isSearchActive) => {
                    if (isSearchActive) {
                        searchResultsSummary.classList.remove('hidden');
                        resultsText.textContent = `Found ${count} student${count !== 1 ? 's' : ''}`;
                    } else {
                        searchResultsSummary.classList.add('hidden');
                    }
                };
            };

            // Batch Progress Modal
            const showBatchProgress = (title, steps) => {
                const modalHTML = `
                    <div id="batch-progress-overlay" class="batch-progress-overlay"></div>
                    <div id="batch-progress-modal" class="batch-progress">
                        <div class="text-center mb-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">${title}</h3>
                            <div class="local-spinner mx-auto mb-4" aria-hidden="true"></div>
                        </div>
                        <div id="progress-steps" class="space-y-2">
                            ${steps.map((step, index) => `
                                <div class="progress-step ${index === 0 ? 'active' : ''}" data-step="${index}">
                                    <div class="flex items-center space-x-3">
                                        <div class="step-indicator w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center">
                                            <span class="text-xs font-medium">${index + 1}</span>
                                        </div>
                                        <span class="text-sm text-gray-700">${step}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="mt-6 text-center">
                            <p class="text-sm text-gray-500">Please wait while we process your request...</p>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Simulate progress through steps
                let currentStep = 0;
                const stepInterval = setInterval(() => {
                    if (currentStep < steps.length - 1) {
                        document.querySelector(`[data-step="${currentStep}"]`).classList.remove('active');
                        document.querySelector(`[data-step="${currentStep}"]`).classList.add('completed');
                        currentStep++;
                        document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');
                    } else {
                        clearInterval(stepInterval);
                    }
                }, 800);
                
                // Store interval for cleanup
                window.batchProgressInterval = stepInterval;
            };
            
            const hideBatchProgress = () => {
                if (window.batchProgressInterval) {
                    clearInterval(window.batchProgressInterval);
                }
                document.getElementById('batch-progress-overlay')?.remove();
                document.getElementById('batch-progress-modal')?.remove();
            };
            
            // Bulk Operations API Functions
            const performBulkExport = async (studentIds) => {
                // Simulate export process
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Create CSV content
                const students = studentIds.map(id => {
                    const card = document.querySelector(`[data-student-id="${id}"]`)?.closest('.student-card');
                    if (card) {
                        return {
                            name: card.querySelector('.student-name')?.textContent || '',
                            index: card.dataset.studentIndex || '',
                            email: card.querySelector('.student-email')?.textContent.replace(/.*/, '').trim() || '',
                            program: card.dataset.program || ''
                        };
                    }
                    return null;
                }).filter(Boolean);
                
                const csvContent = [
                    'Name,Index Number,Email,Program',
                    ...students.map(s => `"${s.name}","${s.index}","${s.email}","${s.program}"`)
                ].join('\\n');
                
                // Download CSV
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `students_export_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            };
            
            const performBulkDelete = async (studentIds) => {
                // Simulate API calls with progress
                for (let i = 0; i < studentIds.length; i++) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                    // In real implementation, make API call here
                    // await api.deleteStudent(studentIds[i]);
                }
            };
            
            // Enhanced confirmation modal
            const showConfirmation = (title, message) => {
                return new Promise((resolve) => {
                    const modalHTML = `
                        <div id="confirmation-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                            <div class="bg-white rounded-lg shadow-lg max-w-md w-full p-6">
                                <div class="flex items-center mb-4">
                                    <div class="flex-shrink-0 w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                        </svg>
                                    </div>
                                    <h3 class="ml-3 text-lg font-medium text-gray-900">${title}</h3>
                                </div>
                                <p class="text-sm text-gray-600 mb-6">${message}</p>
                                <div class="flex justify-end space-x-3">
                                    <button id="cancel-confirmation" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Cancel</button>
                                    <button id="confirm-action" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirm</button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                    
                    document.getElementById('cancel-confirmation').onclick = () => {
                        document.getElementById('confirmation-overlay').remove();
                        resolve(false);
                    };
                    
                    document.getElementById('confirm-action').onclick = () => {
                        document.getElementById('confirmation-overlay').remove();
                        resolve(true);
                    };
                });
            };

            // Bulk Operations Management
            const setupBulkOperations = () => {
                const bulkOperationsPanel = document.getElementById('bulk-operations-panel');
                const selectAllCheckbox = document.getElementById('select-all-students');
                const selectedCount = document.getElementById('selected-count');
                const selectionCounter = document.getElementById('selection-counter');
                const selectionText = document.getElementById('selection-text');
                const bulkExportBtn = document.getElementById('bulk-export');
                const bulkEditBtn = document.getElementById('bulk-edit');
                const bulkDeleteBtn = document.getElementById('bulk-delete');
                
                let selectedStudents = new Set();
                
                // Update UI based on selection
                const updateBulkUI = () => {
                    const count = selectedStudents.size;
                    selectedCount.textContent = count;
                    
                    if (count > 0) {
                        bulkOperationsPanel.classList.add('active');
                        selectionCounter.classList.remove('hidden');
                        selectionText.textContent = 'Bulk operations available';
                        selectAllCheckbox.disabled = false;
                        bulkExportBtn.disabled = false;
                        bulkEditBtn.disabled = false;
                        bulkDeleteBtn.disabled = false;
                    } else {
                        bulkOperationsPanel.classList.remove('active');
                        selectionCounter.classList.add('hidden');
                        selectionText.textContent = 'Select students for bulk operations';
                        bulkExportBtn.disabled = true;
                        bulkEditBtn.disabled = true;
                        bulkDeleteBtn.disabled = true;
                    }
                    
                    // Update select all checkbox state
                    const allCheckboxes = document.querySelectorAll('.student-checkbox');
                    const checkedCount = document.querySelectorAll('.student-checkbox:checked').length;
                    
                    if (checkedCount === 0) {
                        selectAllCheckbox.indeterminate = false;
                        selectAllCheckbox.checked = false;
                    } else if (checkedCount === allCheckboxes.length) {
                        selectAllCheckbox.indeterminate = false;
                        selectAllCheckbox.checked = true;
                    } else {
                        selectAllCheckbox.indeterminate = true;
                    }
                };
                
                // Handle individual checkbox changes
                document.addEventListener('change', (e) => {
                    if (e.target.classList.contains('student-checkbox')) {
                        const studentId = e.target.value;
                        if (e.target.checked) {
                            selectedStudents.add(studentId);
                        } else {
                            selectedStudents.delete(studentId);
                        }
                        updateBulkUI();
                    }
                });
                
                // Handle select all
                selectAllCheckbox?.addEventListener('change', (e) => {
                    const allCheckboxes = document.querySelectorAll('.student-checkbox');
                    allCheckboxes.forEach(checkbox => {
                        checkbox.checked = e.target.checked;
                        const studentId = checkbox.value;
                        if (e.target.checked) {
                            selectedStudents.add(studentId);
                        } else {
                            selectedStudents.delete(studentId);
                        }
                    });
                    updateBulkUI();
                });
                
                // Bulk Export
                bulkExportBtn?.addEventListener('click', async () => {
                    if (selectedStudents.size === 0) return;
                    
                    showBatchProgress('Exporting Students', [
                        'Gathering student data...',
                        'Formatting export file...',
                        'Downloading file...'
                    ]);
                    
                    try {
                        const studentIds = Array.from(selectedStudents);
                        await performBulkExport(studentIds);
                        hideBatchProgress();
                        showToast(`Successfully exported ${studentIds.length} students`, 'success');
                    } catch (error) {
                        hideBatchProgress();
                        showToast('Export failed: ' + error.message, 'error');
                    }
                });
                
                // Bulk Delete
                bulkDeleteBtn?.addEventListener('click', async () => {
                    if (selectedStudents.size === 0) return;
                    
                    const confirmed = await showConfirmation(
                        'Delete Selected Students',
                        `Are you sure you want to delete ${selectedStudents.size} selected students? This action cannot be undone.`
                    );
                    
                    if (confirmed) {
                        showBatchProgress('Deleting Students', [
                            'Preparing deletion...',
                            'Deleting student records...',
                            'Updating database...',
                            'Refreshing display...'
                        ]);
                        
                        try {
                            const studentIds = Array.from(selectedStudents);
                            await performBulkDelete(studentIds);
                            selectedStudents.clear();
                            hideBatchProgress();
                            showToast(`Successfully deleted ${studentIds.length} students`, 'success');
                            fetchAndRenderStudents(); // Refresh the list
                        } catch (error) {
                            hideBatchProgress();
                            showToast('Bulk delete failed: ' + error.message, 'error');
                        }
                    }
                });
                
                // Reset selection when new data loads
                window.addEventListener('studentsLoaded', () => {
                    selectedStudents.clear();
                    updateBulkUI();
                });
            };

            // Initialize simple pagination controls
            initializeStudentsPagination();
            
            // Enhanced Load All / Hide Students functionality
            loadAllStudentsButton.addEventListener('click', async () => {
                const selectAllCheckbox = document.getElementById('select-all-students');
                const isCurrentlyLoaded = loadAllStudentsButton.dataset.loaded === 'true';
                
                if (!isCurrentlyLoaded) {
                    // Load students with pagination
                    loadAllStudentsButton.disabled = true;
                    
                    await loadAllStudentsWithPagination();
                    
                    loadAllStudentsButton.innerHTML = `
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 16.121m6.878-6.243L16.121 3M13.875 18.825L21 12m-7.125 6.825L16.121 3"></path>
                        </svg>
                        Hide Students
                    `;
                    loadAllStudentsButton.dataset.loaded = 'true';
                    loadAllStudentsButton.disabled = false;
                    
                    // Enable bulk operations
                    if (selectAllCheckbox) selectAllCheckbox.disabled = false;
                } else {
                    // Hide students and reset pagination
                    studentsPaginationState.isLoaded = false;
                    studentsPaginationState.allStudents = [];
                    studentsPaginationState.totalStudents = 0;
                    studentsPaginationState.currentPage = 1;
                    
                    // Hide pagination controls
                    const paginationControls = document.getElementById('students-pagination-controls');
                    const paginationInfo = document.getElementById('students-pagination-info');
                    paginationControls.classList.add('hidden');
                    paginationInfo.classList.add('hidden');
                    
                    studentListContainer.innerHTML = `
                        <div class="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">No students loaded</h3>
                            <p class="mt-1 text-sm text-gray-500">Click "Load Students" to view all students or use search filters to find specific students.</p>
                        </div>
                    `;
                    
                    // Hide pagination components (legacy cleanup)
                    if (studentPaginationUI && document.getElementById('student-pagination')) {
                        document.getElementById('student-pagination').innerHTML = '';
                    }
                    if (studentSearchInterface && document.getElementById('student-search-interface')) {
                        document.getElementById('student-search-interface').innerHTML = '';
                    }
                    
                    loadAllStudentsButton.innerHTML = `
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                        </svg>
                        Load Students
                    `;
                    loadAllStudentsButton.dataset.loaded = 'false';
                    
                    // Disable bulk operations
                    if (selectAllCheckbox) {
                        selectAllCheckbox.disabled = true;
                        selectAllCheckbox.checked = false;
                    }
                    
                    // Reset bulk operations panel
                    const bulkOperationsPanel = document.getElementById('bulk-operations-panel');
                    const selectionCounter = document.getElementById('selection-counter');
                    const selectionText = document.getElementById('selection-text');
                    if (bulkOperationsPanel) bulkOperationsPanel.classList.remove('active');
                    if (selectionCounter) selectionCounter.classList.add('hidden');
                    if (selectionText) selectionText.textContent = 'Select students for bulk operations';
                }
            });

            // Initialize enhanced search
            setupEnhancedSearch();
            
            // Initialize bulk operations
            setupBulkOperations();

            // Don't auto-fetch students on page load - let user search explicitly
            // Users can click "Search Students" to load the initial data
        };

        // --- Admin Course Management ---
        const renderAdminCourseManagement = async (parentDiv) => {
            parentDiv.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Course Management</h3>

                    <div class="mb-6 p-4 border border-gray-200 rounded-md bg-gray-50">
                        <h4 class="text-lg font-semibold mb-3 text-gray-700">Add New Course</h4>
                        <form id="add-course-form" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <input type="text" id="new-course-code" placeholder="Course Code (e.g., CS101)" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                            <input type="text" id="new-course-title" placeholder="Course Title" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                            <input type="number" id="new-course-credits" placeholder="Credits" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" min="1" max="10" required />
                            <button type="submit" id="add-course-button" class="col-span-full bg-green-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-green-700 disabled:opacity-50">
                                Add Course
                            </button>
                        </form>
                        <p id="add-course-message" class="mt-3 text-center text-sm"></p>
                        <p id="add-course-error" class="mt-3 text-center text-sm"></p>
                    </div>

                    <div class="mb-6 flex justify-between items-center">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-700">Course Catalog</h4>
                            <p class="text-sm text-gray-500 mt-1">Manage courses with detailed information and easy access</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <!-- Page Size Selector -->
                            <div class="flex items-center space-x-2">
                                <label for="courses-per-page" class="text-sm text-gray-600">Per page:</label>
                                <select id="courses-per-page" class="border border-gray-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="10">10</option>
                                    <option value="20" selected>20</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                            <button id="load-all-courses-button" class="bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700 disabled:opacity-50">
                                Load Courses
                            </button>
                        </div>
                    </div>
                    
                    <!-- Pagination Info Bar -->
                    <div id="courses-pagination-info" class="hidden mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-center justify-between text-sm">
                            <div id="courses-count-info" class="text-blue-800"></div>
                            <div id="courses-loading-progress" class="text-blue-600"></div>
                        </div>
                    </div>
                    <p id="course-list-error" class="text-red-600 text-center py-6 hidden"></p>
                    <div id="course-list-container" class="rounded-md">
                        <div class="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">No courses loaded</h3>
                            <p class="mt-1 text-sm text-gray-500">Click "Load Courses" to view the course catalog.</p>
                        </div>
                    </div>
                    
                    <!-- Pagination Controls -->
                    <div id="courses-pagination-controls" class="hidden mt-6 flex items-center justify-between bg-white px-4 py-3 border border-gray-200 rounded-lg">
                        <div class="flex items-center text-sm text-gray-700">
                            <span id="courses-pagination-showing">Showing 1 to 20 of 100 courses</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="courses-pagination-first" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                First
                            </button>
                            <button id="courses-pagination-prev" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Previous
                            </button>
                            <div id="courses-pagination-pages" class="flex items-center space-x-1">
                                <!-- Page numbers will be dynamically inserted here -->
                            </div>
                            <button id="courses-pagination-next" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                Next
                            </button>
                            <button id="courses-pagination-last" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                Last
                            </button>
                        </div>
                    </div>
                </div>
            `;

            const addCourseForm = document.getElementById('add-course-form');
            const addCourseButton = document.getElementById('add-course-button');
            const addCourseMessage = document.getElementById('add-course-message');
            const addCourseError = document.getElementById('add-course-error');
            const loadAllCoursesButton = document.getElementById('load-all-courses-button');
            const courseListContainer = document.getElementById('course-list-container');
            const courseListError = document.getElementById('course-list-error');

            // Simple Courses Pagination State
            let coursesPaginationState = {
                currentPage: 1,
                pageSize: 20,
                totalCourses: 0,
                totalPages: 0,
                allCourses: [],
                isLoaded: false
            };

            // Initialize simple courses pagination controls
            const initializeCoursesPagination = () => {
                const pageSize = document.getElementById('courses-per-page');
                const paginationInfo = document.getElementById('courses-pagination-info');
                const countInfo = document.getElementById('courses-count-info');
                const progressInfo = document.getElementById('courses-loading-progress');
                const paginationControls = document.getElementById('courses-pagination-controls');
                const showingText = document.getElementById('courses-pagination-showing');
                const firstBtn = document.getElementById('courses-pagination-first');
                const prevBtn = document.getElementById('courses-pagination-prev');
                const nextBtn = document.getElementById('courses-pagination-next');
                const lastBtn = document.getElementById('courses-pagination-last');
                const pagesContainer = document.getElementById('courses-pagination-pages');

                // Page size change handler
                pageSize.addEventListener('change', (e) => {
                    coursesPaginationState.pageSize = parseInt(e.target.value);
                    coursesPaginationState.currentPage = 1;
                    if (coursesPaginationState.isLoaded) {
                        renderCoursesPage();
                        updateCoursesPaginationUI();
                    }
                });

                // Navigation button handlers
                firstBtn.addEventListener('click', () => {
                    if (coursesPaginationState.currentPage > 1) {
                        coursesPaginationState.currentPage = 1;
                        renderCoursesPage();
                        updateCoursesPaginationUI();
                    }
                });

                prevBtn.addEventListener('click', () => {
                    if (coursesPaginationState.currentPage > 1) {
                        coursesPaginationState.currentPage--;
                        renderCoursesPage();
                        updateCoursesPaginationUI();
                    }
                });

                nextBtn.addEventListener('click', () => {
                    if (coursesPaginationState.currentPage < coursesPaginationState.totalPages) {
                        coursesPaginationState.currentPage++;
                        renderCoursesPage();
                        updateCoursesPaginationUI();
                    }
                });

                lastBtn.addEventListener('click', () => {
                    if (coursesPaginationState.currentPage < coursesPaginationState.totalPages) {
                        coursesPaginationState.currentPage = coursesPaginationState.totalPages;
                        renderCoursesPage();
                        updateCoursesPaginationUI();
                    }
                });
            };

            // Update pagination UI state
            const updateCoursesPaginationUI = () => {
                const showingText = document.getElementById('courses-pagination-showing');
                const firstBtn = document.getElementById('courses-pagination-first');
                const prevBtn = document.getElementById('courses-pagination-prev');
                const nextBtn = document.getElementById('courses-pagination-next');
                const lastBtn = document.getElementById('courses-pagination-last');
                const pagesContainer = document.getElementById('courses-pagination-pages');
                const paginationControls = document.getElementById('courses-pagination-controls');

                if (!coursesPaginationState.isLoaded || coursesPaginationState.totalCourses === 0) {
                    paginationControls.classList.add('hidden');
                    return;
                }

                // Calculate display ranges
                const startRecord = (coursesPaginationState.currentPage - 1) * coursesPaginationState.pageSize + 1;
                const endRecord = Math.min(coursesPaginationState.currentPage * coursesPaginationState.pageSize, coursesPaginationState.totalCourses);

                // Update showing text
                showingText.textContent = `Showing ${startRecord} to ${endRecord} of ${coursesPaginationState.totalCourses} courses`;

                // Update button states
                firstBtn.disabled = coursesPaginationState.currentPage <= 1;
                prevBtn.disabled = coursesPaginationState.currentPage <= 1;
                nextBtn.disabled = coursesPaginationState.currentPage >= coursesPaginationState.totalPages;
                lastBtn.disabled = coursesPaginationState.currentPage >= coursesPaginationState.totalPages;

                // Generate page numbers
                generateCoursePageNumbers();

                // Show pagination controls
                paginationControls.classList.remove('hidden');
            };

            // Generate page number buttons
            const generateCoursePageNumbers = () => {
                const pagesContainer = document.getElementById('courses-pagination-pages');
                pagesContainer.innerHTML = '';

                const currentPage = coursesPaginationState.currentPage;
                const totalPages = coursesPaginationState.totalPages;

                // Show max 5 page numbers
                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, startPage + 4);
                
                // Adjust if we're near the end
                if (endPage - startPage < 4) {
                    startPage = Math.max(1, endPage - 4);
                }

                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.textContent = i;
                    pageBtn.className = `px-3 py-1 text-sm border rounded hover:bg-gray-50 ${
                        i === currentPage 
                            ? 'bg-blue-600 text-white border-blue-600 font-medium' 
                            : 'border-gray-300'
                    }`;
                    
                    if (i !== currentPage) {
                        pageBtn.addEventListener('click', () => {
                            coursesPaginationState.currentPage = i;
                            renderCoursesPage();
                            updateCoursesPaginationUI();
                        });
                    }
                    
                    pagesContainer.appendChild(pageBtn);
                }
            };

            // Render current page of courses
            const renderCoursesPage = () => {
                const startIndex = (coursesPaginationState.currentPage - 1) * coursesPaginationState.pageSize;
                const endIndex = startIndex + coursesPaginationState.pageSize;
                const pageCourses = coursesPaginationState.allCourses.slice(startIndex, endIndex);
                
                renderCourseCards(pageCourses);
            };

            // Load all courses with progress tracking
            const loadAllCoursesWithPagination = async () => {
                const paginationInfo = document.getElementById('courses-pagination-info');
                const countInfo = document.getElementById('courses-count-info');
                const progressInfo = document.getElementById('courses-loading-progress');

                try {
                    // Show loading info
                    paginationInfo.classList.remove('hidden');
                    progressInfo.textContent = 'Loading courses...';
                    
                    // Fetch all courses
                    const response = await api.getAllCourses();
                    
                    if (response.success && response.data.courses) {
                        coursesPaginationState.allCourses = response.data.courses;
                        coursesPaginationState.totalCourses = response.data.courses.length;
                        coursesPaginationState.totalPages = Math.ceil(coursesPaginationState.totalCourses / coursesPaginationState.pageSize);
                        coursesPaginationState.currentPage = 1;
                        coursesPaginationState.isLoaded = true;
                        
                        // Update UI
                        countInfo.textContent = `Loaded ${coursesPaginationState.totalCourses} courses`;
                        progressInfo.textContent = 'Ready';
                        
                        // Render first page
                        renderCoursesPage();
                        updateCoursesPaginationUI();
                        
                        // Auto-hide info after success
                        setTimeout(() => {
                            paginationInfo.classList.add('hidden');
                        }, 2000);
                        
                    } else {
                        throw new Error(response.message || 'Failed to load courses');
                    }
                } catch (error) {
                    console.error('Error loading courses:', error);
                    progressInfo.textContent = 'Error loading courses';
                    countInfo.textContent = error.message;
                    courseListContainer.innerHTML = `<p class="text-red-600 text-center py-6">${error.message}</p>`;
                }
            };

            const fetchAndRenderCourses = async () => {
                courseListError.classList.add('hidden');
                courseListContainer.innerHTML = '';
                try {
                    const data = await api.getAllCourses();
                    if (data.success) {
                        if (data.data.courses.length === 0) {
                            courseListContainer.innerHTML = `<p class="text-gray-600 text-center py-6">No courses found.</p>`;
                        } else {
                            renderCourseCards(data.data.courses);
                        }
                    } else {
                        courseListError.textContent = data.message || 'Failed to fetch courses.';
                        courseListError.classList.remove('hidden');
                    }
                } catch (error) {
                    courseListError.textContent = error.message || 'An error occurred while fetching courses.';
                    courseListError.classList.remove('hidden');
                }
            };

            const renderCourseCards = (courses) => {
                // Simple search interface
                let html = `
                    <div class="mb-4">
                        <input type="text" id="course-quick-search" placeholder="Search courses by code or title..." 
                               class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="courses-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                `;

                courses.forEach(course => {
                    html += `
                        <div class="course-card bg-white border border-gray-200 rounded-lg p-4" 
                             data-course-code="${course.course_code}" data-course-title="${course.course_title}" 
                             data-credits="${course.credit_hours}">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h4 class="course-title text-lg font-medium text-gray-900">${course.course_title}</h4>
                                    <p class="text-sm text-gray-600">${course.course_code}</p>
                                    <p class="text-sm text-gray-600">${course.credit_hours} Credits</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button data-action="edit" data-code="${course.course_code}" 
                                            class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                        Edit
                                    </button>
                                    <button data-action="delete" data-code="${course.course_code}" 
                                            class="px-3 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
                courseListContainer.innerHTML = html;

                // Simple search functionality
                const searchInput = document.getElementById('course-quick-search');
                if (searchInput) {
                    searchInput.addEventListener('input', () => {
                        const searchTerm = searchInput.value.toLowerCase();
                        const courseCards = document.querySelectorAll('.course-card');
                        
                        courseCards.forEach(card => {
                            const code = card.dataset.courseCode.toLowerCase();
                            const title = card.dataset.courseTitle.toLowerCase();
                            const matches = code.includes(searchTerm) || title.includes(searchTerm);
                            card.style.display = matches ? 'block' : 'none';
                        });
                    });
                }
            };

            const refreshCourseData = async () => {
                if (coursesPaginationState.isLoaded) {
                    await loadAllCoursesWithPagination();
                }
            };

            addCourseForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                addCourseButton.disabled = true;
                displayMessage('add-course-message', '', 'success');
                displayMessage('add-course-error', '', 'error');

                const newCourse = {
                    course_code: document.getElementById('new-course-code').value,
                    course_title: document.getElementById('new-course-title').value,
                    credits: parseInt(document.getElementById('new-course-credits').value),
                };

                try {
                    const result = await api.createCourse(newCourse);
                    if (result.success) {
                        displayMessage('add-course-message', result.message, 'success');
                        addCourseForm.reset();
                        await refreshCourseData(); // Use pagination refresh
                    } else {
                        displayMessage('add-course-error', result.message, 'error');
                    }
                } catch (err) {
                    displayMessage('add-course-error', err.message, 'error');
                } finally {
                    addCourseButton.disabled = false;
                }
            });

            courseListContainer.addEventListener('click', async (e) => {
                const target = e.target;
                if (target.tagName === 'BUTTON' && target.dataset.action) {
                    const courseCode = target.dataset.code;
                    if (target.dataset.action === 'edit') {
                        const courseCard = target.closest('.course-card');
                        const title = courseCard.querySelector('.course-title').textContent;
                        const credits = courseCard.dataset.credits;
                        
                        openCourseEditModal(courseCode, title, credits);
                    } else if (target.dataset.action === 'delete') {
                        openConfirmationModal(
                            'Confirm Deletion',
                            `Are you sure you want to delete course ${courseCode}? This will also remove associated grades.`,
                            async () => {
                                try {
                                    const result = await api.deleteCourse(courseCode);
                                    if (result.success) {
                                        displayMessage('course-list-message', result.message, 'success');
                                        await refreshCourseData(); // Use pagination refresh
                                    } else {
                                        displayMessage('course-list-error', result.message, 'error');
                                    }
                                } catch (err) {
                                    displayMessage('course-list-error', err.message, 'error');
                                }
                            }
                        );
                    }
                }
            });

            // Initialize courses pagination controls
            initializeCoursesPagination();

            // Toggle functionality for Load All / Hide Courses with pagination
            loadAllCoursesButton.addEventListener('click', async () => {
                if (loadAllCoursesButton.textContent.trim() === 'Load Courses') {
                    loadAllCoursesButton.disabled = true;
                    
                    await loadAllCoursesWithPagination();
                    
                    loadAllCoursesButton.textContent = 'Hide Courses';
                    loadAllCoursesButton.disabled = false;
                } else {
                    // Hide courses and reset pagination
                    coursesPaginationState.isLoaded = false;
                    coursesPaginationState.allCourses = [];
                    coursesPaginationState.totalCourses = 0;
                    coursesPaginationState.currentPage = 1;
                    
                    // Hide pagination controls
                    const paginationControls = document.getElementById('courses-pagination-controls');
                    const paginationInfo = document.getElementById('courses-pagination-info');
                    paginationControls.classList.add('hidden');
                    paginationInfo.classList.add('hidden');
                    
                    courseListContainer.innerHTML = `
                        <div class="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">No courses loaded</h3>
                            <p class="mt-1 text-sm text-gray-500">Click "Load Courses" to view the course catalog.</p>
                        </div>
                    `;
                    loadAllCoursesButton.textContent = 'Load Courses';
                }
            });
        };

        // --- Admin Semester Management ---
        const renderAdminSemesterManagement = async (parentDiv) => {
            parentDiv.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Semester Management</h3>
                    
                    <div class="mb-6 p-4 border border-gray-200 rounded-md bg-gray-50">
                        <h4 class="text-lg font-semibold mb-3 text-gray-700">Add New Semester</h4>
                        <form id="add-semester-form" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <input type="text" id="new-semester-name" placeholder="Semester Name (e.g., Semester 1)" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                            <input type="number" id="new-semester-year" placeholder="Academic Year (e.g., 2024)" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                            <button type="submit" id="add-semester-button" class="col-span-full bg-green-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-green-700 disabled:opacity-50">
                                Add Semester
                            </button>
                        </form>
                        <p id="add-semester-message" class="mt-3 text-center text-sm"></p>
                        <p id="add-semester-error" class="mt-3 text-center text-sm"></p>
                    </div>

                    <div class="mb-6 flex justify-between items-center">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-700">All Semesters</h4>
                            <p class="text-sm text-gray-500 mt-1">Manage semester records with pagination</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <!-- Page Size Selector -->
                            <div class="flex items-center space-x-2">
                                <label for="semesters-per-page" class="text-sm text-gray-600">Per page:</label>
                                <select id="semesters-per-page" class="border border-gray-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="10" selected>10</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                            <button id="load-all-semesters-button" class="bg-green-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-green-700 disabled:opacity-50">
                                Load All Semesters
                            </button>
                        </div>
                    </div>
                    
                    <!-- Pagination Info Bar -->
                    <div id="semesters-pagination-info" class="hidden mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-center justify-between text-sm">
                            <div id="semesters-count-info" class="text-blue-800"></div>
                            <div id="semesters-loading-progress" class="text-blue-600"></div>
                        </div>
                    </div>
                    <p id="semester-list-loading" class="text-center text-gray-600 py-6 hidden">Loading semesters...</p>
                    <p id="semester-list-error" class="text-red-600 text-center py-6 hidden"></p>
                    <div id="semester-list-container" class="overflow-x-auto rounded-md border border-gray-200">
                        <p class="text-gray-600 text-center py-6">Click "Load All Semesters" to view all semesters.</p>
                    </div>
                    
                    <!-- Pagination Controls -->
                    <div id="semesters-pagination-controls" class="hidden mt-6 flex items-center justify-between bg-white px-4 py-3 border border-gray-200 rounded-lg">
                        <div class="flex items-center text-sm text-gray-700">
                            <span id="semesters-pagination-showing">Showing 1 to 10 of 50 semesters</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="semesters-pagination-first" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                First
                            </button>
                            <button id="semesters-pagination-prev" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Previous
                            </button>
                            <div id="semesters-pagination-pages" class="flex items-center space-x-1">
                                <!-- Page numbers will be dynamically inserted here -->
                            </div>
                            <button id="semesters-pagination-next" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                Next
                            </button>
                            <button id="semesters-pagination-last" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                Last
                            </button>
                        </div>
                    </div>
                </div>
            `;
            const addSemesterForm = document.getElementById('add-semester-form');
            const addSemesterButton = document.getElementById('add-semester-button');
            const addSemesterMessage = document.getElementById('add-semester-message');
            const addSemesterError = document.getElementById('add-semester-error');
            const loadAllSemestersButton = document.getElementById('load-all-semesters-button');
            const semesterListContainer = document.getElementById('semester-list-container');
            const semesterListLoading = document.getElementById('semester-list-loading');
            const semesterListError = document.getElementById('semester-list-error');

            // Semesters Pagination State
            let semestersPaginationState = {
                currentPage: 1,
                pageSize: 10,
                totalSemesters: 0,
                totalPages: 0,
                allSemesters: [],
                isLoaded: false
            };

            // Initialize semesters pagination controls
            const initializeSemestersPagination = () => {
                const pageSize = document.getElementById('semesters-per-page');
                const paginationInfo = document.getElementById('semesters-pagination-info');
                const countInfo = document.getElementById('semesters-count-info');
                const progressInfo = document.getElementById('semesters-loading-progress');
                const paginationControls = document.getElementById('semesters-pagination-controls');
                const showingText = document.getElementById('semesters-pagination-showing');
                const firstBtn = document.getElementById('semesters-pagination-first');
                const prevBtn = document.getElementById('semesters-pagination-prev');
                const nextBtn = document.getElementById('semesters-pagination-next');
                const lastBtn = document.getElementById('semesters-pagination-last');
                const pagesContainer = document.getElementById('semesters-pagination-pages');

                // Page size change handler
                pageSize.addEventListener('change', (e) => {
                    semestersPaginationState.pageSize = parseInt(e.target.value);
                    semestersPaginationState.currentPage = 1;
                    if (semestersPaginationState.isLoaded) {
                        renderSemestersPage();
                        updateSemestersPaginationUI();
                    }
                });

                // Navigation button handlers
                firstBtn.addEventListener('click', () => {
                    if (semestersPaginationState.currentPage > 1) {
                        semestersPaginationState.currentPage = 1;
                        renderSemestersPage();
                        updateSemestersPaginationUI();
                    }
                });

                prevBtn.addEventListener('click', () => {
                    if (semestersPaginationState.currentPage > 1) {
                        semestersPaginationState.currentPage--;
                        renderSemestersPage();
                        updateSemestersPaginationUI();
                    }
                });

                nextBtn.addEventListener('click', () => {
                    if (semestersPaginationState.currentPage < semestersPaginationState.totalPages) {
                        semestersPaginationState.currentPage++;
                        renderSemestersPage();
                        updateSemestersPaginationUI();
                    }
                });

                lastBtn.addEventListener('click', () => {
                    if (semestersPaginationState.currentPage < semestersPaginationState.totalPages) {
                        semestersPaginationState.currentPage = semestersPaginationState.totalPages;
                        renderSemestersPage();
                        updateSemestersPaginationUI();
                    }
                });
            };

            // Update semesters pagination UI state
            const updateSemestersPaginationUI = () => {
                const showingText = document.getElementById('semesters-pagination-showing');
                const firstBtn = document.getElementById('semesters-pagination-first');
                const prevBtn = document.getElementById('semesters-pagination-prev');
                const nextBtn = document.getElementById('semesters-pagination-next');
                const lastBtn = document.getElementById('semesters-pagination-last');
                const pagesContainer = document.getElementById('semesters-pagination-pages');
                const paginationControls = document.getElementById('semesters-pagination-controls');

                if (!semestersPaginationState.isLoaded || semestersPaginationState.totalSemesters === 0) {
                    paginationControls.classList.add('hidden');
                    return;
                }

                // Calculate display ranges
                const startRecord = (semestersPaginationState.currentPage - 1) * semestersPaginationState.pageSize + 1;
                const endRecord = Math.min(semestersPaginationState.currentPage * semestersPaginationState.pageSize, semestersPaginationState.totalSemesters);

                // Update showing text
                showingText.textContent = `Showing ${startRecord} to ${endRecord} of ${semestersPaginationState.totalSemesters} semesters`;

                // Update button states
                firstBtn.disabled = semestersPaginationState.currentPage <= 1;
                prevBtn.disabled = semestersPaginationState.currentPage <= 1;
                nextBtn.disabled = semestersPaginationState.currentPage >= semestersPaginationState.totalPages;
                lastBtn.disabled = semestersPaginationState.currentPage >= semestersPaginationState.totalPages;

                // Generate page numbers
                generateSemesterPageNumbers();

                // Show pagination controls
                paginationControls.classList.remove('hidden');
            };

            // Generate semester page number buttons
            const generateSemesterPageNumbers = () => {
                const pagesContainer = document.getElementById('semesters-pagination-pages');
                pagesContainer.innerHTML = '';

                const currentPage = semestersPaginationState.currentPage;
                const totalPages = semestersPaginationState.totalPages;

                // Show max 5 page numbers
                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, startPage + 4);
                
                // Adjust if we're near the end
                if (endPage - startPage < 4) {
                    startPage = Math.max(1, endPage - 4);
                }

                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.textContent = i;
                    pageBtn.className = `px-3 py-1 text-sm border rounded hover:bg-gray-50 ${
                        i === currentPage 
                            ? 'bg-blue-500 text-white border-blue-500' 
                            : 'border-gray-300'
                    }`;
                    
                    if (i !== currentPage) {
                        pageBtn.addEventListener('click', () => {
                            semestersPaginationState.currentPage = i;
                            renderSemestersPage();
                            updateSemestersPaginationUI();
                        });
                    }
                    
                    pagesContainer.appendChild(pageBtn);
                }
            };

            // Render current page of semesters
            const renderSemestersPage = () => {
                const startIndex = (semestersPaginationState.currentPage - 1) * semestersPaginationState.pageSize;
                const endIndex = startIndex + semestersPaginationState.pageSize;
                const pageSemesters = semestersPaginationState.allSemesters.slice(startIndex, endIndex);
                
                renderSemesterTable(pageSemesters);
            };

            // Render semester table for given semesters
            const renderSemesterTable = (semesters) => {
                if (semesters.length === 0) {
                    semesterListContainer.innerHTML = `<p class="text-gray-600 text-center py-6">No semesters found.</p>`;
                    return;
                }

                let tableHtml = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Semester Name</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Academic Year</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                `;
                semesters.forEach(semester => {
                    tableHtml += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${semester.semester_name}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${semester.academic_year}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                                    <button data-action="edit" data-name="${semester.semester_name}" class="text-blue-600 hover:text-blue-900 mx-1">Edit</button>
                                    <button data-action="delete" data-name="${semester.semester_name}" class="text-red-600 hover:text-red-900 mx-1">Delete</button>
                                </td>
                            </tr>
                    `;
                });
                tableHtml += `
                        </tbody>
                    </table>
                `;
                semesterListContainer.innerHTML = tableHtml;
            };

            // Load all semesters with pagination
            const loadAllSemestersWithPagination = async () => {
                const paginationInfo = document.getElementById('semesters-pagination-info');
                const countInfo = document.getElementById('semesters-count-info');
                const progressInfo = document.getElementById('semesters-loading-progress');

                try {
                    // Show loading info
                    paginationInfo.classList.remove('hidden');
                    progressInfo.textContent = 'Loading semesters...';
                    
                    // Fetch all semesters
                    const response = await api.getAllSemesters();
                    
                    if (response.success) {
                        semestersPaginationState.allSemesters = response.data.semesters;
                        semestersPaginationState.totalSemesters = response.data.semesters.length;
                        semestersPaginationState.totalPages = Math.ceil(semestersPaginationState.totalSemesters / semestersPaginationState.pageSize);
                        semestersPaginationState.currentPage = 1;
                        semestersPaginationState.isLoaded = true;
                        
                        // Update UI
                        countInfo.textContent = `Loaded ${semestersPaginationState.totalSemesters} semesters`;
                        progressInfo.textContent = 'Ready';
                        
                        // Render first page
                        renderSemestersPage();
                        updateSemestersPaginationUI();
                        
                        // Auto-hide info after success
                        setTimeout(() => {
                            paginationInfo.classList.add('hidden');
                        }, 2000);
                        
                    } else {
                        throw new Error(response.message || 'Failed to load semesters');
                    }
                } catch (error) {
                    console.error('Error loading semesters:', error);
                    progressInfo.textContent = 'Error loading semesters';
                    countInfo.textContent = error.message;
                    semesterListContainer.innerHTML = `<p class="text-red-600 text-center py-6">${error.message}</p>`;
                }
            };

            // Initialize pagination controls
            initializeSemestersPagination();

            const fetchAndRenderSemesters = async () => {
                semesterListLoading.classList.remove('hidden');
                semesterListError.classList.add('hidden');
                semesterListContainer.innerHTML = '';
                try {
                    const data = await api.getAllSemesters();
                    if (data.success) {
                        if (data.data.semesters.length === 0) {
                            semesterListContainer.innerHTML = `<p class="text-gray-600 text-center py-6">No semesters found.</p>`;
                        } else {
                            let tableHtml = `
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Semester Name</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Academic Year</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                            `;
                            data.data.semesters.forEach(semester => {
                                tableHtml += `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${semester.semester_name}</td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${semester.academic_year}</td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                                                <button data-action="edit" data-name="${semester.semester_name}" class="text-blue-600 hover:text-blue-900 mx-1">Edit</button>
                                                <button data-action="delete" data-name="${semester.semester_name}" class="text-red-600 hover:text-red-900 mx-1">Delete</button>
                                            </td>
                                        </tr>
                                `;
                            });
                            tableHtml += `
                                    </tbody>
                                </table>
                            `;
                            semesterListContainer.innerHTML = tableHtml;
                        }
                    } else {
                        semesterListError.textContent = data.message || 'Failed to fetch semesters.';
                        semesterListError.classList.remove('hidden');
                    }
                } catch (error) {
                    semesterListError.textContent = error.message || 'An error occurred while fetching semesters.';
                    semesterListError.classList.remove('hidden');
                } finally {
                    semesterListLoading.classList.add('hidden');
                }
            };
            addSemesterForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                addSemesterButton.disabled = true;
                displayMessage('add-semester-message', '', 'success');
                displayMessage('add-semester-error', '', 'error');
                const newSemester = {
                    semester_name: document.getElementById('new-semester-name').value,
                    academic_year: parseInt(document.getElementById('new-semester-year').value),
                };
                try {
                    const result = await api.createSemester(newSemester);
                    if (result.success) {
                        displayMessage('add-semester-message', result.message, 'success');
                        addSemesterForm.reset();
                        // Refresh pagination if loaded
                        if (semestersPaginationState.isLoaded) {
                            await loadAllSemestersWithPagination();
                        } else {
                            fetchAndRenderSemesters();
                        }
                    } else {
                        displayMessage('add-semester-error', result.message, 'error');
                    }
                } catch (err) {
                    displayMessage('add-semester-error', err.message, 'error');
                } finally {
                    addSemesterButton.disabled = false;
                }
            });
            semesterListContainer.addEventListener('click', async (e) => {
                const target = e.target;
                if (target.tagName === 'BUTTON' && target.dataset.action) {
                    const semesterName = target.dataset.name;
                    if (target.dataset.action === 'delete') {
                        openConfirmationModal(
                            'Confirm Deletion',
                            `Are you sure you want to delete semester ${semesterName}?`,
                            async () => {
                                try {
                                    const result = await api.deleteSemester(semesterName);
                                    if (result.success) {
                                        displayMessage('semester-list-message', result.message, 'success');
                                        // Refresh pagination if loaded
                                        if (semestersPaginationState.isLoaded) {
                                            await loadAllSemestersWithPagination();
                                        } else {
                                            fetchAndRenderSemesters();
                                        }
                                    } else {
                                        displayMessage('semester-list-error', result.message, 'error');
                                    }
                                } catch (err) {
                                    displayMessage('semester-list-error', err.message, 'error');
                                }
                            }
                        );
                    }
                }
            });
            
            // Toggle functionality for Load All / Hide Semesters with pagination
            loadAllSemestersButton.addEventListener('click', async () => {
                if (loadAllSemestersButton.textContent.trim() === 'Load All Semesters') {
                    // Load semesters with pagination
                    loadAllSemestersButton.disabled = true;
                    
                    await loadAllSemestersWithPagination();
                    
                    loadAllSemestersButton.innerHTML = 'Hide Semesters';
                    loadAllSemestersButton.disabled = false;
                } else {
                    // Hide semesters and reset pagination
                    semestersPaginationState.isLoaded = false;
                    semestersPaginationState.allSemesters = [];
                    semestersPaginationState.totalSemesters = 0;
                    semestersPaginationState.currentPage = 1;
                    
                    // Hide pagination controls
                    const paginationControls = document.getElementById('semesters-pagination-controls');
                    const paginationInfo = document.getElementById('semesters-pagination-info');
                    paginationControls.classList.add('hidden');
                    paginationInfo.classList.add('hidden');
                    
                    semesterListContainer.innerHTML = '<p class="text-gray-600 text-center py-6">Click "Load All Semesters" to view all semesters.</p>';
                    loadAllSemestersButton.textContent = 'Load All Semesters';
                }
            });
        };

        // --- Admin Grade Management ---
        const renderAdminGradeManagement = async (parentDiv) => {
            parentDiv.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Grade Management</h3>
                    
                    <div class="mb-6 p-4 border border-gray-200 rounded-md bg-gray-50">
                        <h4 class="text-lg font-semibold mb-3 text-gray-700">Add New Grade</h4>
                        <form id="add-grade-form" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <input type="text" id="new-grade-index" placeholder="Student Index Number" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                            <input type="text" id="new-grade-course" placeholder="Course Code" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                            <input type="text" id="new-grade-semester" placeholder="Semester Name" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                            <input type="text" id="new-grade-year" placeholder="Academic Year (e.g., 2023/2024)" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                            <input type="number" step="0.1" min="0" max="100" id="new-grade-score" placeholder="Score (0-100)" class="col-span-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                            <button type="submit" id="add-grade-button" class="col-span-full bg-green-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-green-700 disabled:opacity-50">
                                Add Grade
                            </button>
                        </form>
                        <p id="add-grade-message" class="mt-3 text-center text-sm"></p>
                        <p id="add-grade-error" class="mt-3 text-center text-sm"></p>
                    </div>

                    <div class="mb-6 flex justify-between items-center">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-700">Student Grades Overview</h4>
                            <p class="text-sm text-gray-500 mt-1">Organized by student with GPA calculations and expandable details</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <!-- Page Size Selector -->
                            <div class="flex items-center space-x-2">
                                <label for="grades-per-page" class="text-sm text-gray-600">Per page:</label>
                                <select id="grades-per-page" class="border border-gray-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="10">10</option>
                                    <option value="20" selected>20</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                            <button id="load-all-grades-button" class="bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700 disabled:opacity-50">
                                Load Student Grades
                            </button>
                        </div>
                    </div>
                    
                    <!-- Pagination Info Bar -->
                    <div id="grades-pagination-info" class="hidden mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-center justify-between text-sm">
                            <div id="grades-count-info" class="text-blue-800"></div>
                            <div id="grades-loading-progress" class="text-blue-600"></div>
                        </div>
                    </div>
                    
                    
                    <p id="grade-list-error" class="text-red-600 text-center py-6 hidden"></p>
                    <div id="grade-list-container" class="rounded-md">
                        <div class="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">No grades loaded</h3>
                            <p class="mt-1 text-sm text-gray-500">Click "Load Student Grades" to view student performance data.</p>
                        </div>
                    </div>
                    
                    <!-- Pagination Controls -->
                    <div id="grades-pagination-controls" class="hidden mt-6 flex items-center justify-between bg-white px-4 py-3 border border-gray-200 rounded-lg">
                        <div class="flex items-center text-sm text-gray-700">
                            <span id="grades-pagination-showing">Showing 1 to 20 of 100 students</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="grades-pagination-first" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                First
                            </button>
                            <button id="grades-pagination-prev" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Previous
                            </button>
                            <div id="grades-pagination-pages" class="flex items-center space-x-1">
                                <!-- Page numbers will be dynamically inserted here -->
                            </div>
                            <button id="grades-pagination-next" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                Next
                            </button>
                            <button id="grades-pagination-last" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                Last
                            </button>
                        </div>
                    </div>
                </div>
            `;
            const addGradeForm = document.getElementById('add-grade-form');
            const addGradeButton = document.getElementById('add-grade-button');
            const addGradeMessage = document.getElementById('add-grade-message');
            const addGradeError = document.getElementById('add-grade-error');
            const loadAllGradesButton = document.getElementById('load-all-grades-button');
            const gradeListContainer = document.getElementById('grade-list-container');
            const gradeListError = document.getElementById('grade-list-error');

            // Simple Grades Pagination State
            let gradesPaginationState = {
                currentPage: 1,
                pageSize: 20,
                totalStudents: 0,
                totalPages: 0,
                allStudentGrades: {},
                allStudentsList: [],
                isLoaded: false
            };

            // Initialize grades pagination controls
            const initializeGradesPagination = () => {
                const pageSize = document.getElementById('grades-per-page');
                const paginationInfo = document.getElementById('grades-pagination-info');
                const countInfo = document.getElementById('grades-count-info');
                const progressInfo = document.getElementById('grades-loading-progress');
                const paginationControls = document.getElementById('grades-pagination-controls');
                const showingText = document.getElementById('grades-pagination-showing');
                const firstBtn = document.getElementById('grades-pagination-first');
                const prevBtn = document.getElementById('grades-pagination-prev');
                const nextBtn = document.getElementById('grades-pagination-next');
                const lastBtn = document.getElementById('grades-pagination-last');
                const pagesContainer = document.getElementById('grades-pagination-pages');

                // Page size change handler
                pageSize.addEventListener('change', (e) => {
                    gradesPaginationState.pageSize = parseInt(e.target.value);
                    gradesPaginationState.currentPage = 1;
                    if (gradesPaginationState.isLoaded) {
                        renderGradesPage();
                        updateGradesPaginationUI();
                    }
                });

                // Navigation button handlers
                firstBtn.addEventListener('click', () => {
                    if (gradesPaginationState.currentPage > 1) {
                        gradesPaginationState.currentPage = 1;
                        renderGradesPage();
                        updateGradesPaginationUI();
                    }
                });

                prevBtn.addEventListener('click', () => {
                    if (gradesPaginationState.currentPage > 1) {
                        gradesPaginationState.currentPage--;
                        renderGradesPage();
                        updateGradesPaginationUI();
                    }
                });

                nextBtn.addEventListener('click', () => {
                    if (gradesPaginationState.currentPage < gradesPaginationState.totalPages) {
                        gradesPaginationState.currentPage++;
                        renderGradesPage();
                        updateGradesPaginationUI();
                    }
                });

                lastBtn.addEventListener('click', () => {
                    if (gradesPaginationState.currentPage < gradesPaginationState.totalPages) {
                        gradesPaginationState.currentPage = gradesPaginationState.totalPages;
                        renderGradesPage();
                        updateGradesPaginationUI();
                    }
                });
            };

            // Update grades pagination UI state
            const updateGradesPaginationUI = () => {
                const showingText = document.getElementById('grades-pagination-showing');
                const firstBtn = document.getElementById('grades-pagination-first');
                const prevBtn = document.getElementById('grades-pagination-prev');
                const nextBtn = document.getElementById('grades-pagination-next');
                const lastBtn = document.getElementById('grades-pagination-last');
                const pagesContainer = document.getElementById('grades-pagination-pages');
                const paginationControls = document.getElementById('grades-pagination-controls');

                if (!gradesPaginationState.isLoaded || gradesPaginationState.totalStudents === 0) {
                    paginationControls.classList.add('hidden');
                    return;
                }

                // Calculate display ranges
                const startRecord = (gradesPaginationState.currentPage - 1) * gradesPaginationState.pageSize + 1;
                const endRecord = Math.min(gradesPaginationState.currentPage * gradesPaginationState.pageSize, gradesPaginationState.totalStudents);

                // Update showing text
                showingText.textContent = `Showing ${startRecord} to ${endRecord} of ${gradesPaginationState.totalStudents} students`;

                // Update button states
                firstBtn.disabled = gradesPaginationState.currentPage <= 1;
                prevBtn.disabled = gradesPaginationState.currentPage <= 1;
                nextBtn.disabled = gradesPaginationState.currentPage >= gradesPaginationState.totalPages;
                lastBtn.disabled = gradesPaginationState.currentPage >= gradesPaginationState.totalPages;

                // Generate page numbers
                generateGradePageNumbers();

                // Show pagination controls
                paginationControls.classList.remove('hidden');
            };

            // Generate page number buttons for grades
            const generateGradePageNumbers = () => {
                const pagesContainer = document.getElementById('grades-pagination-pages');
                pagesContainer.innerHTML = '';

                const currentPage = gradesPaginationState.currentPage;
                const totalPages = gradesPaginationState.totalPages;

                // Show max 5 page numbers
                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, startPage + 4);
                
                // Adjust if we're near the end
                if (endPage - startPage < 4) {
                    startPage = Math.max(1, endPage - 4);
                }

                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.textContent = i;
                    pageBtn.className = `px-3 py-1 text-sm border rounded hover:bg-gray-50 ${
                        i === currentPage 
                            ? 'bg-blue-600 text-white border-blue-600 font-medium' 
                            : 'border-gray-300'
                    }`;
                    
                    if (i !== currentPage) {
                        pageBtn.addEventListener('click', () => {
                            gradesPaginationState.currentPage = i;
                            renderGradesPage();
                            updateGradesPaginationUI();
                        });
                    }
                    
                    pagesContainer.appendChild(pageBtn);
                }
            };

            // Render current page of students with grades
            const renderGradesPage = () => {
                const startIndex = (gradesPaginationState.currentPage - 1) * gradesPaginationState.pageSize;
                const endIndex = startIndex + gradesPaginationState.pageSize;
                const pageStudents = gradesPaginationState.allStudentsList.slice(startIndex, endIndex);
                
                // Create subset of student grades for this page
                const pageStudentGrades = {};
                pageStudents.forEach(studentIndex => {
                    if (gradesPaginationState.allStudentGrades[studentIndex]) {
                        pageStudentGrades[studentIndex] = gradesPaginationState.allStudentGrades[studentIndex];
                    }
                });
                
                renderStudentCentricGradesPage(pageStudentGrades);
            };

            // Load all grades with pagination 
            const loadAllGradesWithPagination = async () => {
                const paginationInfo = document.getElementById('grades-pagination-info');
                const countInfo = document.getElementById('grades-count-info');
                const progressInfo = document.getElementById('grades-loading-progress');

                try {
                    // Show loading info
                    paginationInfo.classList.remove('hidden');
                    progressInfo.textContent = 'Loading grades...';
                    
                    // Load all grades with chunked loading
                    let allGrades = [];
                    let skip = 0;
                    const limit = 1000; // Max allowed by backend
                    let hasMore = true;
                    
                    while (hasMore) {
                        progressInfo.textContent = `Loading grades... (${allGrades.length} loaded so far)`;
                        const data = await api.getAllGrades({}, skip, limit);
                        if (data.success && data.data.grades.length > 0) {
                            allGrades = allGrades.concat(data.data.grades);
                            skip += limit;
                            hasMore = data.data.grades.length === limit; // Continue if we got a full batch
                        } else {
                            hasMore = false;
                        }
                    }
                    
                    if (allGrades.length === 0) {
                        gradeListContainer.innerHTML = `<p class="text-gray-600 text-center py-6">No grades found.</p>`;
                        return;
                    }

                    // Process grades into student-centric structure
                    processGradesForPagination(allGrades);
                    
                    // Update UI
                    countInfo.textContent = `Loaded ${allGrades.length} grades for ${gradesPaginationState.totalStudents} students`;
                    progressInfo.textContent = 'Ready';
                    
                    // Render first page
                    renderGradesPage();
                    updateGradesPaginationUI();
                    
                    // Auto-hide info after success
                    setTimeout(() => {
                        paginationInfo.classList.add('hidden');
                    }, 2000);
                    
                } catch (error) {
                    console.error('Error loading grades:', error);
                    progressInfo.textContent = 'Error loading grades';
                    countInfo.textContent = error.message;
                    gradeListContainer.innerHTML = `<p class="text-red-600 text-center py-6">${error.message}</p>`;
                }
            };

            // Process grades into pagination-ready structure
            const processGradesForPagination = (grades) => {
                // Group grades by student
                const studentGrades = {};
                grades.forEach(grade => {
                    if (!studentGrades[grade.student_index]) {
                        studentGrades[grade.student_index] = {
                            student_name: grade.student_name || grade.student_index,
                            grades: [],
                            totalCredits: 0,
                            totalPoints: 0
                        };
                    }
                    studentGrades[grade.student_index].grades.push(grade);
                    // Calculate GPA (assuming credit hours of 3 for each course for now)
                    const creditHours = grade.credit_hours || 3;
                    const gradePoint = grade.grade_point || 0;
                    studentGrades[grade.student_index].totalCredits += creditHours;
                    studentGrades[grade.student_index].totalPoints += (gradePoint * creditHours);
                });

                // Update pagination state
                gradesPaginationState.allStudentGrades = studentGrades;
                gradesPaginationState.allStudentsList = Object.keys(studentGrades).sort();
                gradesPaginationState.totalStudents = gradesPaginationState.allStudentsList.length;
                gradesPaginationState.totalPages = Math.ceil(gradesPaginationState.totalStudents / gradesPaginationState.pageSize);
                gradesPaginationState.currentPage = 1;
                gradesPaginationState.isLoaded = true;
            };

            // Render student-centric grades for the current page
            const renderStudentCentricGradesPage = (studentGrades) => {
                // Simple search interface
                let html = `
                    <div class="mb-4">
                        <input type="text" id="student-search" placeholder="Search students by index or name..." 
                               class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="students-container" class="space-y-4">`;

                // Render each student's grades
                Object.keys(studentGrades).forEach(studentIndex => {
                    const student = studentGrades[studentIndex];
                    const gpa = student.totalCredits > 0 ? (student.totalPoints / student.totalCredits).toFixed(2) : 'N/A';
                    
                    html += `
                        <div class="bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                            <div class="p-4 cursor-pointer" onclick="toggleGrades('${studentIndex}')">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h5 class="font-semibold text-gray-900">${student.student_name}</h5>
                                        <p class="text-sm text-gray-600">Index: ${studentIndex}</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-bold ${gpa >= 3.0 ? 'text-green-600' : gpa >= 2.0 ? 'text-yellow-600' : 'text-red-600'}">
                                            GPA: ${gpa}
                                        </div>
                                        <p class="text-sm text-gray-500">${student.grades.length} courses</p>
                                    </div>
                                </div>
                            </div>
                            <div id="grades-${studentIndex}" class="hidden border-t border-gray-200 p-4 bg-gray-50">
                                <div class="grid gap-2">`;
                    
                    student.grades.forEach(grade => {
                        const gradePoint = parseFloat(grade.grade_point) || 0;
                        const gradeColor = gradePoint >= 3.0 ? 'text-green-600' : gradePoint >= 2.0 ? 'text-yellow-600' : 'text-red-600';
                        html += `
                            <div class="flex justify-between items-center py-2 px-3 bg-white rounded border">
                                <div>
                                    <span class="font-medium">${grade.course_code}</span>
                                    <span class="text-gray-600 ml-2">${grade.semester_name} ${grade.academic_year}</span>
                                </div>
                                <div class="text-right">
                                    <span class="font-semibold ${gradeColor}">${grade.score}</span>
                                    <span class="text-gray-500 text-sm ml-2">(${gradePoint.toFixed(1)})</span>
                                </div>
                            </div>`;
                    });
                    
                    html += `
                                </div>
                            </div>
                        </div>`;
                });
                
                html += `</div>`;
                gradeListContainer.innerHTML = html;
                
                // Add search functionality
                const searchInput = document.getElementById('student-search');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        const studentCards = document.querySelectorAll('#students-container > div');
                        
                        studentCards.forEach(card => {
                            const studentName = card.querySelector('h5').textContent.toLowerCase();
                            const studentIndex = card.querySelector('p').textContent.toLowerCase();
                            const isVisible = studentName.includes(searchTerm) || studentIndex.includes(searchTerm);
                            card.style.display = isVisible ? 'block' : 'none';
                        });
                    });
                }
            };

            // Initialize grades pagination controls
            initializeGradesPagination();

            const fetchAndRenderGrades = async () => {
                gradeListError.classList.add('hidden');
                gradeListContainer.innerHTML = '';
                try {
                    // Load all grades with pagination since we have 4394+ grades
                    let allGrades = [];
                    let skip = 0;
                    const limit = 1000; // Max allowed by backend
                    let hasMore = true;
                    
                    while (hasMore) {
                        const data = await api.getAllGrades({}, skip, limit);
                        if (data.success && data.data.grades.length > 0) {
                            allGrades = allGrades.concat(data.data.grades);
                            skip += limit;
                            hasMore = data.data.grades.length === limit; // Continue if we got a full batch
                        } else {
                            hasMore = false;
                        }
                    }
                    
                    if (allGrades.length === 0) {
                        gradeListContainer.innerHTML = `<p class="text-gray-600 text-center py-6">No grades found.</p>`;
                    } else {
                        renderStudentCentricGrades(allGrades);
                    }
                } catch (error) {
                    gradeListError.textContent = error.message || 'An error occurred while fetching grades.';
                    gradeListError.classList.remove('hidden');
                }
            };

            const renderStudentCentricGrades = (grades) => {
                // Group grades by student
                const studentGrades = {};
                grades.forEach(grade => {
                    if (!studentGrades[grade.student_index]) {
                        studentGrades[grade.student_index] = {
                            student_name: grade.student_name || grade.student_index,
                            grades: [],
                            totalCredits: 0,
                            totalPoints: 0
                        };
                    }
                    studentGrades[grade.student_index].grades.push(grade);
                    // Calculate GPA (assuming credit hours of 3 for each course for now)
                    const creditHours = grade.credit_hours || 3;
                    studentGrades[grade.student_index].totalCredits += creditHours;
                    studentGrades[grade.student_index].totalPoints += (parseFloat(grade.grade_point) || 0) * creditHours;
                });

                // Simple search interface
                let html = `
                    <div class="mb-4">
                        <input type="text" id="student-search" placeholder="Search students by index or name..." 
                               class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="students-container" class="space-y-4">
                `;

                // Create student cards
                Object.entries(studentGrades).forEach(([studentIndex, studentData]) => {
                    const gpa = studentData.totalCredits > 0 ? (studentData.totalPoints / studentData.totalCredits).toFixed(2) : '0.00';
                    const gradeCount = studentData.grades.length;
                    
                    // Get latest semester info
                    const latestGrade = studentData.grades.sort((a, b) => 
                        new Date(b.academic_year) - new Date(a.academic_year))[0];
                    
                    html += `
                        <div class="student-card bg-white border border-gray-200 rounded-lg p-4" 
                             data-student="${studentIndex}" data-student-name="${studentData.student_name}">
                            <div class="cursor-pointer student-header" onclick="toggleStudentDetails('${studentIndex}')">
                                <div class="flex justify-between items-center">
                                    <div class="flex-1">
                                        <h3 class="text-lg font-medium text-gray-900">${studentIndex}</h3>
                                        <p class="text-sm text-gray-600">${studentData.student_name}</p>
                                    </div>
                                    <div class="flex items-center space-x-4">
                                        <div class="text-center">
                                            <div class="text-xl font-bold ${getGpaColor(gpa)}">${gpa}</div>
                                            <div class="text-xs text-gray-500">GPA</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-lg font-medium text-gray-700">${gradeCount}</div>
                                            <div class="text-xs text-gray-500">Courses</div>
                                        </div>
                                        <svg class="w-5 h-5 text-gray-400 expand-icon-${studentIndex}" 
                                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            <div id="details-${studentIndex}" class="student-details hidden border-t border-gray-100">
                                <div class="p-4">
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Course</th>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Semester</th>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Year</th>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Grade</th>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white">
                `;
                
                // Sort grades by semester and year
                studentData.grades.sort((a, b) => {
                    if (a.academic_year !== b.academic_year) {
                        return b.academic_year.localeCompare(a.academic_year);
                    }
                    return a.semester_name.localeCompare(b.semester_name);
                }).forEach(grade => {
                    html += `
                                                <tr class="border-t border-gray-100">
                                                    <td class="px-3 py-2 font-medium text-gray-900">${grade.course_code}</td>
                                                    <td class="px-3 py-2 text-gray-600">${grade.semester_name}</td>
                                                    <td class="px-3 py-2 text-gray-600">${grade.academic_year}</td>
                                                    <td class="px-3 py-2">
                                                        <span class="px-2 py-1 rounded text-xs font-medium ${getGradeBadgeColor(grade.grade)}">
                                                            ${grade.grade}
                                                        </span>
                                                    </td>
                                                    <td class="px-3 py-2">
                                                        <button data-action="edit" data-id="${grade.grade_id}" 
                                                                data-course-code="${grade.course_code}"
                                                                data-semester="${grade.semester_name}"
                                                                data-year="${grade.academic_year}"
                                                                data-score="${grade.score}"
                                                                class="text-blue-600 hover:text-blue-800 text-xs mr-2">Edit</button>
                                                        <button data-action="delete" data-id="${grade.grade_id}" 
                                                                class="text-red-600 hover:text-red-800 text-xs">Delete</button>
                                                    </td>
                                                </tr>
                    `;
                });

                html += `
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
                gradeListContainer.innerHTML = html;

                // Setup search functionality
                setupGradeSearch();
            };

            const getGpaColor = (gpa) => {
                const numGpa = parseFloat(gpa);
                if (numGpa >= 3.5) return 'text-green-600';
                if (numGpa >= 3.0) return 'text-blue-600';
                if (numGpa >= 2.5) return 'text-yellow-600';
                return 'text-red-600';
            };

            const getGradeBadgeColor = (grade) => {
                switch(grade.charAt(0)) {
                    case 'A': return 'bg-green-100 text-green-800';
                    case 'B': return 'bg-blue-100 text-blue-800';
                    case 'C': return 'bg-yellow-100 text-yellow-800';
                    case 'D': return 'bg-orange-100 text-orange-800';
                    case 'F': return 'bg-red-100 text-red-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };

            // Grade filtering and search functionality
            const setupGradeSearch = () => {
                // Simple search functionality
                const searchInput = document.getElementById('student-search');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        const studentCards = document.querySelectorAll('.student-card');
                        
                        studentCards.forEach(card => {
                            const studentIndex = card.dataset.student.toLowerCase();
                            const studentName = card.dataset.studentName.toLowerCase();
                            const matches = studentIndex.includes(searchTerm) || studentName.includes(searchTerm);
                            card.style.display = matches ? 'block' : 'none';
                        });
                    });
                }
            };

            // Global function for toggling individual student details
            window.toggleStudentDetails = (studentIndex) => {
                const details = document.getElementById(`details-${studentIndex}`);
                const icon = document.querySelector(`.expand-icon-${studentIndex}`);
                
                if (details.classList.contains('hidden')) {
                    details.classList.remove('hidden');
                    icon.style.transform = 'rotate(180deg)';
                } else {
                    details.classList.add('hidden');
                    icon.style.transform = 'rotate(0deg)';
                }
            };

            // Refresh grades data for pagination
            const refreshGradesData = async () => {
                if (gradesPaginationState.isLoaded) {
                    await loadAllGradesWithPagination();
                }
            };

            addGradeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                addGradeButton.disabled = true;
                displayMessage('add-grade-message', '', 'success');
                displayMessage('add-grade-error', '', 'error');
                const newGrade = {
                    student_index: document.getElementById('new-grade-index').value,
                    course_code: document.getElementById('new-grade-course').value,
                    semester_name: document.getElementById('new-grade-semester').value,
                    academic_year: document.getElementById('new-grade-year').value,
                    score: parseFloat(document.getElementById('new-grade-score').value || 0),
                };
                try {
                    const result = await api.createGrade(newGrade);
                    if (result.success) {
                        displayMessage('add-grade-message', result.message, 'success');
                        addGradeForm.reset();
                        await refreshGradesData(); // Use pagination refresh instead
                    } else {
                        displayMessage('add-grade-error', result.message, 'error');
                    }
                } catch (err) {
                    displayMessage('add-grade-error', err.message, 'error');
                } finally {
                    addGradeButton.disabled = false;
                }
            });
            
            // Toggle functionality for Load All / Hide Grades with pagination
            loadAllGradesButton.addEventListener('click', async () => {
                if (loadAllGradesButton.textContent.trim() === 'Load Student Grades') {
                    // Load grades with pagination
                    loadAllGradesButton.disabled = true;
                    
                    await loadAllGradesWithPagination();
                    
                    loadAllGradesButton.textContent = 'Hide Grades';
                    loadAllGradesButton.disabled = false;
                } else {
                    // Hide grades and reset pagination
                    gradesPaginationState.isLoaded = false;
                    gradesPaginationState.allStudentGrades = {};
                    gradesPaginationState.allStudentsList = [];
                    gradesPaginationState.totalStudents = 0;
                    gradesPaginationState.currentPage = 1;
                    
                    // Hide pagination controls
                    const paginationControls = document.getElementById('grades-pagination-controls');
                    const paginationInfo = document.getElementById('grades-pagination-info');
                    paginationControls.classList.add('hidden');
                    paginationInfo.classList.add('hidden');
                    
                    gradeListContainer.innerHTML = `
                        <div class="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">No grades loaded</h3>
                            <p class="mt-1 text-sm text-gray-500">Click "Load Student Grades" to view student performance data.</p>
                        </div>
                    `;
                    loadAllGradesButton.textContent = 'Load Student Grades';
                }
            });

            // Event listener for grade actions (edit, delete)
            gradeListContainer.addEventListener('click', async (e) => {
                const target = e.target;
                if (target.tagName === 'BUTTON' && target.dataset.action) {
                    const gradeId = target.dataset.id;
                    if (target.dataset.action === 'edit') {
                        const courseCode = target.dataset.courseCode;
                        const semester = target.dataset.semester;
                        const academicYear = target.dataset.year;
                        const score = target.dataset.score;
                        
                        openGradeEditModal(gradeId, courseCode, semester, academicYear, score);
                    } else if (target.dataset.action === 'delete') {
                        openConfirmationModal(
                            'Confirm Deletion',
                            `Are you sure you want to delete this grade record?`,
                            async () => {
                                try {
                                    const result = await api.deleteGrade(gradeId);
                                    if (result.success) {
                                        showToast('Grade deleted successfully!', 'success');
                                        await refreshGradesData(); // Use pagination refresh instead
                                    } else {
                                        showToast(result.message, 'error');
                                    }
                                } catch (err) {
                                    showToast(err.message, 'error');
                                }
                            }
                        );
                    }
                }
            });
        };

        // --- Admin User Management ---
        const renderAdminUserManagement = async (parentDiv) => {
            parentDiv.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold mb-4 text-gray-800">User Management</h3>
                    <p class="text-gray-600 mb-6">Create new admin or student user accounts and reset student passwords.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-4 border border-gray-200 rounded-md bg-gray-50">
                            <h4 class="text-lg font-semibold mb-3 text-gray-700">Create Admin Account</h4>
                            <form id="create-user-form" class="space-y-3">
                                <input type="text" id="new-user-username" placeholder="Username" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                                <input type="password" id="new-user-password" placeholder="Password" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                                <button type="submit" id="create-user-button" class="w-full bg-blue-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-blue-700 disabled:opacity-50">
                                    Create Admin
                                </button>
                            </form>
                            <p id="create-user-message" class="mt-3 text-center text-sm"></p>
                        </div>
                        
                        <div class="p-4 border border-gray-200 rounded-md bg-gray-50">
                            <h4 class="text-lg font-semibold mb-3 text-gray-700">Create Student Account</h4>
                            <p class="text-sm text-gray-500 mb-3">Ensure the student already exists in the student management section.</p>
                            <form id="create-student-account-form" class="space-y-3">
                                <input type="text" id="new-student-account-index" placeholder="Student Index Number" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                                <input type="password" id="new-student-account-password" placeholder="Initial Password" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                                <button type="submit" id="create-student-account-button" class="w-full bg-green-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-green-700 disabled:opacity-50">
                                    Create Student Account
                                </button>
                            </form>
                            <p id="create-student-account-message" class="mt-3 text-center text-sm"></p>
                        </div>

                        <div class="p-4 border border-gray-200 rounded-md bg-gray-50 md:col-span-2">
                            <h4 class="text-lg font-semibold mb-3 text-gray-700">Reset Student Password</h4>
                            <form id="reset-student-password-form" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <input type="text" id="reset-student-index" placeholder="Student Index Number" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                                <input type="password" id="reset-student-password-new" placeholder="New Password" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                                <button type="submit" id="reset-student-password-button" class="col-span-full bg-red-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-red-700 disabled:opacity-50">
                                    Reset Password
                                </button>
                            </form>
                            <p id="reset-student-password-message" class="mt-3 text-center text-sm"></p>
                        </div>
                    </div>
                </div>
            `;
            const createUserForm = document.getElementById('create-user-form');
            const createStudentAccountForm = document.getElementById('create-student-account-form');
            const resetStudentPasswordForm = document.getElementById('reset-student-password-form');
            createUserForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newUser = {
                    username: document.getElementById('new-user-username').value,
                    password: document.getElementById('new-user-password').value
                };
                try {
                    const result = await api.createUserAccount(newUser);
                    displayMessage('create-user-message', result.message);
                } catch (err) {
                    displayMessage('create-user-message', err.message, 'error');
                }
            });
            createStudentAccountForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newAccount = {
                    index_number: document.getElementById('new-student-account-index').value,
                    password: document.getElementById('new-student-account-password').value
                };
                try {
                    const result = await api.createStudentAccount(newAccount);
                    displayMessage('create-student-account-message', result.message);
                } catch (err) {
                    displayMessage('create-student-account-message', err.message, 'error');
                }
            });
            resetStudentPasswordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const resetData = {
                    index_number: document.getElementById('reset-student-index').value,
                    password: document.getElementById('reset-student-password-new').value
                };
                try {
                    const result = await api.resetStudentPassword(resetData);
                    displayMessage('reset-student-password-message', result.message);
                } catch (err) {
                    displayMessage('reset-student-password-message', err.message, 'error');
                }
            });
        };

        // --- Admin Bulk Operations ---
        const renderAdminBulkOperations = async (parentDiv) => {
            parentDiv.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Bulk Operations</h3>
                    <div class="mb-6">
                        <p class="text-gray-700">Use this section to import data in bulk. The system expects a JSON object with keys 'students', 'courses', 'semesters', and 'grades', each containing an array of objects.</p>
                        <a href="#" class="text-blue-600 hover:underline">Download a sample JSON file here.</a>
                    </div>
                    <form id="bulk-import-form" class="space-y-4">
                        <div>
                            <label for="json-input" class="block text-sm font-medium text-gray-700 mb-2">Paste JSON Data:</label>
                            <textarea id="json-input" rows="10" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 font-mono text-sm" placeholder='{"students": [...], "courses": [...], ...}'></textarea>
                        </div>
                        <button type="submit" id="bulk-import-button" class="w-full bg-blue-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-blue-700 disabled:opacity-50">
                            Perform Bulk Import
                        </button>
                        <p id="bulk-import-message" class="mt-3 text-center text-sm"></p>
                    </form>
                </div>
            `;
            const bulkImportForm = document.getElementById('bulk-import-form');
            bulkImportForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const jsonInput = document.getElementById('json-input').value;
                const importButton = document.getElementById('bulk-import-button');
                importButton.disabled = true;
                displayMessage('bulk-import-message', 'Importing data...', 'info');
                try {
                    const data = JSON.parse(jsonInput);
                    const result = await api.bulkImportData(data);
                    displayMessage('bulk-import-message', result.message, 'success');
                } catch (err) {
                    displayMessage('bulk-import-message', err.message, 'error');
                } finally {
                    importButton.disabled = false;
                }
            });
        };
        
        // --- Admin Report Management ---
        const renderAdminReportManagement = async (parentDiv) => {
            parentDiv.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Report Generation</h3>

                    <div class="mb-6 p-4 border border-gray-200 rounded-md bg-gray-50">
                        <h4 class="text-lg font-semibold mb-3 text-gray-700">Summary Report</h4>
                        <div class="flex flex-col md:flex-row gap-4 mb-4">
                            <select id="report-academic-year" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 w-full md:w-1/2">
                                <option value="">All Academic Years</option>
                                </select>
                            <button id="generate-summary-report-button" class="bg-blue-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-blue-700 disabled:opacity-50 w-full md:w-1/2">
                                Generate Summary Report (JSON)
                            </button>
                        </div>
                        <div class="flex flex-col md:flex-row gap-4 mb-4">
                            <button id="download-summary-report-pdf-button" class="w-full bg-red-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-red-700 disabled:opacity-50">
                                Download PDF
                            </button>
                            <button id="download-summary-report-txt-button" class="w-full bg-blue-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-blue-700 disabled:opacity-50">
                                Download TXT
                            </button>
                        </div>
                        <div class="flex flex-col md:flex-row gap-4 mb-4">
                            <button id="download-summary-report-excel-button" class="w-full bg-green-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-green-700 disabled:opacity-50">
                                Download Excel (XLSX)
                            </button>
                            <button id="download-summary-report-csv-button" class="w-full bg-orange-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-orange-700 disabled:opacity-50">
                                Download CSV
                            </button>
                        </div>
                        <p id="report-message" class="mt-3 text-center text-sm"></p>
                        <div id="report-preview" class="mt-4 p-4 bg-white border border-gray-200 rounded-md max-h-96 overflow-y-auto">
                            </div>
                    </div>

                    </div>
            `;
            
            const generateReportButton = document.getElementById('generate-summary-report-button');
            const downloadPdfButton = document.getElementById('download-summary-report-pdf-button');
            const downloadTxtButton = document.getElementById('download-summary-report-txt-button');
            const downloadExcelButton = document.getElementById('download-summary-report-excel-button');
            const downloadCsvButton = document.getElementById('download-summary-report-csv-button');
            const reportMessage = document.getElementById('report-message');
            const reportPreview = document.getElementById('report-preview');

            const populateAcademicYears = async () => {
                const yearSelect = document.getElementById('report-academic-year');
                yearSelect.innerHTML = '<option value="">All Academic Years</option>';
                const years = new Set(Object.values(semesters_db).map(s => s.academic_year));
                [...years].sort().forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                });
            };

            generateReportButton.addEventListener('click', async () => {
                reportMessage.textContent = 'Generating report...';
                reportMessage.className = 'mt-3 text-center text-sm text-blue-600';
                reportPreview.innerHTML = '';
                generateReportButton.disabled = true;

                const academicYear = document.getElementById('report-academic-year').value;
                const filters = academicYear ? { academic_year: parseInt(academicYear) } : {};

                try {
                    const report = await api.generateSummaryReport(filters);
                    reportMessage.textContent = 'Report generated successfully!';
                    reportMessage.className = 'mt-3 text-center text-sm text-green-600';
                    reportPreview.textContent = JSON.stringify(report.data, null, 2);
                } catch (error) {
                    reportMessage.textContent = `Error: ${error.message}`;
                    reportMessage.className = 'mt-3 text-center text-sm text-red-600';
                } finally {
                    generateReportButton.disabled = false;
                }
            });

            // Event listener for the PDF download button
            downloadPdfButton.addEventListener('click', async () => {
                reportMessage.textContent = 'Preparing PDF for download...';
                reportMessage.className = 'mt-3 text-center text-sm text-blue-600';
                downloadPdfButton.disabled = true;
                downloadPdfButton.textContent = 'Downloading PDF...';

                const academicYear = document.getElementById('report-academic-year').value;
                const filters = academicYear ? { academic_year: parseInt(academicYear) } : {};

                try {
                    await api.downloadSummaryReportPdf(filters);
                    reportMessage.textContent = 'PDF download started. Check your browser downloads.';
                    reportMessage.className = 'mt-3 text-center text-sm text-green-600';
                } catch (error) {
                    reportMessage.textContent = `Error downloading PDF: ${error.message}`;
                    reportMessage.className = 'mt-3 text-center text-sm text-red-600';
                } finally {
                    downloadPdfButton.disabled = false;
                    downloadPdfButton.textContent = 'Download PDF';
                }
            });
            
            // Event listener for the TXT download button
            downloadTxtButton.addEventListener('click', async () => {
                reportMessage.textContent = 'Preparing text report for download...';
                reportMessage.className = 'mt-3 text-center text-sm text-blue-600';
                downloadTxtButton.disabled = true;
                downloadTxtButton.textContent = 'Downloading TXT...';

                const academicYear = document.getElementById('report-academic-year').value;
                const filters = academicYear ? { academic_year: parseInt(academicYear) } : {};

                try {
                    await api.downloadSummaryReportTxt(filters);
                    reportMessage.textContent = 'Text report download started. Check your browser downloads.';
                    reportMessage.className = 'mt-3 text-center text-sm text-green-600';
                } catch (error) {
                    reportMessage.textContent = `Error downloading text report: ${error.message}`;
                    reportMessage.className = 'mt-3 text-center text-sm text-red-600';
                } finally {
                    downloadTxtButton.disabled = false;
                    downloadTxtButton.textContent = 'Download TXT';
                }
            });

            // Event listener for the Excel download button
            downloadExcelButton.addEventListener('click', async () => {
                reportMessage.textContent = 'Preparing Excel report for download...';
                reportMessage.className = 'mt-3 text-center text-sm text-blue-600';
                downloadExcelButton.disabled = true;
                downloadExcelButton.textContent = 'Downloading Excel...';

                const academicYear = document.getElementById('report-academic-year').value;
                const filters = academicYear ? { academic_year: parseInt(academicYear) } : {};

                try {
                    await api.downloadSummaryReportExcel(filters);
                    reportMessage.textContent = 'Excel report download started. Check your browser downloads.';
                    reportMessage.className = 'mt-3 text-center text-sm text-green-600';
                } catch (error) {
                    reportMessage.textContent = `Error downloading Excel report: ${error.message}`;
                    reportMessage.className = 'mt-3 text-center text-sm text-red-600';
                } finally {
                    downloadExcelButton.disabled = false;
                    downloadExcelButton.textContent = 'Download Excel';
                }
            });

            // Event listener for the CSV download button
            downloadCsvButton.addEventListener('click', async () => {
                reportMessage.textContent = 'Preparing CSV report for download...';
                reportMessage.className = 'mt-3 text-center text-sm text-blue-600';
                downloadCsvButton.disabled = true;
                downloadCsvButton.textContent = 'Downloading CSV...';

                const academicYear = document.getElementById('report-academic-year').value;
                const filters = academicYear ? { academic_year: parseInt(academicYear) } : {};

                try {
                    await api.downloadSummaryReportCsv(filters);
                    reportMessage.textContent = 'CSV report download started. Check your browser downloads.';
                    reportMessage.className = 'mt-3 text-center text-sm text-green-600';
                } catch (error) {
                    reportMessage.textContent = `Error downloading CSV report: ${error.message}`;
                    reportMessage.className = 'mt-3 text-center text-sm text-red-600';
                } finally {
                    downloadCsvButton.disabled = false;
                    downloadCsvButton.textContent = 'Download CSV';
                }
            });

            // Initial call to populate years
            populateAcademicYears();
        };

        // --- Admin System Management ---
        const renderAdminSystemManagement = async (parentDiv) => {
            parentDiv.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold mb-4 text-gray-800">System Management</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-4 border border-gray-200 rounded-md bg-gray-50">
                            <h4 class="text-lg font-semibold mb-3 text-gray-700">Initialize Database</h4>
                            <p class="text-sm text-gray-500 mb-3">This will reset and re-create the database schemas. All data will be lost.</p>
                            <button id="init-db-button" class="w-full bg-red-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-red-700 disabled:opacity-50">
                                Initialize System
                            </button>
                            <p id="init-db-message" class="mt-3 text-center text-sm"></p>
                        </div>
                        
                        <div class="p-4 border border-gray-200 rounded-md bg-gray-50">
                            <h4 class="text-lg font-semibold mb-3 text-gray-700">Seed Database with Test Data</h4>
                            <p class="text-sm text-gray-500 mb-3">This will populate the database with a large amount of mock student data.</p>
                            <form id="seed-db-form" class="space-y-3">
                                <input type="number" id="num-students-to-seed" value="100" min="1" max="1000" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="cleanup-first" checked class="form-checkbox h-4 w-4 text-blue-600" />
                                    <label for="cleanup-first" class="text-sm text-gray-700">Clear existing data first</label>
                                </div>
                                <button type="submit" id="seed-db-button" class="w-full bg-blue-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-blue-700 disabled:opacity-50">
                                    Seed Database
                                </button>
                            </form>
                            <p id="seed-db-message" class="mt-3 text-center text-sm"></p>
                        </div>
                    </div>
                </div>
            `;
            const initDbButton = document.getElementById('init-db-button');
            const initDbMessage = document.getElementById('init-db-message');
            const seedDbForm = document.getElementById('seed-db-form');
            const seedDbButton = document.getElementById('seed-db-button');
            const seedDbMessage = document.getElementById('seed-db-message');
            initDbButton.addEventListener('click', async () => {
                initDbButton.disabled = true;
                displayMessage('init-db-message', 'Initializing system...', 'info');
                try {
                    const result = await api.initializeSystem();
                    displayMessage('init-db-message', result.message, 'success');
                } catch (err) {
                    displayMessage('init-db-message', err.message, 'error');
                } finally {
                    initDbButton.disabled = false;
                }
            });
            seedDbForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                seedDbButton.disabled = true;
                displayMessage('seed-db-message', 'Seeding database...', 'info');
                const numStudents = document.getElementById('num-students-to-seed').value;
                const cleanupFirst = document.getElementById('cleanup-first').checked;
                try {
                    const result = await api.seedDatabase(numStudents, cleanupFirst);
                    displayMessage('seed-db-message', result.message, 'success');
                } catch (err) {
                    displayMessage('seed-db-message', err.message, 'error');
                } finally {
                    seedDbButton.disabled = false;
                }
            });
        };

        // --- Student Dashboard ---
        const renderStudentDashboard = async () => {
            appDiv.innerHTML = `
                <header class="bg-gray-800 text-white p-4 shadow-md flex justify-between items-center">
                    <h1 class="text-2xl font-bold">Student Dashboard</h1>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm">Welcome, ${currentUser.username}</span>
                        <button id="logout-button" class="px-3 py-1 bg-red-600 rounded-md text-sm font-medium hover:bg-red-700">Logout</button>
                    </div>
                </header>
                <main class="p-4 sm:p-6 lg:p-8">
                    <div id="student-content" class="bg-white p-6 rounded-lg shadow-sm">
                        <p class="text-center text-gray-600 py-6">Loading student data...</p>
                    </div>
                </main>
            `;

            const studentContentDiv = document.getElementById('student-content');
            const logoutButton = document.getElementById('logout-button');
            logoutButton.addEventListener('click', () => setAuthUser(null));

            try {
                const profileResponse = await api.getStudentProfile();
                const gradesResponse = await api.getStudentGrades();
                const gpaResponse = await api.getStudentGPA();

                if (profileResponse.success && gradesResponse.success && gpaResponse.success) {
                    const studentProfile = profileResponse.data;
                    const studentGrades = gradesResponse.data.grades;
                    const studentGpa = gpaResponse.data.gpa;

                    let gradesTableHtml = `
                        <table class="min-w-full divide-y divide-gray-200 mt-4">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Course Code</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Semester</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Year</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Grade</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Credits</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Grade Point</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                    `;
                    if (studentGrades.length === 0) {
                        gradesTableHtml += `<tr><td colspan="6" class="px-4 py-3 text-center text-gray-500">No grades found.</td></tr>`;
                    } else {
                        studentGrades.forEach(grade => {
                            const course = api.courses_db[grade.course_code];
                            gradesTableHtml += `
                                <tr>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${grade.course_code}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${grade.semester_name}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${grade.academic_year}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${grade.letter_grade}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${course ? course.credits : 'N/A'}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${grade.grade_point}</td>
                                </tr>
                            `;
                        });
                    }
                    gradesTableHtml += `</tbody></table>`;

                    studentContentDiv.innerHTML = `
                        <h3 class="text-xl font-bold mb-4 text-gray-800">Your Profile</h3>
                        <div class="bg-gray-50 p-4 rounded-md shadow-sm mb-6">
                            <p class="text-gray-700"><b>Index Number:</b> ${studentProfile.index_number}</p>
                            <p class="text-gray-700"><b>Full Name:</b> ${studentProfile.name}</p>
                            <p class="text-gray-700"><b>Program:</b> ${studentProfile.program}</p>
                            <p class="text-gray-700"><b>Current Year:</b> ${studentProfile.year_of_study}</p>
                            <p class="text-gray-700"><b>Overall GPA:</b> ${studentGpa}</p>
                        </div>
                        <h4 class="text-lg font-semibold mb-3 text-gray-700">Your Grades</h4>
                        <div class="overflow-x-auto rounded-md border border-gray-200">
                            ${gradesTableHtml}
                        </div>
                        
                        <div class="mt-6">
                            <h4 class="text-lg font-semibold mb-3 text-gray-700">Academic Reports</h4>
                            <div class="flex flex-col md:flex-row gap-4">
                                <button id="download-pdf-report-button" class="bg-green-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-green-700 disabled:opacity-50">
                                    Download Academic Report (PDF)
                                </button>
                                <button id="download-txt-report-button" class="bg-blue-600 text-white py-2 px-3 rounded-md font-semibold hover:bg-blue-700 disabled:opacity-50">
                                    Download Academic Report (TXT)
                                </button>
                            </div>
                            <p id="student-report-message" class="mt-3 text-center text-sm"></p>
                        </div>
                    `;
                    
                    // Add event listeners for report download buttons
                    const downloadPdfButton = document.getElementById('download-pdf-report-button');
                    const downloadTxtButton = document.getElementById('download-txt-report-button');
                    const reportMessage = document.getElementById('student-report-message');
                    
                    downloadPdfButton.addEventListener('click', async () => {
                        reportMessage.textContent = 'Preparing PDF for download...';
                        reportMessage.className = 'mt-3 text-center text-sm text-blue-600';
                        downloadPdfButton.disabled = true;
                        downloadTxtButton.disabled = true;
                        
                        try {
                            await api.downloadPersonalReportPdf();
                            reportMessage.textContent = 'PDF download started. Check your browser downloads.';
                            reportMessage.className = 'mt-3 text-center text-sm text-green-600';
                        } catch (error) {
                            reportMessage.textContent = `Error downloading PDF: ${error.message}`;
                            reportMessage.className = 'mt-3 text-center text-sm text-red-600';
                        } finally {
                            downloadPdfButton.disabled = false;
                            downloadTxtButton.disabled = false;
                        }
                    });
                    
                    downloadTxtButton.addEventListener('click', async () => {
                        reportMessage.textContent = 'Preparing text report for download...';
                        reportMessage.className = 'mt-3 text-center text-sm text-blue-600';
                        downloadPdfButton.disabled = true;
                        downloadTxtButton.disabled = true;
                        
                        try {
                            await api.downloadPersonalReportTxt();
                            reportMessage.textContent = 'Text report download started. Check your browser downloads.';
                            reportMessage.className = 'mt-3 text-center text-sm text-green-600';
                        } catch (error) {
                            reportMessage.textContent = `Error downloading text report: ${error.message}`;
                            reportMessage.className = 'mt-3 text-center text-sm text-red-600';
                        } finally {
                            downloadPdfButton.disabled = false;
                            downloadTxtButton.disabled = false;
                        }
                    });
                } else {
                    studentContentDiv.innerHTML = `<p class="text-red-600 text-center py-6">Error loading student data.</p>`;
                }
            } catch (error) {
                studentContentDiv.innerHTML = `<p class="text-red-600 text-center py-6">An error occurred: ${error.message}</p>`;
            }
        };

        // --- Main App Logic ---
        const renderApp = () => {
            console.log('renderApp called'); // Debug log
            
            // Clear any potentially corrupted session data on first load
            const storedUser = sessionStorage.getItem('srmsUser');
            console.log('Stored user:', storedUser); // Debug log
            
            if (storedUser) {
                try {
                    currentUser = JSON.parse(storedUser);
                    console.log('Parsed user:', currentUser); // Debug log
                    
                    if (currentUser && currentUser.role === 'admin') {
                        console.log('Rendering admin dashboard'); // Debug log
                        renderAdminView();
                    } else if (currentUser && currentUser.role === 'student') {
                        console.log('Rendering student dashboard'); // Debug log
                        renderStudentDashboard();
                    } else {
                        console.log('Invalid user role, showing login'); // Debug log
                        clearAuthData();
                        renderLoginPage();
                    }
                } catch (error) {
                    console.log('Error parsing stored user, showing login:', error); // Debug log
                    clearAuthData();
                    renderLoginPage();
                }
            } else {
                console.log('No stored user, showing login'); // Debug log
                renderLoginPage();
            }
        };

        // Helper function to clear all authentication data
        const clearAuthData = () => {
            currentUser = null;
            sessionStorage.removeItem('srmsUser');
            sessionStorage.removeItem('srmsAuth');
            sessionStorage.removeItem('adminActiveTab');
        };

        // Enhanced Button Interactions
        const enhanceButtonInteractions = () => {
            // Add button press animations to all buttons
            document.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    const button = e.target.tagName === 'BUTTON' ? e.target : e.target.closest('button');
                    button.classList.add('button-press');
                    
                    // Remove the class after animation
                    setTimeout(() => {
                        button.classList.remove('button-press');
                    }, 150);
                }
            });
            
            // Add hover lift to interactive cards
            document.addEventListener('mouseover', (e) => {
                if (e.target.classList.contains('student-card') || 
                    e.target.classList.contains('course-card') || 
                    e.target.classList.contains('grade-card')) {
                    e.target.classList.add('hover-lift');
                }
            });
        };

        // Mobile and Touch Enhancements
        const enhanceMobileExperience = () => {
            // Add touch-friendly classes to relevant elements
            const addTouchClasses = () => {
                // Make buttons touch-friendly
                document.querySelectorAll('button').forEach(btn => {
                    btn.classList.add('touch-target');
                });
                
                // Make form inputs touch-friendly
                document.querySelectorAll('input, select, textarea').forEach(input => {
                    input.classList.add('touch-target');
                });
                
                // Add swipe support to navigation tabs
                const navTabs = document.querySelector('.navigation-tabs');
                if (navTabs) {
                    navTabs.classList.add('swipeable');
                }
                
                // Add mobile scroll classes
                document.querySelectorAll('.overflow-auto, .overflow-y-auto').forEach(el => {
                    el.classList.add('mobile-scroll');
                });
            };
            
            // Mobile navigation enhancement
            const enhanceMobileNavigation = () => {
                const nav = document.querySelector('nav ul');
                if (nav) {
                    // Add scroll indicator for overflowing navigation
                    let isScrolling = false;
                    nav.addEventListener('scroll', () => {
                        if (!isScrolling) {
                            isScrolling = true;
                            nav.style.scrollBehavior = 'smooth';
                            setTimeout(() => {
                                isScrolling = false;
                            }, 150);
                        }
                    });
                }
            };
            
            // Responsive grid updates
            const updateResponsiveGrids = () => {
                document.querySelectorAll('.grid').forEach(grid => {
                    // Check if it's a student/course/grade grid
                    if (grid.id === 'students-grid' || 
                        grid.classList.contains('students-grid') ||
                        grid.classList.contains('courses-grid') ||
                        grid.classList.contains('grades-grid')) {
                        grid.classList.add('grid-responsive');
                    }
                });
            };
            
            // Touch gesture support for autocomplete
            const addTouchGestureSupport = () => {
                let touchStartY = 0;
                let touchEndY = 0;
                
                document.addEventListener('touchstart', (e) => {
                    touchStartY = e.changedTouches[0].screenY;
                });
                
                document.addEventListener('touchend', (e) => {
                    touchEndY = e.changedTouches[0].screenY;
                    const autocomplete = document.getElementById('search-autocomplete');
                    
                    // Swipe down to close autocomplete
                    if (autocomplete && !autocomplete.classList.contains('hidden')) {
                        if (touchEndY - touchStartY > 50) {
                            autocomplete.classList.add('hidden');
                        }
                    }
                });
            };
            
            // Viewport height fix for mobile browsers
            const fixMobileViewportHeight = () => {
                const setVH = () => {
                    const vh = window.innerHeight * 0.01;
                    document.documentElement.style.setProperty('--vh', `${vh}px`);
                };
                
                setVH();
                window.addEventListener('resize', setVH);
                window.addEventListener('orientationchange', setVH);
            };
            
            // Initialize all mobile enhancements
            addTouchClasses();
            enhanceMobileNavigation();
            updateResponsiveGrids();
            addTouchGestureSupport();
            fixMobileViewportHeight();
            
            // Re-run when content changes
            const observer = new MutationObserver(() => {
                addTouchClasses();
                updateResponsiveGrids();
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        };

        // Progress Indicator for Loading States
        const createProgressIndicator = (container, progress = 0) => {
            const progressHTML = `
                <div class="progress-indicator mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">Loading...</span>
                        <span class="text-sm text-gray-500">${Math.round(progress)}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('afterbegin', progressHTML);
        };

        // Manual logout function for debugging (can be called from browser console)
        window.forceLogout = () => {
            console.log('Force logout called');
            clearAuthData();
            renderApp();
        };

        // Initialize enhanced interactions
        enhanceButtonInteractions();
        enhanceMobileExperience();
        
        // Initialize Analytics Dashboard
        const initializeAnalytics = () => {
            // Add analytics toggle button
            const searchContainer = document.querySelector('.search-container');
            if (searchContainer && !document.getElementById('analytics-toggle')) {
                const analyticsButton = document.createElement('button');
                analyticsButton.id = 'analytics-toggle';
                analyticsButton.className = 'analytics-toggle';
                analyticsButton.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Analytics
                `;
                analyticsButton.onclick = toggleAnalytics;
                searchContainer.appendChild(analyticsButton);
            }
            
            // Create analytics panel
            if (!document.getElementById('analytics-panel')) {
                const analyticsHTML = `
                    <div id="analytics-panel" class="analytics-panel">
                        <div>
                            <div class="analytics-header">
                                <h2 class="text-2xl font-bold text-gray-800">Student Analytics Dashboard</h2>
                                <button id="close-analytics" class="close-analytics">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            
                            <div class="analytics-content">
                                <div class="analytics-grid">
                                    <!-- Summary Cards -->
                                    <div class="summary-cards">
                                        <div class="summary-card">
                                            <div class="summary-icon bg-blue-100 text-blue-600">
                                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                                </svg>
                                            </div>
                                            <div class="summary-content">
                                                <div class="summary-value" id="total-students">--</div>
                                                <div class="summary-label">Total Students</div>
                                            </div>
                                        </div>
                                        
                                        <div class="summary-card">
                                            <div class="summary-icon bg-green-100 text-green-600">
                                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                            </div>
                                            <div class="summary-content">
                                                <div class="summary-value" id="active-students">--</div>
                                                <div class="summary-label">Active Students</div>
                                            </div>
                                        </div>
                                        
                                        <div class="summary-card">
                                            <div class="summary-icon bg-blue-100 text-blue-600">
                                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>
                                                </svg>
                                            </div>
                                            <div class="summary-content">
                                                <div class="summary-value" id="total-programs">--</div>
                                                <div class="summary-label">Programs</div>
                                            </div>
                                        </div>
                                        
                                        <div class="summary-card">
                                            <div class="summary-icon bg-yellow-100 text-yellow-600">
                                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                                </svg>
                                            </div>
                                            <div class="summary-content">
                                                <div class="summary-value" id="avg-gpa">--</div>
                                                <div class="summary-label">Average GPA</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Charts Section -->
                                    <div class="charts-section">
                                        <div class="chart-container">
                                            <h3 class="chart-title">Students by Program</h3>
                                            <div id="program-chart" class="chart-canvas"></div>
                                        </div>
                                        
                                        <div class="chart-container">
                                            <h3 class="chart-title">GPA Distribution</h3>
                                            <div id="gpa-chart" class="chart-canvas"></div>
                                        </div>
                                        
                                        <div class="chart-container">
                                            <h3 class="chart-title">Enrollment Trends</h3>
                                            <div id="enrollment-chart" class="chart-canvas"></div>
                                        </div>
                                        
                                        <div class="chart-container">
                                            <h3 class="chart-title">Performance Overview</h3>
                                            <div id="performance-chart" class="chart-canvas"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', analyticsHTML);
                
                // Setup analytics event listeners
                document.getElementById('close-analytics').onclick = () => {
                    document.getElementById('analytics-panel').classList.remove('show');
                };
            }
        };
        
        const toggleAnalytics = () => {
            const panel = document.getElementById('analytics-panel');
            if (panel.classList.contains('show')) {
                panel.classList.remove('show');
            } else {
                panel.classList.add('show');
                updateAnalytics();
            }
        };
        
        const updateAnalytics = async () => {
            try {
                // Show loading state
                showAnalyticsLoading();
                
                // Fetch all students data for analytics
                const response = await api.getStudents(1, 1000); // Get all students
                const allStudents = response.students || [];
                
                // Calculate summary statistics
                updateSummaryCards(allStudents);
                
                // Generate charts
                generateProgramChart(allStudents);
                generateGPAChart(allStudents);
                generateEnrollmentChart(allStudents);
                generatePerformanceChart(allStudents);
                
            } catch (error) {
                console.error('Failed to update analytics:', error);
                showAnalyticsError();
            }
        };
        
        const showAnalyticsLoading = () => {
            const charts = document.querySelectorAll('.chart-canvas');
            charts.forEach(chart => {
                chart.innerHTML = '<div class="chart-loading">Loading...</div>';
            });
        };
        
        const showAnalyticsError = () => {
            const charts = document.querySelectorAll('.chart-canvas');
            charts.forEach(chart => {
                chart.innerHTML = '<div class="chart-error">Failed to load data</div>';
            });
        };
        
        const updateSummaryCards = (students) => {
            document.getElementById('total-students').textContent = students.length;
            document.getElementById('active-students').textContent = students.filter(s => s.email).length;
            
            const programs = [...new Set(students.map(s => s.program).filter(Boolean))];
            document.getElementById('total-programs').textContent = programs.length;
            
            const gpas = students.map(s => parseFloat(s.gpa || 0)).filter(gpa => gpa > 0);
            const avgGPA = gpas.length > 0 ? (gpas.reduce((a, b) => a + b, 0) / gpas.length).toFixed(2) : 'N/A';
            document.getElementById('avg-gpa').textContent = avgGPA;
        };
        
        const generateProgramChart = (students) => {
            const programCounts = {};
            students.forEach(student => {
                const program = student.program || 'Unknown';
                programCounts[program] = (programCounts[program] || 0) + 1;
            });
            
            const chartContainer = document.getElementById('program-chart');
            const maxCount = Math.max(...Object.values(programCounts));
            
            chartContainer.innerHTML = Object.entries(programCounts)
                .sort(([,a], [,b]) => b - a)
                .map(([program, count]) => {
                    const percentage = ((count / maxCount) * 100);
                    const shortProgram = program.length > 20 ? program.substring(0, 17) + '...' : program;
                    return `
                        <div class="bar-item">
                            <div class="bar-label" title="${program}">${shortProgram}</div>
                            <div class="bar-container">
                                <div class="bar-fill" style="width: ${percentage}%"></div>
                                <span class="bar-value">${count}</span>
                            </div>
                        </div>
                    `;
                }).join('');
        };
        
        const generateGPAChart = (students) => {
            const gpaRanges = {
                '4.0+': 0,
                '3.5-3.99': 0,
                '3.0-3.49': 0,
                '2.5-2.99': 0,
                '2.0-2.49': 0,
                'Below 2.0': 0
            };
            
            students.forEach(student => {
                const gpa = parseFloat(student.gpa || 0);
                if (gpa >= 4.0) gpaRanges['4.0+']++;
                else if (gpa >= 3.5) gpaRanges['3.5-3.99']++;
                else if (gpa >= 3.0) gpaRanges['3.0-3.49']++;
                else if (gpa >= 2.5) gpaRanges['2.5-2.99']++;
                else if (gpa >= 2.0) gpaRanges['2.0-2.49']++;
                else if (gpa > 0) gpaRanges['Below 2.0']++;
            });
            
            const chartContainer = document.getElementById('gpa-chart');
            const maxCount = Math.max(...Object.values(gpaRanges));
            
            chartContainer.innerHTML = Object.entries(gpaRanges)
                .map(([range, count]) => {
                    const percentage = maxCount > 0 ? ((count / maxCount) * 100) : 0;
                    return `
                        <div class="bar-item">
                            <div class="bar-label">${range}</div>
                            <div class="bar-container">
                                <div class="bar-fill gpa-bar" style="width: ${percentage}%"></div>
                                <span class="bar-value">${count}</span>
                            </div>
                        </div>
                    `;
                }).join('');
        };
        
        const generateEnrollmentChart = (students) => {
            // Simulate enrollment data over months
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const enrollmentData = months.map(() => Math.floor(Math.random() * 20) + 5);
            const maxEnrollment = Math.max(...enrollmentData);
            
            const chartContainer = document.getElementById('enrollment-chart');
            chartContainer.innerHTML = `
                <div class="line-chart">
                    ${enrollmentData.map((value, index) => {
                        const height = (value / maxEnrollment) * 100;
                        return `
                            <div class="line-point" style="height: ${height}%">
                                <div class="point-value">${value}</div>
                                <div class="point-label">${months[index]}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        };
        
        const generatePerformanceChart = (students) => {
            const performanceData = [
                { label: 'Excellent (A)', count: students.filter(s => parseFloat(s.gpa || 0) >= 3.7).length, color: '#10B981' },
                { label: 'Good (B)', count: students.filter(s => { const gpa = parseFloat(s.gpa || 0); return gpa >= 3.0 && gpa < 3.7; }).length, color: '#3B82F6' },
                { label: 'Average (C)', count: students.filter(s => { const gpa = parseFloat(s.gpa || 0); return gpa >= 2.0 && gpa < 3.0; }).length, color: '#F59E0B' },
                { label: 'Below Average', count: students.filter(s => { const gpa = parseFloat(s.gpa || 0); return gpa > 0 && gpa < 2.0; }).length, color: '#EF4444' }
            ];
            
            const total = performanceData.reduce((sum, item) => sum + item.count, 0);
            const chartContainer = document.getElementById('performance-chart');
            
            chartContainer.innerHTML = `
                <div class="pie-chart">
                    ${performanceData.map(item => {
                        const percentage = total > 0 ? ((item.count / total) * 100).toFixed(1) : 0;
                        return `
                            <div class="pie-segment">
                                <div class="pie-color" style="background-color: ${item.color}"></div>
                                <div class="pie-label">${item.label}</div>
                                <div class="pie-value">${item.count} (${percentage}%)</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        };
        
        // Initialize analytics when students are loaded
        window.addEventListener('studentsLoaded', () => {
            initializeAnalytics();
        });

        window.addEventListener('DOMContentLoaded', renderApp);

                // =============================
                // Notification Center (UI + Pagination)
                // =============================
                (function(){
                        // Inject bell + dropdown + composer modal near top of body once DOM ready (defer until DOMContentLoaded)
                        function injectNotificationShell(){
                                if(document.getElementById('srms-notification-bell')) return; // already added
                                const shell = document.createElement('div');
                                shell.innerHTML = `
<div id="notification-root" class="fixed top-3 right-4 z-40 flex items-center gap-2">
    <button id="open-notification-composer" class="hidden px-2 py-1 text-xs font-medium bg-blue-600 text-white rounded hover:bg-blue-700" title="Create notification">New</button>
    <button id="srms-notification-bell" class="relative p-2 rounded-full bg-white shadow border border-gray-200 hover:bg-gray-50" aria-haspopup="true" aria-expanded="false" title="Notifications">
        <span class="sr-only">Notifications</span>
        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
        <span id="notification-unread-badge" class="hidden absolute -top-1 -right-1 bg-red-600 text-white text-[10px] leading-none px-1.5 py-0.5 rounded-full font-semibold"></span>
    </button>
    <div id="notification-dropdown" class="hidden absolute mt-2 right-0 w-96 max-h-[480px] flex flex-col bg-white border border-gray-200 rounded-lg shadow-xl overflow-hidden">
        <div class="flex items-center justify-between px-3 py-2 border-b bg-gray-50">
            <h4 class="text-sm font-semibold text-gray-700">Notifications</h4>
            <div class="flex items-center gap-2">
                <button id="mark-all-notifications" class="text-xs text-blue-600 hover:underline">Mark all read</button>
                <button id="close-notifications" class="text-gray-500 hover:text-gray-700" title="Close">âœ•</button>
            </div>
        </div>
        <div id="notification-list" class="flex-1 overflow-y-auto divide-y divide-gray-100 bg-white">
            <div class="p-3 text-xs text-gray-400" id="notifications-empty">Loading...</div>
        </div>
        <div class="p-2 border-t bg-gray-50 flex items-center justify-between">
            <button id="load-more-notifications" class="hidden text-xs px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">Load more</button>
            <span id="notifications-status" class="text-[11px] text-gray-500"></span>
        </div>
    </div>
</div>

<!-- Notification Composer Modal -->
<div id="notification-composer-overlay" class="hidden fixed inset-0 bg-black/40 z-50 items-center justify-center">
    <div class="bg-white w-full max-w-lg rounded-lg shadow-lg border border-gray-200 overflow-hidden" role="dialog" aria-modal="true" aria-labelledby="notification-composer-title">
        <div class="px-4 py-3 border-b flex items-center justify-between bg-gray-50">
            <h3 id="notification-composer-title" class="font-semibold text-gray-800">Create Notification</h3>
            <button id="close-notification-composer" class="p-2 hover:bg-gray-200 rounded" aria-label="Close">âœ•</button>
        </div>
        <form id="notification-composer-form" class="p-4 space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Type</label>
                    <input name="type" required placeholder="system" class="w-full border rounded px-2 py-1 text-sm" />
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Severity</label>
                    <select name="severity" class="w-full border rounded px-2 py-1 text-sm">
                        <option value="info">info</option>
                        <option value="success">success</option>
                        <option value="warning">warning</option>
                        <option value="error">error</option>
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Title</label>
                <input name="title" required maxlength="120" class="w-full border rounded px-2 py-1 text-sm" />
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Message</label>
                <textarea name="message" required rows="3" maxlength="500" class="w-full border rounded px-2 py-1 text-sm resize-y"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Audience</label>
                    <select name="audience" class="w-full border rounded px-2 py-1 text-sm">
                        <option value="all">all</option>
                        <option value="admins">admins</option>
                        <option value="students">students</option>
                        <option value="user">specific user</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Target User ID (optional)</label>
                    <input name="target_user_id" type="number" min="1" class="w-full border rounded px-2 py-1 text-sm" />
                </div>
            </div>
            <div class="flex items-center justify-end gap-2 pt-2 border-t">
                <button type="button" id="cancel-notification-composer" class="px-3 py-1.5 text-sm bg-gray-100 hover:bg-gray-200 rounded">Cancel</button>
                <button type="submit" id="submit-notification-composer" class="px-4 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50">Create</button>
            </div>
            <p id="notification-composer-feedback" class="text-xs mt-2 text-gray-500"></p>
        </form>
    </div>
</div>`;
                                document.body.appendChild(shell);
                        }

                        const state = {
                                items: [],
                                loading: false,
                                hasMore: true,
                                pageSize: 20,
                                lastMinId: null,
                                unread: 0
                        };

                        function fmtDate(d){
                                if(!d) return '';
                                const dt = new Date(d);
                                if(isNaN(dt)) return d;
                                return dt.toLocaleString();
                        }
                        function severityColor(sev){
                                switch(sev){
                                        case 'success': return 'bg-green-100 text-green-700 border-green-300';
                                        case 'warning': return 'bg-yellow-100 text-yellow-700 border-yellow-300';
                                        case 'error': return 'bg-red-100 text-red-700 border-red-300';
                                        default: return 'bg-blue-100 text-blue-700 border-blue-300';
                                }
                        }
                        function renderList(){
                                const listEl = document.getElementById('notification-list');
                                const emptyEl = document.getElementById('notifications-empty');
                                if(!listEl) return;
                                listEl.innerHTML = '';
                                if(state.items.length === 0){
                                        emptyEl.classList.remove('hidden');
                                        emptyEl.textContent = 'No notifications';
                                } else {
                                        emptyEl.classList.add('hidden');
                                }
                                state.items.forEach(n => {
                                        const div = document.createElement('div');
                                        div.className = `p-3 text-sm flex gap-3 hover:bg-gray-50 ${!n.read_at ? 'bg-white' : 'bg-gray-50'}`;
                                        div.innerHTML = `
 <div class="flex-1">
     <div class="flex items-start justify-between gap-2">
         <div class="font-medium text-gray-800 flex items-center gap-2">
             <span class="inline-block px-1.5 py-0.5 text-[10px] border rounded ${severityColor(n.severity)}">${n.severity || 'info'}</span>
             <span>${n.title || '(No title)'}</span>
             ${!n.read_at ? '<span class="w-2 h-2 rounded-full bg-blue-600 animate-pulse" title="Unread"></span>' : ''}
         </div>
         <button data-id="${n.user_notification_id || n.id}" class="text-xs text-blue-600 hover:underline mark-one-btn" ${n.read_at ? 'disabled' : ''}>Mark read</button>
     </div>
     <div class="mt-1 text-gray-700 leading-snug whitespace-pre-wrap">${(n.message||'').slice(0,1000)}</div>
     <div class="mt-1 text-[11px] text-gray-500 flex items-center gap-2">
         <span>${fmtDate(n.created_at)}</span>
         ${n.read_at ? `<span class="text-green-600">Read</span>` : ''}
     </div>
 </div>`;
                                        listEl.appendChild(div);
                                });
                                const loadMoreBtn = document.getElementById('load-more-notifications');
                                if(loadMoreBtn){
                                        loadMoreBtn.classList.toggle('hidden', !state.hasMore);
                                        loadMoreBtn.disabled = state.loading;
                                }
                                document.getElementById('notifications-status').textContent = state.loading ? 'Loading...' : (state.hasMore ? '' : 'End of list');
                        }

                        async function fetchUnread(){
                                try {
                                        const data = await api.fetchUnreadCount();
                                        state.unread = data.unread || 0;
                                } catch(e){ console.warn('Unread fetch failed', e); }
                                updateBadge();
                        }
                        function updateBadge(){
                                const badge = document.getElementById('notification-unread-badge');
                                if(!badge) return;
                                if(state.unread > 0){
                                        badge.textContent = state.unread > 99 ? '99+' : state.unread;
                                        badge.classList.remove('hidden');
                                } else {
                                        badge.classList.add('hidden');
                                }
                        }

                        async function loadBatch(initial=false){
                                if(state.loading) return;
                                state.loading = true; renderList();
                                try {
                                        const batch = await api.fetchNotifications({ limit: state.pageSize, beforeId: initial ? null : state.lastMinId });
                                        if(initial){
                                                state.items = batch;
                                        } else {
                                                state.items = state.items.concat(batch);
                                        }
                                        if(batch.length === state.pageSize){
                                                // more might exist
                                                const ids = batch.map(b=> b.user_notification_id || b.id);
                                                const minId = Math.min(...ids);
                                                state.lastMinId = state.lastMinId == null ? minId : Math.min(state.lastMinId, minId);
                                                state.hasMore = true;
                                        } else {
                                                state.hasMore = false;
                                        }
                                } catch(e){
                                        console.error('Failed to load notifications', e);
                                } finally {
                                        state.loading = false; renderList();
                                }
                        }

                        async function markAll(){
                                try { await api.markAllNotificationsRead(); state.items = state.items.map(n => ({...n, read_at: n.read_at || new Date().toISOString()})); state.unread = 0; updateBadge(); renderList(); } catch(e){ console.error(e);} }

                        function wireEvents(){
                                const bell = document.getElementById('srms-notification-bell');
                                const dropdown = document.getElementById('notification-dropdown');
                                bell.addEventListener('click', async ()=>{
                                        const open = !dropdown.classList.contains('hidden');
                                        document.querySelectorAll('#notification-dropdown').forEach(el=> el.classList.add('hidden'));
                                        if(open){ return; }
                                        dropdown.classList.remove('hidden');
                                        if(state.items.length === 0) await loadBatch(true);
                                });
                                document.getElementById('close-notifications').addEventListener('click', ()=> dropdown.classList.add('hidden'));
                                document.getElementById('mark-all-notifications').addEventListener('click', markAll);
                                document.getElementById('load-more-notifications').addEventListener('click', ()=> loadBatch(false));
                                document.addEventListener('click', (e)=>{
                                        if(!dropdown.contains(e.target) && !bell.contains(e.target)) dropdown.classList.add('hidden');
                                });
                                document.getElementById('notification-list').addEventListener('click', async (e)=>{
                                        const btn = e.target.closest('.mark-one-btn');
                                        if(!btn) return;
                                        const id = btn.getAttribute('data-id');
                                        try {
                                                await api.markNotificationRead(id);
                                                const idx = state.items.findIndex(n => (n.user_notification_id||n.id) == id);
                                                if(idx>=0 && !state.items[idx].read_at){ state.items[idx].read_at = new Date().toISOString(); state.unread = Math.max(0, state.unread -1); updateBadge(); renderList(); }
                                        } catch(err){ console.error(err); }
                                });
                        }

                        // Composer wiring
                        function initComposer(){
                                const openBtn = document.getElementById('open-notification-composer');
                                const overlay = document.getElementById('notification-composer-overlay');
                                const cancelBtn = document.getElementById('cancel-notification-composer');
                                const closeBtn = document.getElementById('close-notification-composer');
                                const form = document.getElementById('notification-composer-form');
                                const feedback = document.getElementById('notification-composer-feedback');
                                function show(){ overlay.classList.remove('hidden'); overlay.classList.add('flex'); feedback.textContent=''; }
                                function hide(){ overlay.classList.add('hidden'); overlay.classList.remove('flex'); }
                                if(openBtn){ openBtn.addEventListener('click', show); }
                                [cancelBtn, closeBtn].forEach(b=> b && b.addEventListener('click', hide));
                                overlay.addEventListener('click', (e)=>{ if(e.target === overlay) hide(); });
                                form.addEventListener('submit', async (e)=>{
                                        e.preventDefault();
                                        feedback.textContent='Creating...';
                                        const submitBtn = document.getElementById('submit-notification-composer');
                                        submitBtn.disabled = true;
                                        const fd = new FormData(form);
                                        const payload = {
                                                type: fd.get('type')||'system',
                                                title: fd.get('title')||'',
                                                message: fd.get('message')||'',
                                                severity: fd.get('severity')||'info',
                                                audience: fd.get('audience')||'all'
                                        };
                                        if(payload.audience==='user' && fd.get('target_user_id')) payload.target_user_id = Number(fd.get('target_user_id'));
                                        try {
                                                const resp = await api.createAdminNotification(payload);
                                                // For optimistic display we need the full notification; backend returns id only, so we refetch first page
                                                feedback.textContent='Created';
                                                await loadBatch(true);
                                                await fetchUnread();
                                                setTimeout(()=> hide(), 400);
                                        } catch(err){
                                                feedback.textContent = 'Error: ' + (err.message||'failed');
                                                feedback.className = 'text-xs mt-2 text-red-600';
                                        } finally { submitBtn.disabled = false; }
                                });
                        }

                        function detectAdmin(){
                                const authHeader = localStorage.getItem('authHeader');
                                if(!authHeader) return;
                                try {
                                        const decoded = atob(authHeader.replace('Basic ', ''));
                                        const username = decoded.split(':')[0];
                                        if(username && username.toLowerCase().startsWith('admin')){
                                                const btn = document.getElementById('open-notification-composer');
                                                if(btn) btn.classList.remove('hidden');
                                        }
                                } catch(_e){ }
                        }

                        let evtSource = null;

                        function initSSE(){
                            if(evtSource){ evtSource.close(); evtSource = null; }
                            try {
                                evtSource = new EventSource('/notifications/stream');
                                evtSource.addEventListener('message', (e)=>{ /* generic */ });
                                evtSource.addEventListener('error', (e)=>{
                                    console.warn('SSE error, will retry in 10s', e);
                                    if(evtSource){ evtSource.close(); }
                                    setTimeout(initSSE, 10000);
                                });
                                evtSource.addEventListener('open', ()=> console.log('[SSE] connected'));
                                evtSource.onmessage = (e)=>{
                                    // Each event data: {event, data, ts}
                                    try {
                                        const parsed = JSON.parse(e.data);
                                        const ev = parsed.event; const payload = parsed.data;
                                        if(ev === 'notification.new'){
                                            // Increase unread count & optionally refetch first page if dropdown open
                                            state.unread += 1; updateBadge();
                                            const dropdown = document.getElementById('notification-dropdown');
                                            if(dropdown && !dropdown.classList.contains('hidden')){
                                                // refresh first page for freshness
                                                loadBatch(true);
                                            }
                                        } else if(ev === 'notification.read'){
                                            const id = payload.user_notification_id;
                                            // optional client-side sync (will rely on polling otherwise)
                                        } else if(ev === 'notification.read_all'){
                                            // If user matches current placeholder assumption we can set unread to 0
                                            state.unread = 0; updateBadge();
                                        }
                                    } catch(err){ console.warn('SSE parse failed', err); }
                                };
                            } catch(err){
                                console.warn('Failed to init SSE', err);
                            }
                        }

                        async function init(){
                                injectNotificationShell();
                                wireEvents();
                                initComposer();
                                detectAdmin();
                                await fetchUnread();
                                // Poll unread count every 60s
                                setInterval(fetchUnread, 60000);
                            // Start SSE (best effort)
                            initSSE();
                        }
                        window.addEventListener('DOMContentLoaded', init);
                })();

    </script>
    <!-- Bridge global loading functions to module helpers.js to avoid duplicates -->
    <script type="module">
        import { showLoading as _s, hideLoading as _h } from './js/utils/helpers.js';
        window.showLoading = _s;
        window.hideLoading = _h;
    </script>
    <!-- New modular component scripts (ESM) -->
    <script type="module" src="js/components/notifications.js"></script>
    <script type="module" src="js/components/assessments.js"></script>
</body>
</html>